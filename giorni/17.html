<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ² Giorno 17 â€“ Il Bosco dei Triangoli ğŸ”º</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Ubuntu',sans-serif;
  background:linear-gradient(#eef7ee,#dcedc8);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
#game{
  background:#fff;
  width:95%;
  max-width:420px;
  border-radius:22px;
  padding:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  text-align:center;
}
h1{font-size:20px;margin:0 0 10px;}
#top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:15px;
}
#turn{
  margin:8px 0;
  font-weight:700;
}
#dice{
  font-size:26px;
}
canvas{
  margin:14px auto;
  display:block;
  background:#f3f9e9;
  border-radius:18px;
  touch-action:none;
}
button{
  background:#2e7d32;
  color:#fff;
  border:none;
  padding:12px 22px;
  font-size:15px;
  border-radius:14px;
  cursor:pointer;
}
#info{
  font-size:14px;
  line-height:1.5;
}
</style>
</head>

<body>

<div id="game">
  <h1>ğŸŒ² Giorno 17 â€“ Il Bosco dei Triangoli ğŸ”º</h1>

  <div id="top">
    <div>ğŸ‘¤ ğŸ”º <b id="pScore">0</b></div>
    <div id="dice">ğŸ²</div>
    <div>ğŸ–¥ï¸ ğŸ”º <b id="pcScore">0</b></div>
  </div>

  <div id="turn">Premi Start</div>

  <button onclick="startGame()">ğŸ² Start</button>

  <canvas id="canvas" width="330" height="330"></canvas>

  <div id="info">
    ğŸ¯ <b>Obiettivo</b><br>
    Il dado decide quante linee puoi tracciare.<br>
    ğŸ”º Triangolo chiuso = +1 punto<br>
    âŒ Nessuna linea puÃ² essere ripetuta
  </div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const trees=[
 {x:55,y:55},{x:165,y:55},{x:275,y:55},
 {x:55,y:165},{x:165,y:165},{x:275,y:165},
 {x:55,y:275},{x:165,y:275},{x:275,y:275}
];

let edges=new Set();
let triangles=new Set();
let playerScore=0, pcScore=0;
let turn=null;
let selected=null;
let movesLeft=0;

draw();

/* START */
function startGame(){
  edges.clear();
  triangles.clear();
  playerScore=pcScore=0;
  selected=null;
  turn="player";
  rollDice();
  updateUI();
  draw();
}

/* ğŸ² DADO */
function rollDice(){
  movesLeft=Math.floor(Math.random()*6)+1;
  document.getElementById("dice").textContent="ğŸ² "+movesLeft;
}

/* PLAYER */
canvas.addEventListener("pointerdown",e=>{
  if(turn!=="player"||movesLeft===0) return;

  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;

  trees.forEach((t,i)=>{
    if(Math.hypot(t.x-x,t.y-y)<22){
      if(selected===null){
        selected=i;
        draw();
      }else{
        if(addEdge(selected,i)){
          checkTriangles("player");
          movesLeft--;
        }
        selected=null;
        draw();
        if(movesLeft===0){
          turn="pc";
          updateUI();
          setTimeout(pcTurn,700);
        }
      }
    }
  });
});

/* PC */
function pcTurn(){
  rollDice();
  let free=getFreeEdges();

  while(movesLeft>0 && free.length){
    const tri=findTriangleMove();
    if(tri){
      tri.forEach(e=>{
        if(movesLeft>0 && addEdge(e[0],e[1])){
          checkTriangles("pc");
          movesLeft--;
        }
      });
    }else{
      const e=free[Math.floor(Math.random()*free.length)];
      addEdge(e[0],e[1]);
      checkTriangles("pc");
      movesLeft--;
    }
    free=getFreeEdges();
  }

  turn="player";
  rollDice();
  updateUI();
  draw();
}

/* TRIANGOLI */
function findTriangleMove(){
  for(let i=0;i<9;i++){
    for(let j=i+1;j<9;j++){
      for(let k=j+1;k<9;k++){
        const need=[];
        if(!has(i,j)) need.push([i,j]);
        if(!has(j,k)) need.push([j,k]);
        if(!has(i,k)) need.push([i,k]);
        if(need.length>0 && need.length<=movesLeft) return need;
      }
    }
  }
  return null;
}

/* UTILS */
function getFreeEdges(){
  const list=[];
  for(let i=0;i<9;i++){
    for(let j=i+1;j<9;j++){
      if(!edges.has([i,j].join("-"))) list.push([i,j]);
    }
  }
  return list;
}
function addEdge(a,b){
  if(a===b) return false;
  const k=[a,b].sort().join("-");
  if(edges.has(k)) return false;
  edges.add(k);
  return true;
}
function has(a,b){
  return edges.has([a,b].sort().join("-"));
}
function checkTriangles(who){
  for(let i=0;i<9;i++){
    for(let j=i+1;j<9;j++){
      for(let k=j+1;k<9;k++){
        if(has(i,j)&&has(j,k)&&has(i,k)){
          const t=[i,j,k].join("-");
          if(!triangles.has(t)){
            triangles.add(t);
            who==="player"?playerScore++:pcScore++;
          }
        }
      }
    }
  }
  updateUI();
}

/* UI */
function updateUI(){
  document.getElementById("pScore").textContent=playerScore;
  document.getElementById("pcScore").textContent=pcScore;
  document.getElementById("turn").textContent=
    turn==="player"?"ğŸ‘¤ Tocca a te":"ğŸ–¥ï¸ Turno PC";
}

/* DRAW */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  edges.forEach(e=>{
    const[a,b]=e.split("-").map(Number);
    ctx.strokeStyle="#1b5e20";
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(trees[a].x,trees[a].y);
    ctx.lineTo(trees[b].x,trees[b].y);
    ctx.stroke();
  });

  if(selected!==null){
    ctx.strokeStyle="#2e7d32";
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.arc(trees[selected].x,trees[selected].y,22,0,Math.PI*2);
    ctx.stroke();
  }

  ctx.font="30px serif";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  trees.forEach(t=>ctx.fillText("ğŸŒ²",t.x,t.y));
}
</script>

</body>
</html>
