<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸŒ² Giorno 17 â€“ Il Bosco dei Triangoli ğŸ”º</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Ubuntu',sans-serif;
  background:linear-gradient(#eef7ee,#dcedc8);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
#game{
  background:#fff;
  width:95%;
  max-width:420px;
  border-radius:22px;
  padding:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  text-align:center;
  position:relative;
}
h1{font-size:20px;margin:0 0 8px;}
#top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:15px;
}
#turn{margin:8px 0;font-weight:700;}
#dice{font-size:24px;}

canvas{
  margin:14px auto;
  display:block;
  background:#f3f9e9;
  border-radius:18px;
  touch-action:none;
}

/* MODALS */
.modal{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.45);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:10;
}
.modalContent{
  background:#fff;
  padding:20px;
  border-radius:18px;
  width:90%;
  max-width:330px;
  text-align:center;
}
.modalContent button{
  background:#2e7d32;
  color:#fff;
  border:none;
  padding:12px 22px;
  font-size:15px;
  border-radius:14px;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="game">
  <h1>ğŸŒ² Giorno 17 â€“ Il Bosco dei Triangoli ğŸ”º</h1>

  <div id="top">
    <div>ğŸ‘¤ ğŸ”º <b id="pScore">0</b></div>
    <div id="dice">ğŸ²</div>
    <div>ğŸ–¥ï¸ ğŸ”º <b id="pcScore">0</b></div>
  </div>

  <div id="turn">â€“</div>

  <canvas id="canvas" width="330" height="330"></canvas>

  <!-- START MODAL -->
  <div class="modal" id="startModal">
    <div class="modalContent">
      <h2>ğŸ¯ Come si gioca</h2>
      <p>
        ğŸŒ² Collega gli alberi con delle linee<br>
        ğŸ² Il dado decide quante linee puoi tracciare<br>
        ğŸ”º Triangolo chiuso = +1 punto<br>
        âŒ Una linea non puÃ² saltare un albero<br>
        âŒ Nessuna linea puÃ² essere ripetuta
      </p>
      <button onclick="startGame()">ğŸ² Inizia partita</button>
    </div>
  </div>

  <!-- END MODAL -->
  <div class="modal" id="endModal" style="display:none;">
    <div class="modalContent">
      <h2 id="resultTitle">ğŸ Fine partita</h2>

      <p>
        ğŸ”º <b>Spiegazione matematica</b><br><br>
        Con 9 punti, in teoria si possono formare
        \( \binom{9}{3} = 84 \) triangoli.<br><br>
        ğŸŒ² In questo bosco perÃ² alcune linee sono vietate
        (non si puÃ² saltare un albero).<br>
        Per questo il massimo reale Ã¨ <b>36 triangoli</b>.
      </p>

      <p>
        ğŸ‘¤ <b id="fp">0</b> triangoli<br>
        ğŸ–¥ï¸ <b id="fc">0</b> triangoli
      </p>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const trees=[
 {x:55,y:55},{x:165,y:55},{x:275,y:55},
 {x:55,y:165},{x:165,y:165},{x:275,y:165},
 {x:55,y:275},{x:165,y:275},{x:275,y:275}
];

let edges=new Set();
let triangles=new Set();
let playerScore=0, pcScore=0;
let turn=null;
let selected=null;
let movesLeft=0;

draw();

/* START */
function startGame(){
  document.getElementById("startModal").style.display="none";
  turn="player";
  rollDice();
  updateUI();
}

/* DADO */
function rollDice(){
  movesLeft=Math.floor(Math.random()*6)+1;
  document.getElementById("dice").textContent="ğŸ² "+movesLeft;
}

/* PLAYER */
canvas.addEventListener("pointerdown",e=>{
  if(turn!=="player"||movesLeft===0) return;

  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;

  trees.forEach((t,i)=>{
    if(Math.hypot(t.x-x,t.y-y)<22){
      if(selected===null){
        selected=i;
        draw();
      }else{
        if(addEdge(selected,i)){
          checkTriangles("player");
          movesLeft--;
        }
        selected=null;
        draw();
        if(movesLeft===0){
          if(isGameOver()) return endGame();
          turn="pc";
          updateUI();
          setTimeout(pcTurn,700);
        }
      }
    }
  });
});

/* PC */
function pcTurn(){
  rollDice();
  let free=getFreeEdges();

  while(movesLeft>0 && free.length){
    const tri=findTriangleMove();
    if(tri){
      tri.forEach(e=>{
        if(movesLeft>0 && addEdge(e[0],e[1])){
          checkTriangles("pc");
          movesLeft--;
        }
      });
    }else{
      const e=free[Math.floor(Math.random()*free.length)];
      addEdge(e[0],e[1]);
      checkTriangles("pc");
      movesLeft--;
    }
    free=getFreeEdges();
  }

  if(isGameOver()) return endGame();
  turn="player";
  rollDice();
  updateUI();
  draw();
}

/* BLOCCO LINEE */
function isBlocked(a,b){
  const A=trees[a], B=trees[b];
  for(let c=0;c<trees.length;c++){
    if(c===a||c===b) continue;
    const C=trees[c];
    const cross=(B.x-A.x)*(C.y-A.y)-(B.y-A.y)*(C.x-A.x);
    if(Math.abs(cross)>0.01) continue;
    const dot=(C.x-A.x)*(C.x-B.x)+(C.y-A.y)*(C.y-B.y);
    if(dot<0) return true;
  }
  return false;
}

/* LOGIC */
function getFreeEdges(){
  const list=[];
  for(let i=0;i<9;i++){
    for(let j=i+1;j<9;j++){
      const k=[i,j].sort().join("-");
      if(!edges.has(k)&&!isBlocked(i,j)) list.push([i,j]);
    }
  }
  return list;
}
function findTriangleMove(){
  for(let i=0;i<9;i++){
    for(let j=i+1;j<9;j++){
      for(let k=j+1;k<9;k++){
        const need=[];
        if(!has(i,j)&&!isBlocked(i,j)) need.push([i,j]);
        if(!has(j,k)&&!isBlocked(j,k)) need.push([j,k]);
        if(!has(i,k)&&!isBlocked(i,k)) need.push([i,k]);
        if(need.length>0 && need.length<=movesLeft) return need;
      }
    }
  }
  return null;
}
function addEdge(a,b){
  if(a===b||isBlocked(a,b)) return false;
  const k=[a,b].sort().join("-");
  if(edges.has(k)) return false;
  edges.add(k);
  return true;
}
function has(a,b){
  return edges.has([a,b].sort().join("-"));
}
function checkTriangles(who){
  for(let i=0;i<9;i++){
    for(let j=i+1;j<9;j++){
      for(let k=j+1;k<9;k++){
        if(has(i,j)&&has(j,k)&&has(i,k)){
          const t=[i,j,k].join("-");
          if(!triangles.has(t)){
            triangles.add(t);
            who==="player"?playerScore++:pcScore++;
          }
        }
      }
    }
  }
  updateUI();
}

/* GAME OVER */
function isGameOver(){
  return getFreeEdges().length===0;
}
function endGame(){
  document.getElementById("fp").textContent=playerScore;
  document.getElementById("fc").textContent=pcScore;

  const title=document.getElementById("resultTitle");
  if(playerScore>pcScore) title.textContent="ğŸ† Hai vinto!";
  else if(playerScore<pcScore) title.textContent="ğŸ˜… Vince il PC";
  else title.textContent="ğŸ¤ Pareggio";

  document.getElementById("endModal").style.display="flex";
}

/* UI */
function updateUI(){
  document.getElementById("pScore").textContent=playerScore;
  document.getElementById("pcScore").textContent=pcScore;
  document.getElementById("turn").textContent=
    turn==="player"?"ğŸ‘¤ Tocca a te":"ğŸ–¥ï¸ Turno PC";
}

/* DRAW */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  edges.forEach(e=>{
    const[a,b]=e.split("-").map(Number);
    ctx.strokeStyle="#1b5e20";
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(trees[a].x,trees[a].y);
    ctx.lineTo(trees[b].x,trees[b].y);
    ctx.stroke();
  });

  if(selected!==null){
    ctx.strokeStyle="#2e7d32";
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.arc(trees[selected].x,trees[selected].y,22,0,Math.PI*2);
    ctx.stroke();
  }

  ctx.font="30px serif";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  trees.forEach(t=>ctx.fillText("ğŸŒ²",t.x,t.y));
}
</script>

</body>
</html>
