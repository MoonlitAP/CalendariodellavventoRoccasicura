<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>ğŸ¹ Giorno 12 â€“ Piano Tiles Evolution</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
Â  margin: 0;
Â  padding: 0;
Â  font-family: "Ubuntu", sans-serif;
Â  color: #fff;
Â  text-align: center;
Â  background: #000 url("img/piano_roccasicura.jpg") center/cover no-repeat fixed;
}

h1 {
Â  margin-top: 10px;
Â  color: #ffd700;
Â  text-shadow: 2px 2px 5px #000;
}

canvas {
Â  display: none;
Â  margin: 20px auto;
Â  background: rgba(0,0,0,0.45);
Â  border: 3px solid #ffd700;
Â  border-radius: 15px;
}

#info {
Â  display: none;
Â  position: fixed;
Â  bottom: 0;
Â  left: 0;
Â  width: 100%;
Â  background: rgba(0,0,0,0.6);
Â  padding: 10px;
Â  font-size: 1.2em;
Â  border-top: 1px solid #ffd700;
}

/* PANEL */
#panel, #unlock, #countdown, #fine {
Â  position: fixed;
Â  top: 50%;
Â  left: 50%;
Â  transform: translate(-50%, -50%);
}

#panel, #unlock {
Â  width: 85%;
Â  max-width: 420px;
Â  background: #fffaf2;
Â  color: #400000;
Â  border: 2px solid #ffd700;
Â  border-radius: 20px;
Â  padding: 25px;
Â  box-shadow: 0 0 25px #000;
}

.btn {
Â  width: 80%;
Â  margin-top: 12px;
Â  padding: 14px;
Â  font-size: 1.1em;
Â  background: #7b0412;
Â  color: #fff;
Â  border: none;
Â  border-radius: 30px;
Â  cursor: pointer;
}
.btn:hover { background: #ffd700; color: #000; }

#unlock, #countdown, #fine {
Â  display: none;
}

#countdown {
Â  font-size: 120px;
Â  color: #ffd700;
Â  text-shadow: 0 0 25px #fff;
Â  animation: pulse .8s;
}

@keyframes pulse {
Â  0% { transform: translate(-50%,-50%) scale(.3); opacity: 0; }
Â  40% { transform: translate(-50%,-50%) scale(1.3); opacity: 1; }
Â  100% { transform: translate(-50%,-50%) scale(1); opacity: 0; }
}

/* FINE */
#fine {
Â  width: 90%;
Â  max-width: 500px;
Â  background: #fffaf2;
Â  color: #400000;
Â  border-radius: 20px;
Â  padding: 30px;
}

table {
Â  width: 100%;
Â  margin-top: 15px;
}

th, td {
Â  padding: 10px;
Â  border-bottom: 1px solid #d7bb5f;
}
</style>
</head>

<body>

<h1>ğŸ¹ Giorno 12 â€“ Piano Tiles Evolution</h1>

<div id="panel">
Â  <p>ğŸ¼ Tocca le piastrelle dâ€™oro a ritmo<br>
Â  Â  Â â¤ï¸ 3 vite â€“ perdi una se una tile cade<br>
Â  Â  Â âš¡ DifficoltÃ  crescente automatica</p>
Â  <button id="startBtn" class="btn">â–¶ï¸ Inizia</button>
</div>

<div id="unlock">
Â  <h2>ğŸµ Attiva la musica</h2>
Â  <button id="unlockBtn" class="btn">TOCCA PER ATTIVARE</button>
</div>

<div id="countdown"></div>

<canvas id="game" width="360" height="600"></canvas>
<div id="info"></div>

<div id="fine">
Â  <h2 id="fineMsg"></h2>
Â  <h3>ğŸ† Top 10</h3>
Â  <table id="scoreTable">
Â  Â  <tr><th>Nome</th><th>Punti</th></tr>
Â  </table>
Â  <button class="btn" onclick="location.reload()">Riprova</button>
</div>

<audio id="song" preload="auto" src="audio/piano.mp3"></audio>

<script>
// FIREBASE
firebase.initializeApp({
Â  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
Â  authDomain: "calendarioroccasicura.firebaseapp.com",
Â  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
Â  projectId: "calendarioroccasicura",
Â  storageBucket: "calendarioroccasicura.appspot.com",
Â  messagingSenderId: "38731898044",
Â  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});
const db = firebase.database();

const song = document.getElementById("song");
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");

let tiles = [];
let speed = 4;
let score = 0;
let lives = 3;
let playing = false;
let startTime;

const userBase = localStorage.getItem("utente") || "Ospite";
const user = userBase[0] + Math.floor(Math.random()*900+100) + userBase.slice(1);

// AUDIO UNLOCK
document.getElementById("startBtn").onclick = () => {
Â  document.getElementById("panel").style.display = "none";
Â  document.getElementById("unlock").style.display = "block";
};

document.getElementById("unlockBtn").onclick = async () => {
Â  try {
Â  Â  await song.play();
Â  Â  song.pause();
Â  Â  song.currentTime = 0;
Â  Â  document.getElementById("unlock").style.display = "none";
Â  Â  startCountdown(startGame);
Â  } catch {
Â  Â  alert("Riprovare");
Â  }
};

// COUNTDOWN
function startCountdown(cb) {
Â  const cd = document.getElementById("countdown");
Â  const seq = ["3","2","1","VIA"];
Â  let i = 0;

Â  function next() {
Â  Â  if (i >= seq.length) {
Â  Â  Â  cd.style.display = "none";
Â  Â  Â  cb();
Â  Â  Â  return;
Â  Â  }
Â  Â  cd.innerText = seq[i++];
Â  Â  cd.style.display = "block";
Â  Â  cd.style.animation = "none";
Â  Â  void cd.offsetWidth;
Â  Â  cd.style.animation = "pulse .8s";
Â  Â  setTimeout(next, 900);
Â  }
Â  next();
}

// GAME START
function startGame() {
Â  canvas.style.display = "block";
Â  info.style.display = "block";
Â  song.play();
Â  startTime = performance.now();
Â  playing = true;
Â  requestAnimationFrame(update);
}

function spawnTile() {
Â  const col = Math.floor(Math.random()*3);
Â  tiles.push({ col, y: -120, hit:false });
}

// *** NUOVA LOGICA: Funzione Unificata per Click e Touch ***
function handleInput(clientX) {
Â  const r = canvas.getBoundingClientRect();
Â  const x = clientX - r.left;
Â  const col = Math.floor(x / (canvas.width/3));
Â  
Â  for (let t of tiles) {
Â  Â  if (!t.hit && t.col === col && t.y > canvas.height-180 && t.y < canvas.height) {
Â  Â  Â  t.hit = true;
Â  Â  Â  score += 10;
Â  Â  Â  return;
Â  Â  }
Â  }
}

// SOSTITUZIONE: L'onclick originale ora chiama handleInput (Desktop)
canvas.onclick = e => {
Â  handleInput(e.clientX);
};

// AGGIUNTA: Gestore per il Touch (Mobile)
canvas.ontouchstart = e => {
Â  e.preventDefault(); 
Â  if (e.touches.length > 0) {
Â  Â  handleInput(e.touches[0].clientX); 
Â  }
};
// *** FINE NUOVA LOGICA ***


function update(ts) {
Â  if (!playing) return;
Â  if (ts - startTime > 240000) return endGame();

Â  if (Math.random() < .02) spawnTile();
Â  speed = 4 + (ts - startTime)/60000;

Â  ctx.clearRect(0,0,canvas.width,canvas.height);
Â  const w = canvas.width/3;

Â  tiles.forEach(t => {
Â  Â  t.y += speed;
Â  Â  if (!t.hit && t.y > canvas.height) {
Â  Â  Â  lives--;
Â  Â  Â  t.hit = true;
Â  Â  Â  if (lives <= 0) endGame();
Â  Â  }
Â  Â  ctx.fillStyle = "#ffd700";
Â  Â  ctx.fillRect(t.col*w+8, t.y, w-16, 120);
Â  });

Â  tiles = tiles.filter(t => t.y < canvas.height+200);

Â  info.textContent = `â­ ${score} | â¤ï¸ ${lives}`;
Â  requestAnimationFrame(update);
}

function endGame() {
Â  playing = false;
Â  song.pause();
Â  document.getElementById("fine").style.display = "block";
Â  document.getElementById("fineMsg").innerHTML = `â­ Hai fatto <b>${score}</b> punti`;

Â  db.ref("punteggi/giorno12").push({
Â  Â  nome: user,
Â  Â  punti: score,
Â  Â  timestamp: Date.now()
Â  }).then(loadTop10);
}

// *** MODIFICA: La funzione loadTop10 ora pulisce la tabella (come Giorno 5) ***
function loadTop10() {
Â  const table = document.getElementById("scoreTable");
Â  
Â  // Correzione: Pulisce la tabella mantenendo solo l'intestazione
Â  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>"; 

Â  db.ref("punteggi/giorno12")
Â  Â  .orderByChild("punti").limitToLast(10)
Â  Â  .once("value", s => {
Â  Â  Â  let arr=[];
Â  Â  Â  s.forEach(c=>arr.push(c.val()));
Â  Â  Â  arr.sort((a,b)=>b.punti-a.punti);
Â  Â  Â  arr.forEach(r=>{
Â  Â  Â  Â  let tr=document.createElement("tr");
Â  Â  Â  Â  tr.innerHTML=`<td>${r.nome}</td><td>${r.punti}</td>`;
Â  Â  Â  Â  table.appendChild(tr);
Â  Â  Â  });
Â  Â  });
}
// *** FINE MODIFICA ***
</script>

</body>
</html>
