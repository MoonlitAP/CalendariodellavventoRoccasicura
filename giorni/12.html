<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéπ Giorno 12 ‚Äì Piano Tiles di Natale</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<style>

/* ===== RESET ===== */
body, html {
    margin: 0;
    padding: 0;
    font-family: "Ubuntu", sans-serif;
    background-color: #7b0412;
    color: #fff;
    overflow-x: hidden;
}

/* ===== START SCREEN ===== */
#start-screen {
    text-align: center;
    padding-top: 40px;
}

.titolo {
    color: #ffd700;
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 10px;
}

.sottotitolo {
    font-size: 20px;
    margin-bottom: 20px;
}

.btn-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 70%;
    margin: 0 auto;
}

.level-btn {
    background: #b3001b;
    border: 3px solid #ffd700;
    color: white;
    padding: 14px;
    font-size: 18px;
    border-radius: 12px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
}

.level-btn:hover {
    background: #d10723;
}

.note-info {
    margin-top: 25px;
    font-size: 14px;
    opacity: 0.8;
}

/* ===== GAME AREA ===== */
#game-area {
    display: none;
    text-align: center;
    margin-top: 10px;
}

#hud {
    display: flex;
    justify-content: space-between;
    padding: 0 20px;
    font-size: 18px;
    margin-bottom: 10px;
}

.hud-item {
    background: #b3001b;
    padding: 6px 10px;
    border: 2px solid #ffd700;
    border-radius: 8px;
}

/* ===== CANVAS ===== */
#game-canvas {
    background: #300208;
    border: 4px solid #ffd700;
    border-radius: 10px;
}

/* ===== GAME OVER ===== */
#gameover-screen {
    display: none;
    text-align: center;
    padding-top: 40px;
}

#gameover-screen h2 {
    font-size: 28px;
    color: #ffd700;
}

#final-score {
    font-weight: bold;
    color: #ffd700;
}

.nickname-box {
    margin: 20px 0;
}

.nickname-box input {
    padding: 10px;
    width: 70%;
    font-size: 18px;
    border-radius: 10px;
    border: none;
}

.nickname-box button,
#restart-btn,
#top10-btn {
    background: #b3001b;
    border: 3px solid #ffd700;
    padding: 10px 16px;
    border-radius: 10px;
    color: white;
    font-weight: bold;
    cursor: pointer;
}

/* ===== TOP 10 ===== */
#top10-screen {
    display: none;
    text-align: center;
    padding-top: 40px;
}

#top10-screen h2 {
    font-size: 28px;
    color: #ffd700;
}

#classifica {
    text-align: left;
    width: 260px;
    margin: 0 auto;
    font-size: 20px;
}

#back-btn {
    margin-top: 20px;
    background: #b3001b;
    padding: 12px 18px;
    border: 3px solid #ffd700;
    border-radius: 10px;
    color: white;
    cursor: pointer;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 450px) {
    #game-canvas {
        width: 90vw;
        height: 140vw;
    }
}

</style>
</head>

<body>

<!-- ===== START SCREEN ===== -->
<div id="start-screen">
    <h1 class="titolo">üéπ Giorno 12 ‚Äì Piano Tiles di Natale</h1>
    <p class="sottotitolo">Scegli la difficolt√†:</p>

    <div class="btn-container">
        <button class="level-btn" data-level="easy">FACILE</button>
        <button class="level-btn" data-level="medium">MEDIO</button>
        <button class="level-btn" data-level="hard">DIFFICILE</button>
        <button class="level-btn" data-level="ultra">EXTRA VELOCE</button>
    </div>

    <p class="note-info">Sincronizzato con Castle on the Hill ‚Äì Ed Sheeran</p>
</div>

<!-- ===== GAME AREA ===== -->
<div id="game-area">
    <div id="hud">
        <div class="hud-item">‚ù§Ô∏è Vite: <span id="vite">3</span></div>
        <div class="hud-item">‚è≥ Tempo: <span id="timer">0</span>s</div>
        <div class="hud-item">üéØ Punti: <span id="punti">0</span></div>
    </div>

    <canvas id="game-canvas" width="360" height="600"></canvas>
</div>

<!-- ===== GAME OVER ===== -->
<div id="gameover-screen">
    <h2>FINE LIVELLO</h2>
    <p>Punteggio: <span id="final-score">0</span></p>

    <div class="nickname-box">
        <input type="text" id="nickname" placeholder="Il tuo nome">
        <button id="save-score">Salva Punteggio</button>
    </div>

    <button id="restart-btn">Ricomincia</button>
    <button id="top10-btn">Vedi Top 10</button>
</div>

<!-- ===== TOP 10 ===== -->
<div id="top10-screen">
    <h2>üèÜ Top 10</h2>
    <ol id="classifica"></ol>
    <button id="back-btn">Indietro</button>
</div>

<!-- ===== AUDIO ===== -->
<audio id="song" preload="auto">
    <source src="audio/canzone.mp3" type="audio/mpeg">
</audio>

<!-- ===== FIREBASE LOADER ===== -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<!-- ===== JAVASCRIPT START ===== -->
<script>



















/* ==========================================
   üî• FIREBASE CONFIG (COMPAT MODE)
========================================== */

const firebaseConfig = {
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.firebasestorage.app",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ==========================================
   üéÆ VARIABILI DEL GIOCO
========================================== */

let canvas = document.getElementById("game-canvas");
let ctx = canvas.getContext("2d");

let colonne = 3;
let tiles = [];
let tileWidth = canvas.width / colonne;
let tileHeight = 160;

let vite = 3;
let punti = 0;
let livelloSelezionato = null;
let beatmap = [];
let beatIndex = 0;
let startTime = null;

let isGameRunning = false;
let fallSpeed = 5;

let timerInterval = null;
let tempo = 0;   // timer NON termina il gioco

let song = document.getElementById("song");

/* ==========================================
   üîÑ MOSTRA/NASCONDI SCREEN
========================================== */

function showScreen(id) {
    document.getElementById("start-screen").style.display = "none";
    document.getElementById("game-area").style.display = "none";
    document.getElementById("gameover-screen").style.display = "none";
    document.getElementById("top10-screen").style.display = "none";

    document.getElementById(id).style.display = "block";
}

/* ==========================================
   ‚ñ∂Ô∏è AVVIO LIVELLO
========================================== */

document.querySelectorAll(".level-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        livelloSelezionato = btn.dataset.level;

        if (livelloSelezionato === "easy") fallSpeed = 4;
        if (livelloSelezionato === "medium") fallSpeed = 5.5;
        if (livelloSelezionato === "hard") fallSpeed = 7;
        if (livelloSelezionato === "ultra") fallSpeed = 9;

        caricaBeatmap(livelloSelezionato);
        startGame();
    });
});

function startGame() {

    // reset variabili
    vite = 3;
    punti = 0;
    beatIndex = 0;
    tiles = [];
    tempo = 0;
    startTime = null;

    document.getElementById("vite").textContent = vite;
    document.getElementById("punti").textContent = punti;
    document.getElementById("timer").textContent = tempo;

    showScreen("game-area");

    // AUDIO FIX (per evitare AbortError)
    song.currentTime = 0;
    song.play().catch(()=>{});

    // Timer che NON termina il gioco
    timerInterval = setInterval(() => {
        tempo++;
        document.getElementById("timer").textContent = tempo;
    }, 1000);

    isGameRunning = true;
    requestAnimationFrame(update);
}

/* ==========================================
   üéµ FINE LIVELLO QUANDO FINISCE LA MUSICA
========================================== */

song.onended = () => {
    if (isGameRunning) {
        endLevel(); // NON √® game over, √® fine brano
    }
};

/* ==========================================
   üéπ CREA TILE
========================================== */

function creaTile(col) {
    tiles.push({
        x: col * tileWidth,
        y: -tileHeight,
        tapped: false
    });
}

/* ==========================================
   üß† UPDATE PRINCIPALE (GAME LOOP)
========================================== */

function update(timestamp) {

    if (!startTime) startTime = timestamp;
    let elapsed = (timestamp - startTime) / 1000;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // BEATMAP EVENTI
    while (beatIndex < beatmap.length && beatmap[beatIndex].time <= elapsed) {
        let evt = beatmap[beatIndex];
        evt.cols.forEach(col => creaTile(col));
        beatIndex++;
    }

    // MOVE + DRAW TILES
    for (let i = 0; i < tiles.length; i++) {
        let t = tiles[i];
        t.y += fallSpeed;

        // TILE RED + GOLD
        ctx.fillStyle = "#b3001b";
        ctx.fillRect(t.x, t.y, tileWidth, tileHeight);

        ctx.strokeStyle = "#ffd700";
        ctx.lineWidth = 4;
        ctx.strokeRect(t.x, t.y, tileWidth, tileHeight);

        // NON TAPPATA E ESCE DALLO SCHERMO ‚Üí -1 VITA
        if (!t.tapped && t.y > canvas.height) {
            vite--;
            document.getElementById("vite").textContent = vite;
            tiles.splice(i, 1);
            i--;

            if (vite <= 0) {
                endLevel();  // fine livello per vite finite
                return;
            }
        }
    }

    if (isGameRunning) requestAnimationFrame(update);
}

/* ==========================================
   üëÜ TAP SU TILE
========================================== */

canvas.addEventListener("click", (e) => {

    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    for (let i = 0; i < tiles.length; i++) {
        let t = tiles[i];

        if (!t.tapped &&
            x >= t.x && x <= t.x + tileWidth &&
            y >= t.y && y <= t.y + tileHeight) {

            t.tapped = true;
            punti++;
            document.getElementById("punti").textContent = punti;

            tiles.splice(i, 1);
            break;
        }
    }
});

/* ==========================================
   üèÅ FINE LIVELLO
========================================== */

function endLevel() {
    isGameRunning = false;
    song.pause();
    clearInterval(timerInterval);

    document.getElementById("final-score").textContent = punti;
    showScreen("gameover-screen");
}

/* ==========================================
   üíæ SALVA PUNTEGGIO PER LIVELLO
========================================== */

document.getElementById("save-score").addEventListener("click", () => {

    let name = document.getElementById("nickname").value.trim();
    if (name === "") return;

    let path = "giorno12_" + livelloSelezionato; // es: giorno12_easy

    db.ref(path).push({
        nickname: name,
        punti: punti
    });

    alert("Punteggio salvato!");
});

/* ==========================================
   üèÜ MOSTRARE TOP 10 PER LIVELLO
========================================== */

document.getElementById("top10-btn").addEventListener("click", () => {

    showScreen("top10-screen");

    let path = "giorno12_" + livelloSelezionato;

    db.ref(path)
      .orderByChild("punti")
      .limitToLast(10)
      .once("value", snap => {

        let arr = [];
        snap.forEach(s => arr.push(s.val()));
        arr.reverse(); // punteggi maggiori in alto

        let lista = document.getElementById("classifica");
        lista.innerHTML = "";

        arr.forEach(p => {
            let li = document.createElement("li");
            li.textContent = `${p.nickname} ‚Äî ${p.punti}`;
            lista.appendChild(li);
        });
    });
});

document.getElementById("back-btn").addEventListener("click", () => {
    showScreen("gameover-screen");
});

/* ==========================================
   üîÑ RICOMINCIA
========================================== */

document.getElementById("restart-btn").addEventListener("click", () => {
    location.reload();
});

/* ==========================================
   üì¶ CARICA BEATMAP CORRETTA (arriva in PARTE 3/4)
========================================== */

function caricaBeatmap(level) {
    if (level === "easy") beatmap = beatmap_easy;
    if (level === "medium") beatmap = beatmap_medium;
    if (level === "hard") beatmap = beatmap_hard;
    if (level === "ultra") beatmap = beatmap_ultra;
}














/* ============================================================
      üéµ BEATMAP EASY ‚Äì Alternato morbido (1 tile per beat)
============================================================ */

let beatmap_easy = [];

/* Alternato: colonna 0 ‚Üí 1 ‚Üí 2 ‚Üí 1 ‚Üí ripete */
function easyAlternato(inizio, fine, bpm) {

    let seq = [0, 1, 2, 1];
    let index = 0;

    let beatTime = 60 / bpm;
    let t = inizio;

    while (t <= fine) {
        beatmap_easy.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

let BPM_easy = 135;

/* Struttura completa del brano */
easyAlternato(0, 15, BPM_easy);      // intro
easyAlternato(15, 45, BPM_easy);     // strofa 1
easyAlternato(45, 75, BPM_easy);     // pre-chorus
easyAlternato(75, 105, BPM_easy);    // ritornello
easyAlternato(105, 135, BPM_easy);   // strofa 2
easyAlternato(135, 165, BPM_easy);   // pre-chorus 2
easyAlternato(165, 195, BPM_easy);   // ritornello 2
easyAlternato(195, 225, BPM_easy);   // bridge
easyAlternato(225, 240, BPM_easy);   // ritornello finale



/* ============================================================
      üéµ BEATMAP MEDIUM ‚Äì 1‚Äì2 tile per beat
============================================================ */

let beatmap_medium = [];

/* Singolo: una tile */
function medSingolo(inizio, fine, bpm, seq=[0,2,1,2]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_medium.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Doppio: due tile simultanee */
function medDoppio(inizio, fine, bpm, seq=[[0,1],[1,2],[2,1],[1,0]]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_medium.push({
            time: parseFloat(t.toFixed(3)),
            cols: seq[index]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

let BPM_med = 135;

/* MEDIO ‚Äì Struttura del brano completa */
medSingolo(0, 15, BPM_med);           // intro
medSingolo(15, 30, BPM_med);          // strofa 1A
medDoppio(30, 45, BPM_med);           // strofa 1B
medDoppio(45, 60, BPM_med);           // pre-chorus A
medSingolo(60, 75, BPM_med);          // pre-chorus B
medDoppio(75, 90, BPM_med);           // ritornello A
medSingolo(90, 105, BPM_med);         // ritornello B
medSingolo(105, 120, BPM_med);        // strofa 2A
medDoppio(120, 135, BPM_med);         // strofa 2B
medDoppio(135, 150, BPM_med);         // pre-chorus 2A
medSingolo(150, 165, BPM_med);        // pre-chorus 2B
medDoppio(165, 180, BPM_med);         // ritornello 2A
medSingolo(180, 195, BPM_med);        // ritornello 2B
medSingolo(195, 210, BPM_med);        // bridge A
medDoppio(210, 225, BPM_med);         // bridge B
medDoppio(225, 240, BPM_med);         // ritornello finale



















/* ============================================================
      üéµ BEATMAP HARD ‚Äì 1/2/3 tiles, tripli nei ritornelli
============================================================ */

let beatmap_hard = [];

/* Singolo veloce */
function hardSingolo(inizio, fine, bpm, seq=[0,2,1,2]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_hard.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Doppio energico */
function hardDoppio(inizio, fine, bpm, seq=[[0,1],[1,2],[2,1],[1,0]]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_hard.push({
            time: parseFloat(t.toFixed(3)),
            cols: seq[index]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Triplo completo (tutte le colonne) */
function hardTriplo(inizio, fine, bpm) {
    let beatTime = 60 / bpm;
    let t = inizio;

    while (t <= fine) {
        beatmap_hard.push({
            time: parseFloat(t.toFixed(3)),
            cols: [0,1,2]
        });
        t += beatTime;
    }
}

let BPM_hard = 135;

/* HARD ‚Äì struttura brano */
hardSingolo(0, 15, BPM_hard);         // intro
hardSingolo(15, 30, BPM_hard);        // strofa A
hardDoppio(30, 45, BPM_hard);         // strofa B
hardDoppio(45, 60, BPM_hard);         // pre-chorus A
hardTriplo(60, 75, BPM_hard);         // ritornello TRIPLO
hardSingolo(75, 90, BPM_hard);        // ritornello B
hardDoppio(90, 105, BPM_hard);        // post-ritornello
hardSingolo(105, 120, BPM_hard);      // strofa 2A
hardDoppio(120, 135, BPM_hard);       // strofa 2B
hardDoppio(135, 150, BPM_hard);       // pre-chorus 2A
hardTriplo(150, 165, BPM_hard);       // TRIPLO ritornello 2A
hardDoppio(165, 180, BPM_hard);       // ritornello 2B
hardTriplo(180, 195, BPM_hard);       // TRIPLO lungo
hardSingolo(195, 210, BPM_hard);      // bridge A
hardDoppio(210, 225, BPM_hard);       // bridge B
hardTriplo(225, 240, BPM_hard);       // rit finale TRIPLO




/* ============================================================
      üéµ BEATMAP ULTRA ‚Äì mezzo beat, doppi + tripli
============================================================ */

let beatmap_ultra = [];

/* Singolo rapido */
function ultraSingolo(inizio, fine, bpm, seq=[0,2,1,2,0,1]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_ultra.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Mezzo beat (doppia velocit√†) */
function ultraMezzoBeat(inizio, fine, bpm, seq=[0,1,2,1,0,2]) {
    let beatTime = 60 / bpm / 2;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_ultra.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Doppio */
function ultraDoppio(inizio, fine, bpm, seq=[[0,1],[1,2],[2,1],[1,0]]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_ultra.push({
            time: parseFloat(t.toFixed(3)),
            cols: seq[index]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Triplo */
function ultraTriplo(inizio, fine, bpm) {
    let beatTime = 60 / bpm / 1.5;
    let t = inizio;

    while (t <= fine) {
        beatmap_ultra.push({
            time: parseFloat(t.toFixed(3)),
            cols: [0,1,2]
        });
        t += beatTime;
    }
}

let BPM_ultra = 135;

/* ULTRA ‚Äì struttura brano */
ultraMezzoBeat(0, 15, BPM_ultra);     // intro
ultraSingolo(15, 30, BPM_ultra);      // strofa A
ultraDoppio(30, 45, BPM_ultra);       // strofa B
ultraMezzoBeat(45, 60, BPM_ultra);    // pre-chorus
ultraTriplo(60, 75, BPM_ultra);       // rit 1 TRIPLO
ultraDoppio(75, 90, BPM_ultra);
ultraMezzoBeat(90, 105, BPM_ultra);
ultraSingolo(105, 120, BPM_ultra);
ultraDoppio(120, 135, BPM_ultra);
ultraMezzoBeat(135, 150, BPM_ultra);
ultraTriplo(150, 165, BPM_ultra);     // rit 2 TRIPLO
ultraDoppio(165, 180, BPM_ultra);
ultraMezzoBeat(180, 195, BPM_ultra);
ultraSingolo(195, 210, BPM_ultra);
ultraMezzoBeat(210, 225, BPM_ultra);
ultraTriplo(225, 240, BPM_ultra);     // TRIPLO finale


/* ==========================================
   üîö CHIUSURA DELLO SCRIPT E HTML
========================================== */

</script>
</body>
</html>


