<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéπ Giorno 12 ‚Äì Piano Tiles Evolution</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  padding: 0;
  font-family: "Ubuntu", sans-serif;
  text-align: center;
  color: #fff;
  overflow-x: hidden;
  background: #000 url("img/piano_roccasicura.jpg") center/cover no-repeat fixed;
}

h1 {
  margin-top: 10px;
  color: #ffd700;
  text-shadow: 2px 2px 5px #000;
}

/* CANVAS */
canvas {
  display: none;
  background: rgba(0,0,0,0.45);
  border: 3px solid #ffd700;
  border-radius: 15px;
  margin: 20px auto;
  touch-action: none;
  box-shadow: 0 0 25px #000;
}

#info {
  display: none;
  width: 100%;
  padding: 10px 0;
  font-size: 1.3em;
  background: rgba(0,0,0,0.55);
  border-top: 1px solid #ffd700;
  position: fixed;
  bottom: 0;
  left: 0;
  z-index: 50;
}

/* PANELS */
.panel-box {
  width: 90%;
  max-width: 450px;
  background: #fffaf2;
  color: #400000;
  border: 2px solid #ffd700;
  border-radius: 22px;
  padding: 25px;
  box-shadow: 0 0 25px #000;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.btn {
  width: 85%;
  padding: 15px;
  margin-top: 12px;
  font-size: 1.1em;
  border: none;
  border-radius: 30px;
  background: #7b0412;
  color: white;
  cursor: pointer;
}
.btn:hover { background: #ffd700; color: #000; }

/* HIDDEN PANELS */
#panel, #unlock, #countdown, #fine {
  display: none;
}

/* COUNTDOWN */
#countdown {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 120px;
  color: #ffd700;
  text-shadow: 0 0 25px #fff, 0 0 35px #ffd700;
  font-weight: bold;
  opacity: 0;
  animation: none;
}

@keyframes pulse {
  0% { transform: translate(-50%, -50%) scale(.3); opacity: 0; }
  40% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1.0); opacity: 0; }
}

/* FINE POPUP */
#fine {
  width: 90%;
  max-width: 600px !important;
  padding: 35px;
}

#fine table {
  width: 100%;
  margin-top: 18px;
  font-size: 1.1em;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid #d7bb5f;
}

.btn-row {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-top: 25px;
}

.btn-small {
  padding: 12px 30px;
  border-radius: 30px;
  background: #7b0412;
  color: white;
  cursor: pointer;
  border: none;
}
.btn-small:hover { background: #ffd700; color: #000; }

</style>
</head>

<body>

<h1>üéπ Giorno 12 ‚Äì Piano Tiles Evolution</h1>

<!-- START PANEL -->
<div id="panel" class="panel-box" style="display:block;">
  <h2>‚ú® Come si gioca ‚ú®</h2>
  <p style="font-size:1.1em;">
    ‚Ä¢ Tocca le piastrelle d‚Äôoro al ritmo della musica<br>
    ‚Ä¢ Perdi 1 vita se una tile cade<br>
    ‚Ä¢ Nessuna penalit√† per click a vuoto<br>
    ‚Ä¢ Difficolt√† crescente<br>
    ‚Ä¢ La musica accelera fino a 1.20√ó<br>
  </p>
  <button id="btn-start" class="btn">‚ñ∂Ô∏è INIZIA</button>
</div>

<!-- UNLOCK AUDIO -->
<div id="unlock" class="panel-box">
  <h2>üéµ Attiva la musica</h2>
  <p>Tocca per permettere al gioco di riprodurre l‚Äôaudio.</p>
  <button id="unlock-btn" class="btn" style="background:#ffd700;color:#400000;">TOCCA PER ATTIVARE</button>
</div>

<!-- COUNTDOWN -->
<div id="countdown"></div>

<!-- GAME -->
<canvas id="game"></canvas>
<div id="info"></div>

<!-- FINALE -->
<div id="fine" class="panel-box">
  <h2 id="fine-msg"></h2>
  <h3>üèÜ Top 10 ‚Äì Piano Tiles Evolution</h3>

  <table id="score-table">
    <tr><th>Nome</th><th>Punti</th></tr>
  </table>

  <div class="btn-row">
    <button id="retry-btn" class="btn-small">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn-small">‚¨Ö Calendario</a>
  </div>
</div>

<!-- AUDIO -->
<audio id="song" preload="auto" src="audio/piano.mp3"></audio>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.appspot.com",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});
const db = firebase.database();

/* USER */
const real = localStorage.getItem("utente") || "Ospite";
const user = real[0] + Math.floor(Math.random()*900+100) + real.slice(1);

/* GAME VARS */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");
const song = document.getElementById("song");

let tiles = [];
let speed = 4;
let lives = 3;
let score = 0;
let playing = false;
let startTime;

/* CANVAS SIZE */
function resizeCanvas(){
  if(window.innerWidth < 700){
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight * 0.65;
  } else {
    canvas.width = 450;
    canvas.height = 700;
  }
}
resizeCanvas();

/* START BUTTON */
document.getElementById("btn-start").onclick = () => {
  document.getElementById("panel").style.display = "none";
  document.getElementById("unlock").style.display = "block";
};

/* UNLOCK AUDIO */
document.getElementById("unlock-btn").onclick = async () => {
  try {
    await song.play();
    song.pause();
    song.currentTime = 0;

    document.getElementById("unlock").style.display = "none";

    startCountdown(startGame);
  } catch {
    alert("Riprova a toccare per attivare l'audio");
  }
};

/* COUNTDOWN */
function startCountdown(cb){
  const cd = document.getElementById("countdown");
  const seq = ["3","2","1","VIA"];
  let i = 0;

  function showNext(){
    if(i >= seq.length){
      cd.style.display = "none";
      cb();
      return;
    }
    cd.innerText = seq[i++];
    cd.style.display = "block";
    cd.style.animation = "none";
    void cd.offsetWidth;
    cd.style.animation = "pulse .8s";
    setTimeout(showNext, 900);
  }
  showNext();
}

/* START GAME */
function startGame(){
  canvas.style.display = "block";
  info.style.display = "block";

  song.play();
  playing = true;
  startTime = performance.now();

  requestAnimationFrame(update);
}

/* CLICK FULL COLUMN (PERFETTO) */
function handleInput(clientX){
  const r = canvas.getBoundingClientRect();
  const x = clientX - r.left;
  const col = Math.floor(x / (canvas.width / 3));

  let target = null;

  tiles.forEach(t => {
    if(t.col === col && !t.hit){
      if(!target || t.y > target.y){
        target = t;
      }
    }
  });

  if(target){
    target.hit = true;
    score += 10;
  }
}

/* LISTENERS */
canvas.onclick = e => handleInput(e.clientX);
canvas.ontouchstart = e => {
  e.preventDefault();
  handleInput(e.touches[0].clientX);
};

/* TILE GENERATION */
function spawnTile(){
  const col = Math.floor(Math.random()*3);
  tiles.push({ col, y: -140, hit:false });
}

/* UPDATE LOOP */
function update(ts){
  if(!playing) return;

  if(ts - startTime > 240000) return endGame();

  if(Math.random() < .03) spawnTile();

  speed = 4 + (ts - startTime)/60000;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  const w = canvas.width / 3;

  tiles.forEach(t => {
    t.y += speed;

    if(!t.hit && t.y > canvas.height){
      lives--;
      t.hit = true;
      if(lives <= 0) return endGame();
    }

    ctx.fillStyle = "#ffd700";
    ctx.shadowColor = "#fff";
    ctx.shadowBlur = 20;
    ctx.fillRect(t.col*w+8, t.y, w-16, 140);
    ctx.shadowBlur = 0;
  });

  tiles = tiles.filter(t => t.y < canvas.height + 200);

  info.textContent = `‚≠ê ${score} | ‚ù§Ô∏è ${lives}`;

  requestAnimationFrame(update);
}

/* END GAME */
function endGame(){
  playing = false;
  song.pause();

  document.getElementById("info").style.display = "none";
  canvas.style.display = "none";
  document.getElementById("fine").style.display = "block";

  document.getElementById("fine-msg").innerHTML =
    `‚≠ê Hai ottenuto <b>${score}</b> punti`;

  db.ref("punteggi/giorno12").push({
    nome: user,
    punti: Number(score),
    timestamp: Date.now()
  }).then(loadTop10);
}

/* CLASSIFICA */
function loadTop10(){
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno12")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap => {
      let arr = [];
      snap.forEach(c => arr.push(c.val()));

      arr.sort((a,b) => b.punti - a.punti);

      arr.forEach(r => {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

document.getElementById("retry-btn").onclick = () => location.reload();

</script>

</body>
</html>
