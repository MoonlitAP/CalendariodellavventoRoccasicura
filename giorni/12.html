<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéπ Giorno 12 ‚Äì Piano Tiles Evolution</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>

body {
  margin: 0;
  padding: 0;
  font-family: "Ubuntu", sans-serif;
  text-align: center;
  color: #fff;
  overflow-x: hidden;

  /* SFONDO PERSONALIZZATO */
  background: #000 url("img/piano_roccasicura.jpg") center/cover no-repeat fixed;
}

h1 {
  margin-top: 10px;
  color: #ffd700;
  text-shadow: 2px 2px 5px #000;
}

/* CANVAS */
canvas {
  display: none;
  background: rgba(0,0,0,0.45);
  border: 3px solid #ffd700;
  border-radius: 15px;
  margin: 20px auto;
  touch-action: none;
  box-shadow: 0 0 20px #000;
}

/* INFO BAR */
#info {
  display: none;
  width: 100%;
  padding: 10px 0;
  font-size: 1.2em;
  background: rgba(0,0,0,0.55);
  border-top: 1px solid #ffd700;
  position: fixed;
  bottom: 0;
  left: 0;
  z-index: 50;
}

/* START PANEL */
#panel {
  width: 90%;
  max-width: 420px;
  margin: 20px auto;
  background: rgba(255,250,242,0.92);
  border: 2px solid #ffd700;
  border-radius: 20px;
  padding: 20px;
  color: #3a0000;
  box-shadow: 0 0 20px #000;
}

.btn {
  width: 80%;
  padding: 14px;
  margin-top: 10px;
  font-size: 1.1em;
  border: none;
  border-radius: 30px;
  background: #7b0412;
  color: white;
  cursor: pointer;
}
.btn:hover { background: #ffd700; color: #000; }

/* POPUP FINALE */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(4px);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
}

.classifica-box {
  background: #fffaf2;
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
  animation: popup .4s ease-out;
}

@keyframes popup {
  from { transform: scale(.7); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

table {
  width: 100%;
  margin-top: 15px;
}
th, td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #d7bb5f;
}

.btn-row {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 25px;
}

.btn-small {
  padding: 12px 25px;
  border-radius: 30px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  background: #b30d0d;
  color: white;
}
.btn-small:hover {
  background: #ffd700;
  color: #000;
}

</style>
</head>

<body>

<h1>üéπ Giorno 12 ‚Äì Piano Tiles Evolution</h1>

<div id="panel">
  <h2>‚ú® Come si gioca ‚ú®</h2>
  <p>
    ‚Ä¢ Tocca le piastrelle nere al ritmo della musica<br>
    ‚Ä¢ Evita le piastrelle rosse ‚Üí perdi 1 vita<br>
    ‚Ä¢ Hai 3 vite<br>
    ‚Ä¢ La difficolt√† aumenta automaticamente<br>
    ‚Ä¢ La musica accelera fino a 1.20√ó<br>
    ‚Ä¢ Pi√π vai avanti, pi√π diventa difficile<br>
  </p>

  <button id="btn-start" class="btn">‚ñ∂Ô∏è INIZIA</button>
  <button id="btn-top10" class="btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
</div>

<canvas id="game"></canvas>
<div id="info"></div>

<!-- POPUP FINALE -->
<div id="fine">
  <div class="classifica-box">

    <h2 id="fine-msg"></h2>
    <h3>üèÜ Top 10 ‚Äì Piano Tiles Evolution</h3>

    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <div class="btn-row">
      <button id="retry-btn" class="btn-small">üîÑ Riprova</button>
      <a href="../calendario.html" class="btn-small">‚¨Ö Calendario</a>
    </div>

  </div>
</div>

<!-- AUDIO -->
<audio id="song" preload="auto">
  <source src="audio/canzone.mp3" type="audio/mpeg">
</audio>

<script>
/* ============================================================
   üî• FIREBASE
============================================================ */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.appspot.com",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});
const db = firebase.database();

// Nome utente mascherato
const real = localStorage.getItem("utente") || "Ospite";
const user = real[0] + Math.floor(Math.random()*900+100) + real.slice(1);


/* ============================================================
   üéÆ VARIABILI GIOCO
============================================================ */
let canvas = document.getElementById("game");
let ctx = canvas.getContext("2d");

let lives = 3;
let score = 0;
let playing = false;

let tiles = [];
let tileSpeed = 4;          // base
let currentPhase = 1;       // 1=easy, 2=medium, 3=hard, 4=ultra
let lastTime = 0;

let gameDuration = 240000;  // 4 minuti
let startTimestamp = null;

const song = document.getElementById("song");


/* CANVAS SIZE */
function resizeCanvas(){
  if(window.innerWidth < 700){
    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight * 0.65;
  } else {
    canvas.width = 450;
    canvas.height = 700;
  }
}
resizeCanvas();


/* ============================================================
   üéµ GENERA TILE
============================================================ */
function spawnTile(cols) {
  cols.forEach(c => {
    tiles.push({
      col: c,
      y: -150,
      color: "black",
      bad: false
    });
  });
}

function spawnBadTile() {
  let c = Math.floor(Math.random()*3);
  tiles.push({
    col: c,
    y: -150,
    color: "red",
    bad: true
  });
}


/* ============================================================
   üî• EVOLUTION MODE ‚Äì CAMBIO DI FASE AUTOMATICO
============================================================ */
function updatePhase(elapsed) {

  if (elapsed > 180000 && currentPhase < 4) {
    currentPhase = 4;
    transitionTo(1.20, 8, 9);
  }
  else if (elapsed > 120000 && currentPhase < 3) {
    currentPhase = 3;
    transitionTo(1.12, 6, 7);
  }
  else if (elapsed > 60000 && currentPhase < 2) {
    currentPhase = 2;
    transitionTo(1.05, 5, 6);
  }
}

/* transizione graduale */
function transitionTo(targetPlayback, speedIncrease, durationSec) {
  let startRate = song.playbackRate;
  let startSpeed = tileSpeed;

  let steps = durationSec * 60;
  let i = 0;

  let interval = setInterval(() => {
    i++;
    song.playbackRate = startRate + (targetPlayback - startRate) * (i / steps);
    tileSpeed = startSpeed + speedIncrease * (i / steps);

    if (i >= steps) clearInterval(interval);
  }, 1000/60);
}


/* ============================================================
   üß† BEATMAP DINAMICA
============================================================ */
function generateBeatmap(currentTime) {

  let beat = Math.floor(currentTime / 500);

  if (currentPhase === 1) {
    if (beat % 2 === 0) spawnTile([0]);
    else spawnTile([2]);
  }

  else if (currentPhase === 2) {
    if (beat % 3 === 0) spawnTile([1]);
    else spawnTile([Math.floor(Math.random()*3)]);
  }

  else if (currentPhase === 3) {
    if (beat % 4 === 0) spawnTile([0,2]);
    else spawnTile([Math.floor(Math.random()*3)]);
  }

  else if (currentPhase === 4) {
    if (beat % 5 === 0) spawnTile([0,1,2]);
    else spawnTile([Math.floor(Math.random()*3)]);
  }

  if (Math.random() < 0.03) spawnBadTile();
}


/* ============================================================
   üéÆ CLICK TILE
============================================================ */
canvas.addEventListener("click", (e)=>{
  const r = canvas.getBoundingClientRect();
  const mx = e.clientX - r.left;
  const my = e.clientY - r.top;

  let col = Math.floor(mx / (canvas.width / 3));

  for (let t of tiles) {
    if (t.col === col && my >= t.y && my <= t.y + 150) {

      if (t.bad) {
        lives--;
        if (lives <= 0) endGame();
      } 
      else {
        score += 5;
      }
      t.hit = true;
      break;
    }
  }
});


/* ============================================================
   üé® LOOP DI GIOCO
============================================================ */
function update(timestamp){

  if (!playing) return;

  if (!startTimestamp) startTimestamp = timestamp;
  let elapsed = timestamp - startTimestamp;

  lastTime += (timestamp - lastTime);

  updatePhase(elapsed);

  if (elapsed % 500 < 20) {
    generateBeatmap(elapsed);
  }

  tiles.forEach(t=>{
    t.y += tileSpeed;
  });

  tiles = tiles.filter(t=>t.y < canvas.height && !t.hit);

  draw();

  if (elapsed >= gameDuration) {
    endGame();
    return;
  }

  requestAnimationFrame(update);
}


function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  let w = canvas.width / 3;

  tiles.forEach(t=>{
    ctx.fillStyle = t.bad ? "#b30000": "#000";
    ctx.fillRect(t.col*w, t.y, w-2, 150);
  });

  document.getElementById("info").textContent =
    `‚≠ê ${score} | ‚ù§Ô∏è ${lives}`;
}


/* ============================================================
   ‚ñ∂Ô∏è START GAME
============================================================ */
document.getElementById("btn-start").onclick = ()=>{

  document.getElementById("panel").style.display = "none";
  canvas.style.display = "block";
  document.getElementById("info").style.display = "block";

  playing = true;

  let playPromise = song.play();
  if (playPromise !== undefined) {
    playPromise.catch(()=>{});
  }

  requestAnimationFrame(update);
};


/* ============================================================
   üèÜ CLASSIFICA
============================================================ */
document.getElementById("btn-top10").onclick = ()=>{
  document.getElementById("panel").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  loadTop10();
};

function loadTop10(){
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno12")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap=>{
      let list = [];
      snap.forEach(c=>{
        list.push(c.val());
      });

      list.sort((a,b)=>b.punti - a.punti);

      list.forEach(r=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}


/* ============================================================
   üîö END GAME
============================================================ */
function endGame(){
  playing = false;
  canvas.style.display = "none";
  document.getElementById("info").style.display = "none";

  document.getElementById("fine").style.display = "flex";
  document.getElementById("fine-msg").innerHTML =
    `‚≠ê Hai totalizzato <b>${score}</b> punti!`;

  db.ref("punteggi/giorno12").push({
    nome: user,
    punti: Number(score),
    timestamp: Date.now()
  }).then(()=> loadTop10());
}

document.getElementById("retry-btn").onclick = ()=>location.reload();
</script>

</body>
</html>


