<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéπ Giorno 12 ‚Äì Piano Tiles Evolution</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  padding: 0;
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  text-align: center;
  background: #000 url("img/piano_roccasicura.jpg") center/cover no-repeat fixed;
}

h1 {
  margin-top: 10px;
  color: #ffd700;
  text-shadow: 2px 2px 5px #000;
}

canvas {
  display: none;
  margin: 20px auto;
  background: rgba(0,0,0,0.45);
  border: 3px solid #ffd700;
  border-radius: 15px;
}

#info {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0,0,0,0.6);
  padding: 10px;
  font-size: 1.2em;
  border-top: 1px solid #ffd700;
}

/* PANEL */
#panel, #unlock, #countdown, #fine {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

#panel, #unlock {
  width: 85%;
  max-width: 420px;
  background: #fffaf2;
  color: #400000;
  border: 2px solid #ffd700;
  border-radius: 20px;
  padding: 25px;
  box-shadow: 0 0 25px #000;
}

.btn {
  width: 80%;
  margin-top: 12px;
  padding: 14px;
  font-size: 1.1em;
  background: #7b0412;
  color: #fff;
  border: none;
  border-radius: 30px;
  cursor: pointer;
}
.btn:hover { background: #ffd700; color: #000; }

#unlock, #countdown, #fine {
  display: none;
}

#countdown {
  font-size: 120px;
  color: #ffd700;
  text-shadow: 0 0 25px #fff;
  animation: pulse .8s;
}

@keyframes pulse {
  0% { transform: translate(-50%,-50%) scale(.3); opacity: 0; }
  40% { transform: translate(-50%,-50%) scale(1.3); opacity: 1; }
  100% { transform: translate(-50%,-50%) scale(1); opacity: 0; }
}

/* FINE */
#fine {
  width: 90%;
  max-width: 500px;
  background: #fffaf2;
  color: #400000;
  border-radius: 20px;
  padding: 30px;
}

table {
  width: 100%;
  margin-top: 15px;
}

th, td {
  padding: 10px;
  border-bottom: 1px solid #d7bb5f;
}
</style>
</head>

<body>

<h1>üéπ Giorno 12 ‚Äì Piano Tiles Evolution</h1>

<div id="panel">
  <p>üéº Tocca le piastrelle d‚Äôoro a ritmo<br>
     ‚ù§Ô∏è 3 vite ‚Äì perdi una se una tile cade<br>
     ‚ö° Difficolt√† crescente automatica</p>
  <button id="startBtn" class="btn">‚ñ∂Ô∏è Inizia</button>
</div>

<div id="unlock">
  <h2>üéµ Attiva la musica</h2>
  <button id="unlockBtn" class="btn">TOCCA PER ATTIVARE</button>
</div>

<div id="countdown"></div>

<canvas id="game" width="360" height="600"></canvas>
<div id="info"></div>

<div id="fine">
  <h2 id="fineMsg"></h2>
  <h3>üèÜ Top 10</h3>
  <table id="scoreTable">
    <tr><th>Nome</th><th>Punti</th></tr>
  </table>
  <button class="btn" onclick="location.reload()">Riprova</button>
</div>

<audio id="song" preload="auto" src="audio/piano.mp3"></audio>

<script>
// FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.appspot.com",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});
const db = firebase.database();

const song = document.getElementById("song");
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");

let tiles = [];
let speed = 4;
let score = 0;
let lives = 3;
let playing = false;
let startTime;

const userBase = localStorage.getItem("utente") || "Ospite";
const user = userBase[0] + Math.floor(Math.random()*900+100) + userBase.slice(1);

// AUDIO UNLOCK
document.getElementById("startBtn").onclick = () => {
  document.getElementById("panel").style.display = "none";
  document.getElementById("unlock").style.display = "block";
};

document.getElementById("unlockBtn").onclick = async () => {
  try {
    await song.play();
    song.pause();
    song.currentTime = 0;
    document.getElementById("unlock").style.display = "none";
    startCountdown(startGame);
  } catch {
    alert("Riprovare");
  }
};

// COUNTDOWN
function startCountdown(cb) {
  const cd = document.getElementById("countdown");
  const seq = ["3","2","1","VIA"];
  let i = 0;

  function next() {
    if (i >= seq.length) {
      cd.style.display = "none";
      cb();
      return;
    }
    cd.innerText = seq[i++];
    cd.style.display = "block";
    cd.style.animation = "none";
    void cd.offsetWidth;
    cd.style.animation = "pulse .8s";
    setTimeout(next, 900);
  }
  next();
}

// GAME START
function startGame() {
  canvas.style.display = "block";
  info.style.display = "block";
  song.play();
  startTime = performance.now();
  playing = true;
  requestAnimationFrame(update);
}

function spawnTile() {
  const col = Math.floor(Math.random()*3);
  tiles.push({ col, y: -120, hit:false });
}

canvas.onclick = e => {
  const r = canvas.getBoundingClientRect();
  const x = e.clientX - r.left;
  const col = Math.floor(x / (canvas.width/3));
  for (let t of tiles) {
    if (!t.hit && t.col === col && t.y > canvas.height-180 && t.y < canvas.height) {
      t.hit = true;
      score += 10;
      return;
    }
  }
};

function update(ts) {
  if (!playing) return;
  if (ts - startTime > 240000) return endGame();

  if (Math.random() < .02) spawnTile();
  speed = 4 + (ts - startTime)/60000;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  const w = canvas.width/3;

  tiles.forEach(t => {
    t.y += speed;
    if (!t.hit && t.y > canvas.height) {
      lives--;
      t.hit = true;
      if (lives <= 0) endGame();
    }
    ctx.fillStyle = "#ffd700";
    ctx.fillRect(t.col*w+8, t.y, w-16, 120);
  });

  tiles = tiles.filter(t => t.y < canvas.height+200);

  info.textContent = `‚≠ê ${score} | ‚ù§Ô∏è ${lives}`;
  requestAnimationFrame(update);
}

function endGame() {
  playing = false;
  song.pause();
  document.getElementById("fine").style.display = "block";
  document.getElementById("fineMsg").innerHTML = `‚≠ê Hai fatto <b>${score}</b> punti`;

  db.ref("punteggi/giorno12").push({
    nome: user,
    punti: score,
    timestamp: Date.now()
  }).then(loadTop10);
}

function loadTop10() {
  const table = document.getElementById("scoreTable");
  db.ref("punteggi/giorno12")
    .orderByChild("punti").limitToLast(10)
    .once("value", s => {
      let arr=[];
      s.forEach(c=>arr.push(c.val()));
      arr.sort((a,b)=>b.punti-a.punti);
      arr.forEach(r=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}
</script>

</body>
</html>