<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéπ Giorno 12 ‚Äì Piano Tiles di Natale</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<style>

/* ===== RESET ===== */
body, html {
    margin: 0;
    padding: 0;
    font-family: "Ubuntu", sans-serif;
    background-color: #7b0412;
    color: #fff;
    overflow-x: hidden;
}

/* ===== START SCREEN ===== */
#start-screen {
    text-align: center;
    padding-top: 40px;
}

.titolo {
    color: #ffd700;
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 10px;
}

.sottotitolo {
    font-size: 20px;
    margin-bottom: 20px;
}

.btn-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 70%;
    margin: 0 auto;
}

.level-btn {
    background: #b3001b;
    border: 3px solid #ffd700;
    color: white;
    padding: 14px;
    font-size: 18px;
    border-radius: 12px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
}

.level-btn:hover {
    background: #d10723;
}

.note-info {
    margin-top: 25px;
    font-size: 14px;
    opacity: 0.8;
}

/* ===== GAME AREA ===== */
#game-area {
    display: none;
    text-align: center;
    margin-top: 10px;
}

#hud {
    display: flex;
    justify-content: space-between;
    padding: 0 20px;
    font-size: 18px;
    margin-bottom: 10px;
}

.hud-item {
    background: #b3001b;
    padding: 6px 10px;
    border: 2px solid #ffd700;
    border-radius: 8px;
}

/* ===== CANVAS ===== */
#game-canvas {
    background: #300208;
    border: 4px solid #ffd700;
    border-radius: 10px;
}

/* ===== GAME OVER ===== */
#gameover-screen {
    display: none;
    text-align: center;
    padding-top: 40px;
}

#gameover-screen h2 {
    font-size: 28px;
    color: #ffd700;
}

#final-score {
    font-weight: bold;
    color: #ffd700;
}

.nickname-box {
    margin: 20px 0;
}

.nickname-box input {
    padding: 10px;
    width: 70%;
    font-size: 18px;
    border-radius: 10px;
    border: none;
}

.nickname-box button,
#restart-btn,
#top10-btn {
    background: #b3001b;
    border: 3px solid #ffd700;
    padding: 10px 16px;
    border-radius: 10px;
    color: white;
    font-weight: bold;
    cursor: pointer;
}

/* ===== TOP 10 ===== */
#top10-screen {
    display: none;
    text-align: center;
    padding-top: 40px;
}

#top10-screen h2 {
    font-size: 28px;
    color: #ffd700;
}

#classifica {
    text-align: left;
    width: 260px;
    margin: 0 auto;
    font-size: 20px;
}

#back-btn {
    margin-top: 20px;
    background: #b3001b;
    padding: 12px 18px;
    border: 3px solid #ffd700;
    border-radius: 10px;
    color: white;
    cursor: pointer;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 450px) {
    #game-canvas {
        width: 90vw;
        height: 140vw;
    }
}

</style>
</head>

<body>

<!-- ===== START SCREEN ===== -->
<div id="start-screen">
    <h1 class="titolo">üéπ Giorno 12 ‚Äì Piano Tiles di Natale</h1>
    <p class="sottotitolo">Scegli la difficolt√†:</p>

    <div class="btn-container">
        <button class="level-btn" data-level="easy">FACILE</button>
        <button class="level-btn" data-level="medium">MEDIO</button>
        <button class="level-btn" data-level="hard">DIFFICILE</button>
        <button class="level-btn" data-level="ultra">EXTRA VELOCE</button>
    </div>

    <p class="note-info">Sincronizzato con Castle on the Hill ‚Äì Ed Sheeran</p>
</div>

<!-- ===== GAME AREA ===== -->
<div id="game-area">
    <div id="hud">
        <div class="hud-item">‚ù§Ô∏è Vite: <span id="vite">3</span></div>
        <div class="hud-item">‚è≥ Tempo: <span id="timer">30</span>s</div>
        <div class="hud-item">üéØ Punti: <span id="punti">0</span></div>
    </div>

    <canvas id="game-canvas" width="360" height="600"></canvas>
</div>

<!-- ===== GAME OVER ===== -->
<div id="gameover-screen">
    <h2>GAME OVER</h2>
    <p>Punteggio: <span id="final-score">0</span></p>

    <div class="nickname-box">
        <input type="text" id="nickname" placeholder="Inserisci il tuo nome">
        <button id="save-score">Salva Punteggio</button>
    </div>

    <button id="restart-btn">Ricomincia</button>
    <button id="top10-btn">Vedi Top 10</button>
</div>

<!-- ===== TOP 10 ===== -->
<div id="top10-screen">
    <h2>üèÜ Top 10</h2>
    <ol id="classifica"></ol>
    <button id="back-btn">Indietro</button>
</div>

<!-- AUDIO -->
<audio id="song" preload="auto">
    <source src="audio/canzone.mp3" type="audio/mpeg">
</audio>

<!-- ===== JAVASCRIPT START ===== -->
<script>







/* ================================
   FIREBASE CONFIG
================================ */
const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "XXX",
    appId: "XXX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================================
   VARIABILI PRINCIPALI
================================ */
let canvas = document.getElementById("game-canvas");
let ctx = canvas.getContext("2d");

let colonne = 3;
let tiles = [];
let tileWidth = canvas.width / colonne;
let tileHeight = 160;

let vite = 3;
let punti = 0;
let tempo = 30;
let livelloSelezionato = null;
let isGameRunning = false;

let beatmap = [];       // Viene caricata dal livello scelto
let beatIndex = 0;      // Evento corrente
let startTime = null;   // Per sincronizzare la musica
let song = document.getElementById("song");

let fallSpeed = 4;      // Cambia in base al livello
let timerInterval = null;

/* ================================
   MOSTRARE / NASCONDERE SCHERMATE
================================ */
function showScreen(id) {
    document.getElementById("start-screen").style.display = "none";
    document.getElementById("game-area").style.display = "none";
    document.getElementById("gameover-screen").style.display = "none";
    document.getElementById("top10-screen").style.display = "none";

    document.getElementById(id).style.display = "block";
}

/* ================================
   AVVIO DEL GIOCO
================================ */
document.querySelectorAll(".level-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        livelloSelezionato = btn.dataset.level;

        if (livelloSelezionato === "easy") fallSpeed = 4;
        if (livelloSelezionato === "medium") fallSpeed = 5.5;
        if (livelloSelezionato === "hard") fallSpeed = 7;
        if (livelloSelezionato === "ultra") fallSpeed = 9;

        caricaBeatmap(livelloSelezionato);

        startGame();
    });
});

function startGame() {
    vite = 3;
    punti = 0;
    tempo = 30;
    beatIndex = 0;
    tiles = [];
    startTime = null;

    document.getElementById("vite").textContent = vite;
    document.getElementById("punti").textContent = punti;
    document.getElementById("timer").textContent = tempo;

    showScreen("game-area");

    song.currentTime = 0;
    song.play();

    timerInterval = setInterval(() => {
        tempo--;
        document.getElementById("timer").textContent = tempo;
        if (tempo <= 0) endGame();
    }, 1000);

    isGameRunning = true;
    requestAnimationFrame(update);
}

/* ================================
   CREA UNA NUOVA TILE
================================ */
function creaTile(col) {
    tiles.push({
        x: col * tileWidth,
        y: -tileHeight,
        tapped: false
    });
}

/* ================================
   UPDATE PRINCIPALE
================================ */
function update(timestamp) {

    if (!startTime) startTime = timestamp;
    let elapsed = (timestamp - startTime) / 1000; // in secondi

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    /* EVENTI DELLA BEATMAP BASATI SUL TEMPO */
    while (beatIndex < beatmap.length && beatmap[beatIndex].time <= elapsed) {
        createBeatEvent(beatmap[beatIndex]);
        beatIndex++;
    }

    /* DISEGNARE LE TILE */
    for (let i = 0; i < tiles.length; i++) {
        let t = tiles[i];
        t.y += fallSpeed;

        // Disegno piastrella rosso/oro
        ctx.fillStyle = "#b3001b";
        ctx.fillRect(t.x, t.y, tileWidth, tileHeight);

        ctx.strokeStyle = "#ffd700";
        ctx.lineWidth = 4;
        ctx.strokeRect(t.x, t.y, tileWidth, tileHeight);

        // TOCCO A TERRA NON TAPPATO ‚Üí PERDI VITA
        if (!t.tapped && t.y > canvas.height) {
            vite--;
            document.getElementById("vite").textContent = vite;
            tiles.splice(i, 1);
            i--;

            if (vite <= 0) {
                endGame();
                return;
            }
        }
    }

    if (isGameRunning) requestAnimationFrame(update);
}

/* ================================
   CREAZIONE DI EVENTI DELLA BEATMAP
================================ */
function createBeatEvent(evt) {
    for (let col of evt.cols) {
        creaTile(col);
    }
}

/* ================================
   TAP SULLE TILE
================================ */
canvas.addEventListener("click", (e) => {

    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e.clientY - rect.top;

    for (let i = 0; i < tiles.length; i++) {
        let t = tiles[i];

        if (!t.tapped &&
            x >= t.x && x <= t.x + tileWidth &&
            y >= t.y && y <= t.y + tileHeight) {

            t.tapped = true;
            punti++;
            document.getElementById("punti").textContent = punti;

            tiles.splice(i, 1);
            break;
        }
    }
});

/* ================================
   FINE DEL GIOCO
================================ */
function endGame() {
    isGameRunning = false;
    song.pause();
    clearInterval(timerInterval);

    document.getElementById("final-score").textContent = punti;

    showScreen("gameover-screen");
}

/* ================================
   SALVATAGGIO IN FIREBASE
================================ */
document.getElementById("save-score").addEventListener("click", () => {
    let name = document.getElementById("nickname").value.trim();
    if (name === "") return;

    db.ref("giorno12").push({
        nickname: name,
        punti: punti
    });

    alert("Punteggio salvato!");
});

/* ================================
   MOSTRARE TOP 10
================================ */
document.getElementById("top10-btn").addEventListener("click", () => {
    showScreen("top10-screen");

    db.ref("giorno12")
        .orderByChild("punti")
        .limitToLast(10)
        .once("value", snap => {
            let arr = [];
            snap.forEach(s => arr.push(s.val()));
            arr.reverse();

            let lista = document.getElementById("classifica");
            lista.innerHTML = "";

            arr.forEach(p => {
                let li = document.createElement("li");
                li.textContent = p.nickname + " ‚Äî " + p.punti;
                lista.appendChild(li);
            });
        });
});

document.getElementById("back-btn").addEventListener("click", () => {
    showScreen("gameover-screen");
});

/* ================================
   RICOMINCIA
================================ */
document.getElementById("restart-btn").addEventListener("click", () => {
    location.reload();
});

/* ================================
   FUNZIONE CHE CARICA LA BEATMAP
   (LE BEATMAP ARRIVERANNO NELLE PROSSIME PARTI)
================================ */
function caricaBeatmap(level) {
    if (level === "easy") beatmap = beatmap_easy;
    if (level === "medium") beatmap = beatmap_medium;
    if (level === "hard") beatmap = beatmap_hard;
    if (level === "ultra") beatmap = beatmap_ultra;
}








/* ==========================================
      BEATMAP FACILE ‚Äì alternato morbido
      (1 tile per beat, nessun doppio)
========================================== */

let beatmap_easy = [];

/* Funzione generica per costruire pattern */
function aggiungiAlternato(inizio, fine, bpm) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let seq = [0,1,2,1]; // colonne: 1‚Üí2‚Üí3‚Üí2 (0-based)

    let index = 0;

    while (t <= fine) {
        beatmap_easy.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });

        t += beatTime;
        index = (index + 1) % seq.length;
    }
}

/* ============ STRUTTURA CANZONE ============ */
/*
Castle on the Hill ‚Äì schema approssimato:
0:00 ‚Äì 0:15  intro
0:15 ‚Äì 0:45  strofa 1
0:45 ‚Äì 1:15  pre-chorus
1:15 ‚Äì 1:45  ritornello
1:45 ‚Äì 2:15  strofa 2
2:15 ‚Äì 2:45  pre-chorus
2:45 ‚Äì 3:15  ritornello
3:15 ‚Äì 3:45  bridge
3:45 ‚Äì 4:00  ritornello finale
*/

let BPM_easy = 135;

/* Intro */
aggiungiAlternato(0.00, 15.00, BPM_easy);

/* Strofa 1 */
aggiungiAlternato(15.00, 45.00, BPM_easy);

/* Pre-chorus */
aggiungiAlternato(45.00, 75.00, BPM_easy);

/* Ritornello 1 */
aggiungiAlternato(75.00, 105.00, BPM_easy);

/* Strofa 2 */
aggiungiAlternato(105.00, 135.00, BPM_easy);

/* Pre-chorus 2 */
aggiungiAlternato(135.00, 165.00, BPM_easy);

/* Ritornello 2 */
aggiungiAlternato(165.00, 195.00, BPM_easy);

/* Bridge */
aggiungiAlternato(195.00, 225.00, BPM_easy);

/* Ritornello finale */
aggiungiAlternato(225.00, 240.00, BPM_easy);







/* ==========================================
      BEATMAP MEDIO ‚Äì dinamico 1‚Äì2 per beat
========================================== */

let beatmap_medium = [];

/* Pattern generator BASE (una tile) */
function aggiungiSingolo(inizio, fine, bpm, seq=[0,1,2,1]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_medium.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });

        t += beatTime;
        index = (index + 1) % seq.length;
    }
}

/* Pattern generator con DOPPI */
function aggiungiDoppio(inizio, fine, bpm, seq=[[0,1],[1,2],[2,1],[1,0]]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_medium.push({
            time: parseFloat(t.toFixed(3)),
            cols: seq[index]
        });

        t += beatTime;
        index = (index + 1) % seq.length;
    }
}

/* ====== STRUTTURA CANZONE MEDIUM ====== */

let BPM_med = 135;

/* INTRO ‚Äî solo singoli */
aggiungiSingolo(0.00, 15.00, BPM_med);

/* STROFA 1 ‚Äî singolo con qualche doppio leggero */
aggiungiSingolo(15.00, 30.00, BPM_med);
aggiungiDoppio(30.00, 45.00, BPM_med);

/* PRE-CHORUS ‚Äî aumenta ritmo, mix singoli + doppi */
aggiungiDoppio(45.00, 60.00, BPM_med);
aggiungiSingolo(60.00, 75.00, BPM_med);

/* RITORNELLO 1 ‚Äî parte pi√π dinamica */
aggiungiDoppio(75.00, 90.00, BPM_med);
aggiungiSingolo(90.00, 105.00, BPM_med);

/* STROFA 2 ‚Äî ritorna pi√π leggero */
aggiungiSingolo(105.00, 120.00, BPM_med);
aggiungiDoppio(120.00, 135.00, BPM_med);

/* PRE-CHORUS 2 ‚Äî di nuovo ritmo crescente */
aggiungiDoppio(135.00, 150.00, BPM_med);
aggiungiSingolo(150.00, 165.00, BPM_med);

/* RITORNELLO 2 ‚Äî sezione forte */
aggiungiDoppio(165.00, 180.00, BPM_med);
aggiungiSingolo(180.00, 195.00, BPM_med);

/* BRIDGE ‚Äî rilassamento */
aggiungiSingolo(195.00, 210.00, BPM_med);
aggiungiDoppio(210.00, 225.00, BPM_med);

/* RITORNELLO FINALE */
aggiungiDoppio(225.00, 240.00, BPM_med);






/* ==========================================
      BEATMAP DIFFICILE ‚Äì stile Magic Tiles Hard
      1‚Äì2‚Äì3 tiles per beat, tripli nei ritornelli
========================================== */

let beatmap_hard = [];

/* === GENERATORI DI PATTERN === */

/* Pattern singolo veloce */
function hardSingolo(inizio, fine, bpm, seq=[0,2,1,2]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_hard.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Pattern doppi energici */
function hardDoppio(inizio, fine, bpm, seq=[[0,1],[1,2],[2,1],[1,0]]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_hard.push({
            time: parseFloat(t.toFixed(3)),
            cols: seq[index]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Pattern triplo per ritornelli (hard mode) */
function hardTriplo(inizio, fine, bpm) {
    let beatTime = 60 / bpm;
    let t = inizio;

    while (t <= fine) {
        beatmap_hard.push({
            time: parseFloat(t.toFixed(3)),
            cols: [0,1,2]   // tutte e 3 le colonne
        });
        t += beatTime;
    }
}

/* === STRUTTURA CANZONE HARD === */

let BPM_hard = 135;

/* INTRO ‚Äì singolo tecnico */
hardSingolo(0.00, 15.00, BPM_hard);

/* STROFA 1 ‚Äì singolo + qualche doppio */
hardSingolo(15.00, 30.00, BPM_hard);
hardDoppio(30.00, 45.00, BPM_hard);

/* PRE-CHORUS ‚Äì ritmo aumenta (doppi continui) */
hardDoppio(45.00, 60.00, BPM_hard);

/* RITORNELLO 1 ‚Äì TRIPLI !!! */
hardTriplo(60.00, 75.00, BPM_hard);

/* RITORNO A SINGOLI/DOPPI */
hardSingolo(75.00, 90.00, BPM_hard);
hardDoppio(90.00, 105.00, BPM_hard);

/* STROFA 2 ‚Äì stessa logica */
hardSingolo(105.00, 120.00, BPM_hard);
hardDoppio(120.00, 135.00, BPM_hard);

/* PRE-CHORUS 2 ‚Äì doppi veloci */
hardDoppio(135.00, 150.00, BPM_hard);

/* RITORNELLO 2 ‚Äì TRIPLI intensi */
hardTriplo(150.00, 165.00, BPM_hard);

/* MID-RITORNELLO ‚Äì mix triplo + doppio */
hardDoppio(165.00, 180.00, BPM_hard);
hardTriplo(180.00, 195.00, BPM_hard);

/* BRIDGE ‚Äì singolo rilassato */
hardSingolo(195.00, 210.00, BPM_hard);

/* BUILD-UP ‚Äì doppi crescenti */
hardDoppio(210.00, 225.00, BPM_hard);

/* RITORNELLO FINALE ‚Äì TRIPLI FULL POWER */
hardTriplo(225.00, 240.00, BPM_hard);



/* ==========================================
      BEATMAP ULTRA ‚Äì EXPERT MODE
      1‚Äì2‚Äì3 tiles, eventi ogni 1/2 beat
========================================== */

let beatmap_ultra = [];

/* === GENERATORI ULTRA === */

/* Singolo molto rapido (1 per beat) */
function ultraSingolo(inizio, fine, bpm, seq=[0,2,1,2,0,1]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_ultra.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Singolo doppio (1 ogni 1/2 beat) */
function ultraMezzoBeat(inizio, fine, bpm, seq=[0,1,2,1,0,2]) {
    let beatTime = 60 / bpm / 2;  // mezzo beat
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_ultra.push({
            time: parseFloat(t.toFixed(3)),
            cols: [seq[index]]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Doppi rapidi */
function ultraDoppio(inizio, fine, bpm, seq=[[0,1],[1,2],[2,1],[1,0]]) {
    let beatTime = 60 / bpm;
    let t = inizio;
    let index = 0;

    while (t <= fine) {
        beatmap_ultra.push({
            time: parseFloat(t.toFixed(3)),
            cols: seq[index]
        });
        index = (index + 1) % seq.length;
        t += beatTime;
    }
}

/* Tripli (usati nei ritornelli) */
function ultraTriplo(inizio, fine, bpm) {
    let beatTime = 60 / bpm / 1.5; // leggermente pi√π frequente
    let t = inizio;

    while (t <= fine) {
        beatmap_ultra.push({
            time: parseFloat(t.toFixed(3)),
            cols: [0,1,2]
        });
        t += beatTime;
    }
}

/* ==========================================
   STRUTTURA CANZONE ‚Äî LIVELLO ULTRA
========================================== */

let BPM_ultra = 135;

/* INTRO ‚Äî Mezzo beat gi√† subito */
ultraMezzoBeat(0.00, 15.00, BPM_ultra);

/* STROFA 1 ‚Äî alternanza veloce */
ultraSingolo(15.00, 30.00, BPM_ultra);
ultraDoppio(30.00, 45.00, BPM_ultra);

/* PRE-CHORUS ‚Äî mezzo beat */
ultraMezzoBeat(45.00, 60.00, BPM_ultra);

/* RITORNELLO 1 ‚Äî TRIPLO + MEZZO BEAT */
ultraTriplo(60.00, 75.00, BPM_ultra);

/* SEZIONE MIXATA */
ultraDoppio(75.00, 90.00, BPM_ultra);
ultraMezzoBeat(90.00, 105.00, BPM_ultra);

/* STROFA 2 ‚Äî singoli veloci */
ultraSingolo(105.00, 120.00, BPM_ultra);
ultraDoppio(120.00, 135.00, BPM_ultra);

/* PRE-CHORUS 2 ‚Äî mezzo beat pieno */
ultraMezzoBeat(135.00, 150.00, BPM_ultra);

/* RITORNELLO 2 ‚Äî TRIPLI HARD */
ultraTriplo(150.00, 165.00, BPM_ultra);

/* MID SECTION ‚Äî combinazioni */
ultraDoppio(165.00, 180.00, BPM_ultra);
ultraMezzoBeat(180.00, 195.00, BPM_ultra);

/* BRIDGE ‚Äî ritmo rallenta un attimo */
ultraSingolo(195.00, 210.00, BPM_ultra);

/* BUILD-UP ‚Äî mezzo beat intenso */
ultraMezzoBeat(210.00, 225.00, BPM_ultra);

/* RITORNELLO FINALE ‚Äî TRIPLO CONTINUO */
ultraTriplo(225.00, 240.00, BPM_ultra);



</script>
</body>
</html>
