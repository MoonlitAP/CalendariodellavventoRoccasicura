<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéπ Giorno 12 ‚Äì Piano Tiles Evolution</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
/* ============================================
   SFONDO GENERALE
============================================ */
body {
  margin: 0;
  padding: 0;
  font-family: "Ubuntu", sans-serif;
  color: #fff;
  text-align: center;
  background: #7b0412 url("img/piano_roccasicura.jpg") center/cover no-repeat fixed;
  background-blend-mode: darken;
  overflow-x: hidden;
}

/* ============================================
   TITOLO
============================================ */
h1 {
  margin-top: 12px;
  color: #ffd700;
  text-shadow: 2px 2px 4px #000;
  font-size: 1.9em;
}

/* ============================================
   PANNELLO CENTRALE
============================================ */
.panel-box {
  width: 90%;
  max-width: 420px;
  margin: 20px auto;
  background: #fffaf2;
  border: 2px solid #ffd700;
  border-radius: 20px;
  padding: 25px;
  color: #400000;
  box-shadow: 0 0 25px #000;
}

/* BOTTONI */
.btn {
  width: 80%;
  padding: 14px;
  margin-top: 12px;
  font-size: 1.1em;
  border: none;
  border-radius: 30px;
  background: #7b0412;
  color: white;
  cursor: pointer;
  font-weight: bold;
}
.btn:hover { background: #ffd700; color: #000; }

/* ============================================
   CANVAS
============================================ */
canvas {
  display: none;
  margin: 20px auto;
  background: rgba(0,0,0,0.45);
  border: 3px solid #ffd700;
  border-radius: 15px;
  box-shadow: 0 0 20px #000;
}

/* ============================================
   INFO BOTTOM BAR
============================================ */
#info {
  display: none;
  width: 100%;
  padding: 10px 0;
  font-size: 1.2em;
  background: rgba(0,0,0,0.55);
  border-top: 1px solid #ffd700;
  position: fixed;
  bottom: 0;
  left: 0;
  z-index: 50;
}

/* ============================================
   AUDIO UNLOCK BOX
============================================ */
#unlock-box {
  display: none;
}

/* ============================================
   COUNTDOWN
============================================ */
#countdown {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 120px;
  color: #ffd700;
  text-shadow: 0 0 30px #fff;
  font-weight: bold;
  display: none;
  z-index: 3000;
}

@keyframes pulse {
  0% { transform: translate(-50%,-50%) scale(.3); opacity: 0; }
  40% { transform: translate(-50%,-50%) scale(1.4); opacity: 1; }
  100% { transform: translate(-50%,-50%) scale(1); opacity: 0; }
}

/* ============================================
   FINE ‚Äì CLASSIFICA BOX
============================================ */
#fine {
  display: none;
}

.score-box {
  width: 90%;
  max-width: 500px;
  background: #fffaf2;
  color: #400000;
  padding: 30px;
  border-radius: 20px;
  border: 2px solid #ffd700;
  box-shadow: 0 0 25px #000;
  margin: 40px auto;
}

table {
  width: 100%;
  margin-top: 15px;
}

th, td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #d7bb5f;
}

.btn-small {
  padding: 12px 25px;
  margin-top: 20px;
  border-radius: 30px;
  background: #b30d0d;
  color: #fff;
  cursor: pointer;
  font-weight: bold;
  border: none;
}
.btn-small:hover {
  background: #ffd700;
  color: #000;
}
</style>
</head>

<body>

<h1>üéπ Giorno 12 ‚Äì Piano Tiles Evolution</h1>

<!-- ============================================
     START PANEL
============================================ -->
<div id="panel" class="panel-box">
  <h2>‚ú® Come si gioca ‚ú®</h2>
  <p>
    üéº Tocca le piastrelle d‚Äôoro al ritmo della musica<br>
    ‚ù§Ô∏è Hai 3 vite ‚Äì perdi 1 se una tile cade<br>
    ‚ö° Difficolt√† crescente automatica<br>
    üéµ La musica accelera fino a 1.20√ó
  </p>

  <button id="btn-start" class="btn">‚ñ∂Ô∏è INIZIA</button>
  <button id="btn-top10" class="btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
</div>

<!-- ============================================
     AUDIO UNLOCK PANEL
============================================ -->
<div id="unlock-box" class="panel-box">
  <h2>üéµ Attiva la musica</h2>
  <p>Tocca il pulsante per permettere al gioco di riprodurre l‚Äôaudio.</p>
  <button id="unlock-btn" class="btn" style="background:#ffd700; color:#400000;">TOCCA PER ATTIVARE</button>
</div>

<!-- COUNTDOWN -->
<div id="countdown"></div>

<!-- CANVAS -->
<canvas id="game"></canvas>
<div id="info"></div>

<!-- ============================================
     POPUP FINALE
============================================ -->
<div id="fine" class="score-box">
  <h2 id="fine-msg"></h2>
  <h3>üèÜ Top 10 ‚Äì Piano Tiles Evolution</h3>

  <table id="score-table">
    <tr><th>Nome</th><th>Punti</th></tr>
  </table>

  <button class="btn-small" onclick="location.reload()">üîÑ Riprova</button>
  <a href="../calendario.html" class="btn-small">‚¨Ö Calendario</a>
</div>

<!-- AUDIO -->
<audio id="song" preload="auto">
  <source src="audio/piano.mp3" type="audio/mpeg">
</audio>


<!-- ============================================
     JAVASCRIPT (la tua logica originale)
============================================ -->
<script>
/* ========= FIREBASE ========= */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura",
  storageBucket: "calendarioroccasicura.appspot.com",
  messagingSenderId: "38731898044",
  appId: "1:38731898044:web:e89bcfae7c64239fec44b9"
});
const db = firebase.database();

/* ========= VARIABILI ========= */
const song = document.getElementById("song");
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");

let tiles = [];
let speed = 4;
let score = 0;
let lives = 3;
let playing = false;
let startTime;

const real = localStorage.getItem("utente") || "Ospite";
const user = real[0] + Math.floor(Math.random()*900+100) + real.slice(1);

/* ========= START BUTTON ========= */
document.getElementById("btn-start").onclick = ()=>{
  document.getElementById("panel").style.display = "none";
  document.getElementById("unlock-box").style.display = "block";
};

/* ========= AUDIO UNLOCK ========= */
document.getElementById("unlock-btn").onclick = async ()=>{
  try {
    await song.play();
    song.pause();
    song.currentTime = 0;
    document.getElementById("unlock-box").style.display = "none";
    startCountdown(startGame);
  } catch {
    alert("Tocca di nuovo");
  }
};

/* ========= COUNTDOWN ========= */
function startCountdown(cb){
  const cd = document.getElementById("countdown");
  const seq = ["3","2","1","VIA!"];
  let i = 0;

  function next(){
    if(i >= seq.length){
      cd.style.display = "none";
      cb();
      return;
    }
    cd.innerHTML = seq[i++];
    cd.style.display = "block";
    cd.style.animation = "pulse .8s";
    setTimeout(next,900);
  }
  next();
}

/* ========= GAME START ========= */
function startGame(){
  canvas.style.display = "block";
  info.style.display = "block";
  song.play();
  startTime = performance.now();
  playing = true;
  requestAnimationFrame(update);
}

/* ========= TILE HANDLING ========= */
canvas.onclick = e => handleInput(e.clientX);
canvas.ontouchstart = e => {
  e.preventDefault();
  if(e.touches.length > 0) handleInput(e.touches[0].clientX);
};

function handleInput(x){
  const r = canvas.getBoundingClientRect();
  const col = Math.floor((x - r.left) / (canvas.width/3));

  for(let t of tiles){
    if(!t.hit && t.col === col && t.y > canvas.height-180 && t.y < canvas.height){
      t.hit = true;
      score += 10;
      return;
    }
  }
}

/* ========= UPDATE LOOP ========= */
function update(ts){
  if(!playing) return;
  if(ts - startTime > 240000) return endGame();

  if(Math.random() < .02) spawnTile();
  speed = 4 + (ts - startTime)/60000;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  const w = canvas.width/3;

  tiles.forEach(t=>{
    t.y += speed;
    if(!t.hit && t.y > canvas.height){
      lives--;
      t.hit = true;
      if(lives <= 0) endGame();
    }
    ctx.fillStyle = "#ffd700";
    ctx.fillRect(t.col*w+8, t.y, w-16, 120);
  });

  tiles = tiles.filter(t=>t.y < canvas.height+200);
  info.textContent = `‚≠ê ${score} | ‚ù§Ô∏è ${lives}`;

  requestAnimationFrame(update);
}

function spawnTile(){
  const col = Math.floor(Math.random()*3);
  tiles.push({ col, y:-120, hit:false });
}

/* ========= END GAME ========= */
function endGame(){
  playing = false;
  song.pause();

  document.getElementById("fine").style.display = "block";
  document.getElementById("fine-msg").innerHTML =
    `‚≠ê Hai ottenuto <b>${score}</b> punti`;

  db.ref("punteggi/giorno12").push({
    nome: user,
    punti: score,
    timestamp: Date.now()
  }).then(loadTop10);
}

/* ========= CLASSIFICA ========= */
function loadTop10(){
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno12")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap=>{
      let list = [];
      snap.forEach(c=>list.push(c.val()));
      list.sort((a,b)=>b.punti - a.punti);
      list.forEach(r=>{
        let tr=document.createElement("tr");
        tr.innerHTML = `<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

document.getElementById("btn-top10").onclick = ()=>{
  document.getElementById("panel").style.display = "none";
  document.getElementById("fine").style.display = "block";
  loadTop10();
};
</script>

</body>
</html>
