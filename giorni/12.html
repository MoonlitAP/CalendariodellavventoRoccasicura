<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">

<!-- BLOCCO ZOOM iOS / ANDROID -->
<meta name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>üéÖ Giorno 12 ‚Äì Babbo Mario Run</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  font-family:'Ubuntu',sans-serif;
  background:#7b0412;
  color:white;
  text-align:center;
  touch-action:manipulation;
  -webkit-user-select:none;
  user-select:none;
}

h1{color:#ffd700;margin:10px 0;}

canvas{
  display:none;
  margin:10px auto;
  border:3px solid #ffd700;
  border-radius:14px;
  background:#000;
}

#panel{
  background:#fffaf0;
  color:#400;
  border-radius:16px;
  border:2px solid #ffd700;
  margin:20px;
  padding:20px;
}

button{
  padding:14px 30px;
  border-radius:30px;
  border:none;
  font-size:18px;
  background:#7b0412;
  color:white;
  cursor:pointer;
}
button:hover{background:#ffd700;color:#000;}

#info{
  display:none;
  position:fixed;
  bottom:0;
  width:100%;
  background:rgba(0,0,0,.6);
  padding:8px;
  font-size:18px;
}

#fine{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.box{
  background:#fffaf0;
  color:#400;
  border-radius:20px;
  padding:25px;
  width:90%;
  max-width:500px;
  border:2px solid #ffd700;
}

table{
  width:100%;
  margin-top:15px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #d7bb5f;
}
</style>
</head>

<body>

<h1>üéÖ Babbo Mario Run!</h1>

<div id="panel">
  <p>
    üëÜ Tocca / clicca per saltare<br>
    ‚å®Ô∏è SPACE da PC<br>
    üöó Gli ostacoli NON fanno morire<br>
    ‚≠ê Prendi stelle (+5)<br>
    üéØ Arriva al Paese!
  </p>
  <button id="start">‚ñ∂Ô∏è INIZIA</button>
</div>

<canvas id="game"></canvas>
<div id="info"></div>

<div id="fine">
  <div class="box">
    <h2 id="finalMsg"></h2>
    <h3>üèÜ Classifica Giorno 11</h3>
    <table id="classifica">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>
    <br>
    <button onclick="location.reload()">üîÑ Riprova</button>
  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app"
});
const db = firebase.database();

/* CANVAS */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth < 700 ? window.innerWidth-20 : 900;
canvas.height = 420;

/* IMMAGINI */
const bgBosco = new Image(); bgBosco.src = "img/bosco.jpg";
const bgPaese = new Image(); bgPaese.src = "img/paese.jpg";
const mario = new Image(); mario.src = "img/babbo_mario.png";
const star  = new Image(); star.src  = "img/stella.png";
const car1  = new Image(); car1.src  = "img/car1.png";
const car2  = new Image(); car2.src  = "img/car2.png";

/* STATO */
let y = 300, vy = 0, onGround = true;
let obstacles = [];
let stars = [];
let score = 0;
let playing = false;
let scroll = 0;
let speed = 5;
let hitTimer = 0;
const levelLength = 6000;

/* NEVE */
let snowflakes = [];
for(let i=0;i<80;i++){
  snowflakes.push({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    r: Math.random()*2+1,
    s: Math.random()*0.5+0.3
  });
}

function drawSnow(){
  ctx.fillStyle = "rgba(255,255,255,0.85)";
  snowflakes.forEach(f=>{
    ctx.beginPath();
    ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
    ctx.fill();
    f.y += f.s;
    if(f.y > canvas.height){
      f.y = -5;
      f.x = Math.random()*canvas.width;
    }
  });
}

/* INPUT */
canvas.addEventListener("click", jump);
document.addEventListener("keydown", e=>{
  if(e.code === "Space") jump();
});

function jump(){
  if(onGround){
    vy = -14;
    onGround = false;
  }
}

/* SPAWN */
function spawnObstacle(){
  const img = Math.random()>0.5 ? car1 : car2;
  obstacles.push({ x: canvas.width, img });
}

function spawnStar(){
  stars.push({ x: canvas.width, y: 220 });
}

/* GAME LOOP */
function update(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* SFONDO BOSCO */
  ctx.drawImage(bgBosco, -scroll*0.4, 0, canvas.width*2, canvas.height);

  /* TRANSIZIONE PAESE */
  if(scroll > levelLength - 800){
    ctx.globalAlpha = (scroll - (levelLength - 800)) / 800;
    ctx.drawImage(bgPaese, 0, 0, canvas.width, canvas.height);
    ctx.globalAlpha = 1;
  }

  /* FISICA */
  vy += 0.8;
  y += vy;
  if(y > 300){ y=300; vy=0; onGround=true; }

  ctx.drawImage(mario,80,y,70,70);

  /* VELOCIT√Ä + RALLENTAMENTO */
  if(hitTimer > 0){
    speed = 2;
    hitTimer--;
  }else{
    speed = 5;
  }

  /* OSTACOLI */
  obstacles.forEach(o=>{
    o.x -= speed;
    ctx.drawImage(o.img,o.x,300,70,50);
    if(
      o.x < 130 &&
      o.x + 60 > 80 &&
      y + 60 > 300 &&
      hitTimer === 0
    ){
      hitTimer = 40;
      score = Math.max(0, score - 5);
    }
  });

  /* STELLE */
  stars.forEach(s=>{
    s.x -= speed;
    ctx.drawImage(star,s.x,s.y,40,40);
    if(s.x < 120 && s.x+40 > 80 && y < s.y+40){
      score += 5;
      s.hit = true;
    }
  });

  obstacles = obstacles.filter(o=>o.x>-120);
  stars = stars.filter(s=>!s.hit && s.x>-50);

  /* NEVE PI√ô FORTE VICINO ALLA FINE */
  if(scroll > levelLength - 1200){
    snowflakes.forEach(f=>f.s = Math.min(2, f.s + 0.01));
  }
  drawSnow();

  document.getElementById("info").textContent = `‚≠ê ${score}`;

  scroll += speed;
  if(scroll >= levelLength){
    endGame();
    return;
  }

  if(playing) requestAnimationFrame(update);
}

/* START */
document.getElementById("start").onclick=()=>{
  document.getElementById("panel").style.display="none";
  canvas.style.display="block";
  document.getElementById("info").style.display="block";
  playing = true;

  setInterval(()=>playing&&spawnObstacle(),1600);
  setInterval(()=>playing&&spawnStar(),2200);

  update();
};

/* FINE */
function endGame(){
  playing = false;
  canvas.style.display="none";
  document.getElementById("info").style.display="none";
  document.getElementById("fine").style.display="flex";

  document.getElementById("finalMsg").innerHTML =
    "üéâ Sei arrivato al paese! Il Natale √® casa.";

  db.ref("punteggi/giorno11").push({
    nome:"Giocatore",
    punti:score,
    time:Date.now()
  });

  db.ref("punteggi/giorno11")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value",snap=>{
      let rows="<tr><th>Nome</th><th>Punti</th></tr>";
      let arr=[];
      snap.forEach(s=>arr.push(s.val()));
      arr.reverse().forEach(r=>{
        rows+=`<tr><td>${r.nome}</td><td>${r.punti}</td></tr>`;
      });
      document.getElementById("classifica").innerHTML = rows;
    });
}
</script>

</body>
</html>

