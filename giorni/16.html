<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üê∞ Bunny Garden Run</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { 
    --grass: #66bb6a; 
    --path: #efebe9; 
    --wood: #795548;
    --sky: #e3f2fd;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; font-family: 'Ubuntu', sans-serif; background: var(--sky); 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    height: 100vh; overflow: hidden;
  }

  /* Sfondo Giardino */
  #garden-map {
    position: relative; width: 95vmin; height: 85vmin; max-width: 500px;
    background: var(--grass); border: 12px solid #4caf50; border-radius: 40px;
    box-shadow: 0 15px 0 #2e7d32, inset 0 0 100px rgba(0,0,0,0.1);
    display: flex; align-items: center; justify-content: center;
  }

  /* Decorazioni Fiori */
  .flower { position: absolute; font-size: 20px; z-index: 1; opacity: 0.8; }

  /* Caselle come pietre */
  .stone { 
    width: 34px; height: 34px; background: var(--path); border-radius: 50%; position: absolute; 
    display: flex; align-items: center; justify-content: center; font-size: 12px; 
    font-weight: bold; color: #5d4037; border-bottom: 4px solid #bcaaa4;
    transform: translate(-50%, -50%); z-index: 2; box-shadow: 0 4px 5px rgba(0,0,0,0.2);
  }
  .hole { background: #333 !important; border: none; box-shadow: inset 0 5px 8px #000; color: transparent !important; }

  /* Casella Premio 0 */
  .prize-box {
    width: 60px; height: 60px; background: #fff176; border: 4px dashed #f9a825;
    border-radius: 15px; position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%); display: flex; flex-direction: column;
    align-items: center; justify-content: center; z-index: 3;
  }
  .carrot-icon { font-size: 30px; line-height: 1; }
  .prize-label { font-size: 10px; font-weight: bold; color: #f57f17; }

  /* Coniglietti */
  .bunny { 
    width: 35px; height: 35px; position: absolute; z-index: 10;
    transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer;
    background-size: contain; background-repeat: no-repeat; background-position: center;
  }
  .p-rabbit { background-image: url('../img/rabbit_1.png'); }
  .c-rabbit { background-image: url('../img/rabbit_2.png'); }
  
  .jump { animation: hop 0.5s infinite alternate; filter: drop-shadow(0 0 8px #fff); }
  @keyframes hop { from { margin-top: 0; } to { margin-top: -12px; } }

  /* Tane (Recinti) */
  .pen { 
    position: absolute; width: 60px; height: 140px; 
    background: #a1887f; border: 4px solid var(--wood); border-radius: 10px;
    display: flex; flex-direction: column; align-items: center; justify-content: space-around;
    padding: 5px; box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
  }
  .p-pen { left: -20px; top: 50%; transform: translateY(-50%); }
  .c-pen { right: -20px; top: 50%; transform: translateY(-50%); }

  /* UI Pannello */
  .ui { width: 90%; max-width: 400px; text-align: center; margin-top: 20px; }
  #info {
    background: white; padding: 12px; border-radius: 20px; border: 3px solid var(--wood);
    font-weight: bold; margin-bottom: 10px; color: #2e7d32;
  }
  .dice-btn {
    padding: 15px 40px; border: none; border-radius: 50px;
    background: #ff9800; color: white; font-size: 18px; font-weight: bold;
    box-shadow: 0 6px 0 #e65100; cursor: pointer;
  }
</style>
</head>
<body>

<div id="garden-map">
  <div class="flower" style="top:10%; left:15%">üå∏</div>
  <div class="flower" style="bottom:10%; right:20%">üåº</div>
  <div class="flower" style="top:20%; right:10%">üåª</div>
  
  <div class="pen p-pen" id="p-base"></div>
  
  <div class="prize-box">
      <div class="prize-label">TRAGUARDO</div>
      <div class="carrot-icon">ü•ï</div>
      <div class="prize-label">0</div>
  </div>

  <div class="pen c-pen" id="c-base"></div>
</div>

<div class="ui">
  <div id="info">Benvenuto nel Giardino! Tira il dado.</div>
  <button id="diceBtn" class="dice-btn" onclick="roll()">üé≤ TIRA IL DADO</button>
</div>

<script>
const garden = document.getElementById("garden-map");
const info = document.getElementById("info");
const diceBtn = document.getElementById("diceBtn");

let turn = "player";
let diceNum = 0;
let state = "wait"; 
const trail = [];
let holes = [25, 17, 9]; 

// Costruzione sentiero dal 30 (esterno) allo 1 (interno)
function buildTrail() {
  for (let i = 0; i < 30; i++) {
    const angle = 0.6 * i; 
    const r = 42 - (i * 1.35); 
    const x = 50 + r * Math.cos(angle);
    const y = 50 + r * Math.sin(angle);
    trail.push({ x: x + "%", y: y + "%" });
  }
}
buildTrail();

function drawGarden() {
  document.querySelectorAll('.stone').forEach(s => s.remove());
  trail.forEach((pos, i) => {
    const num = 30 - i; // Dal 30 all'1
    const s = document.createElement("div");
    s.className = "stone" + (holes.includes(num) ? " hole" : "");
    s.style.left = pos.x; s.style.top = pos.y;
    if (!holes.includes(num)) s.textContent = num;
    garden.appendChild(s);
  });
}
drawGarden();

function shuffleHoles() {
  let h = [];
  while(h.length < 3) {
    let r = Math.floor(Math.random() * 25) + 2;
    if(!h.includes(r)) h.push(r);
  }
  holes = h;
  drawGarden();
}

let bunnies = [];
function setupGame() {
  const pb = document.getElementById("p-base");
  const cb = document.getElementById("c-base");
  for (let i = 0; i < 6; i++) {
    const isP = i < 3;
    const b = document.createElement("div");
    b.className = "bunny " + (isP ? "p-rabbit" : "c-rabbit");
    b.pos = -1; // -1 = Tana
    b.type = isP ? "player" : "cpu";
    b.onclick = () => playerChoice(b);
    isP ? pb.appendChild(b) : cb.appendChild(b);
    bunnies.push(b);
  }
}

function updatePos(b) {
  if (b.pos === -1) {
    const base = b.type === "player" ? document.getElementById("p-base") : document.getElementById("c-base");
    b.style.position = "static"; b.style.transform = "none";
    base.appendChild(b);
  } else {
    b.style.position = "absolute";
    // Usiamo trail[30 - b.pos] perch√© l'indice 0 √® la casella 30
    const index = 30 - b.pos;
    b.style.left = trail[index].x;
    b.style.top = trail[index].y;
    b.style.transform = "translate(-50%, -50%)";
    garden.appendChild(b);
  }
}
setupGame();

function roll() {
  diceNum = Math.floor(Math.random() * 6) + 1;
  diceBtn.disabled = true;
  info.innerHTML = `üé≤ Dado: <b>${diceNum}</b>`;
  if (diceNum === 6) { 
    info.innerHTML = "üé≤ <b>6!</b> Il giardino cambia!";
    shuffleHoles(); 
    setTimeout(startMove, 800);
  } else { startMove(); }
}

function startMove() {
  if (turn === "player") {
    state = "pick";
    bunnies.filter(b => b.type === "player").forEach(b => b.classList.add("jump"));
  } else { setTimeout(cpuAction, 1000); }
}

function playerChoice(b) {
  if (state !== "pick" || b.type !== "player") return;
  bunnies.forEach(x => x.classList.remove("jump"));
  executeMove(b);
}

function executeMove(b) {
  state = "move";
  if (b.pos === -1) b.pos = 31; // Entra in pista
  b.pos -= diceNum; // Sottrae perch√© va verso lo 0

  if (b.pos <= 0) {
    b.pos = 0;
    updatePosPrize(b);
    info.innerHTML = turn === "player" ? "üèÜ HAI PRESO LA CAROTA!" : "ü§ñ CPU HA VINTO";
    setTimeout(() => location.reload(), 4000);
    return;
  }

  updatePos(b);
  if (holes.includes(b.pos)) {
    setTimeout(() => { b.pos = -1; updatePos(b); info.innerHTML = "üåÄ Splash! In tana."; }, 700);
  }
  setTimeout(nextTurn, 1000);
}

function updatePosPrize(b) {
    b.style.position = "absolute";
    b.style.left = "50%"; b.style.top = "50%";
    b.style.transform = "translate(-50%, -50%)";
    garden.appendChild(b);
}

function cpuAction() {
  let targets = bunnies.filter(b => b.type === "cpu");
  let b = targets.sort((a,b) => a.pos - b.pos)[0]; // Sceglie il pi√π vicino allo 0
  executeMove(b);
}

function nextTurn() {
  turn = turn === "player" ? "cpu" : "player";
  state = "wait";
  info.innerHTML = turn === 'player' ? "Tocca a te!" : "ü§ñ CPU sta saltando...";
  diceBtn.disabled = (turn === "cpu");
  if (turn === "cpu") setTimeout(roll, 600);
}
</script>
</body>
</html>
