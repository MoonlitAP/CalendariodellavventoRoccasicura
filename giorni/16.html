<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üê∞ Carrera de Conejos - Premium Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* Variabili Colore e Design */
  :root { 
    --bg-color: #f1f8e9;
    --grass-green: #81c784;
    --grass-border: #4a8c4d;
    --wood-brown: #795548;
    --path-color: #ffffff;
    --shadow: rgba(0, 0, 0, 0.15);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; 
    font-family: 'Ubuntu', sans-serif; 
    background: var(--bg-color); 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    height: 100vh; 
    overflow: hidden;
  }

  /* Area di Gioco Principale */
  #main-wrapper {
    position: relative;
    width: 95vmin;
    height: 95vmin;
    max-width: 600px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Il Tabellone (Il Prato) */
  #board-container {
    width: 82%;
    height: 82%;
    background: var(--grass-green);
    border-radius: 50%;
    position: relative;
    border: 10px solid var(--grass-border);
    box-shadow: 0 15px 0 #2e7d32, inset 0 0 60px rgba(0,0,0,0.2);
    z-index: 2;
  }

  /* Caselle del Percorso */
  .cell { 
    width: 38px; 
    height: 38px; 
    background: var(--path-color); 
    border-radius: 12px; 
    position: absolute; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 14px; 
    font-weight: 700; 
    color: #5d4037; 
    border-bottom: 4px solid #d7ccc8;
    transform: translate(-50%, -50%); 
    transition: transform 0.2s;
    z-index: 5;
    box-shadow: 0 4px 6px var(--shadow);
  }

  /* Buchi Neri */
  .cell.hole { 
    background: #212121 !important; 
    border: none; 
    box-shadow: inset 0 5px 10px #000; 
    color: transparent !important; 
  }

  /* Carota Finale */
  #finish-carrot { 
    width: 40px; 
    height: 40px; 
    position: absolute; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    z-index: 6; 
    pointer-events: none;
    filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3));
  }

  /* Coniglietti */
  .rabbit { 
    width: 34px; 
    height: 34px; 
    position: absolute; 
    z-index: 20;
    transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    cursor: pointer;
    transform: translate(-50%, -50%);
    background-size: contain; 
    background-repeat: no-repeat; 
    background-position: center;
  }
  .player-rabbit { background-image: url('../img/rabbit_1.png'); }
  .cpu-rabbit { background-image: url('../img/rabbit_2.png'); }
  
  /* Animazione Salto */
  .active-jump { 
    animation: bunny-hop 0.5s infinite alternate; 
    filter: drop-shadow(0 0 12px #fff); 
  }
  @keyframes bunny-hop { 
    from { transform: translate(-50%, -50%) scale(1); } 
    to { transform: translate(-50%, -85%) scale(1.15); } 
  }

  /* TANE LATERALI (BASI) */
  .tana { 
    position: absolute; 
    width: 65px; 
    height: 180px; 
    background: var(--wood-brown); 
    border: 5px solid #5d4037; 
    border-radius: 20px;
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: space-around;
    box-shadow: 6px 6px 0 rgba(0,0,0,0.2); 
    z-index: 1;
    padding: 10px 0;
  }
  .tana-player { left: -15px; }
  .tana-cpu { right: -15px; }
  
  .tana-label {
    font-size: 10px;
    color: #efebe9;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Controlli e Messaggi */
  .ui-panel { 
    width: 90%; 
    max-width: 450px; 
    text-align: center; 
    margin-top: 25px; 
    z-index: 10;
  }
  #status-bar {
    background: white; 
    padding: 15px; 
    border-radius: 25px; 
    border: 4px solid var(--wood-brown);
    font-weight: bold; 
    margin-bottom: 15px; 
    color: #2e7d32; 
    font-size: 18px;
    box-shadow: 0 4px 0 var(--shadow);
  }
  .roll-button {
    padding: 18px 55px; 
    border: none; 
    border-radius: 60px;
    background: #ff9800; 
    color: white; 
    font-size: 22px; 
    font-weight: 900;
    box-shadow: 0 8px 0 #e65100; 
    cursor: pointer; 
    transition: 0.1s;
    text-transform: uppercase;
  }
  .roll-button:active { 
    transform: translateY(4px); 
    box-shadow: 0 4px 0 #e65100; 
  }
  .roll-button:disabled {
    background: #bdbdbd;
    box-shadow: 0 8px 0 #9e9e9e;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<div id="main-wrapper">
  <div class="tana tana-player" id="p-base">
    <div class="tana-label">Tu</div>
  </div>
  
  <div id="board-container">
    <img id="finish-carrot" src="https://cdn-icons-png.flaticon.com/512/3014/3014467.png" alt="ü•ï">
    </div>
  
  <div class="tana tana-cpu" id="c-base">
    <div class="tana-label">CPU</div>
  </div>
</div>

<div class="ui-panel">
  <div id="status-bar">Pronto per la sfida? Tira!</div>
  <button id="diceBtn" class="roll-button" onclick="rollDice()">üé≤ Tira il Dado</button>
</div>

<script>
/* --- CONFIGURAZIONE GIOCO --- */
const board = document.getElementById("board-container");
const statusBar = document.getElementById("status-bar");
const diceBtn = document.getElementById("diceBtn");

let currentPlayer = "player";
let diceResult = 0;
let gameState = "waiting"; 
const cellPath = [];
let holePositions = [6, 14, 22]; // Posizioni iniziali buchi

/* --- GENERAZIONE PERCORSO SPIRALE --- */
function createSpiralPath() {
  const totalCells = 30;
  for (let i = 0; i < totalCells; i++) {
    // Matematica per spirale logaritmica distanziata
    const angle = 0.64 * i; 
    const radius = 43 - (i * 1.32); 
    
    const posX = 50 + radius * Math.cos(angle);
    const posY = 50 + radius * Math.sin(angle);
    
    cellPath.push({ x: posX + "%", y: posY + "%" });
  }
}

function renderBoard() {
  // Rimuovi vecchie caselle
  document.querySelectorAll('.cell').forEach(c => c.remove());
  
  cellPath.forEach((pos, index) => {
    const num = index + 1;
    const cellEl = document.createElement("div");
    cellEl.className = "cell" + (holePositions.includes(num) ? " hole" : "");
    cellEl.style.left = pos.x; 
    cellEl.style.top = pos.y;
    
    if (!holePositions.includes(num)) {
      cellEl.textContent = num;
    }
    board.appendChild(cellEl);
  });
}

/* --- LOGICA DEI BUCHI --- */
function moveHoles() {
  let newHoles = [];
  while(newHoles.length < 3) {
    let rand = Math.floor(Math.random() * 27) + 2; // Non mette buchi sull'1 o sul 30
    if(!newHoles.includes(rand)) newHoles.push(rand);
  }
  holePositions = newHoles;
  renderBoard();
}

/* --- GESTIONE CONIGLI --- */
let bunnies = [];
function setupBunnies() {
  const pBase = document.getElementById("p-base");
  const cBase = document.getElementById("c-base");
  
  for (let i = 0; i < 6; i++) {
    const isPlayer = i < 3;
    const b = document.createElement("div");
    b.className = "rabbit " + (isPlayer ? "player-rabbit" : "cpu-rabbit");
    b.dataset.pos = -1; // In tana
    b.id = "bunny-" + i;
    b.dataset.type = isPlayer ? "player" : "cpu";
    
    b.onclick = () => selectBunny(b);
    
    isPlayer ? pBase.appendChild(b) : cBase.appendChild(b);
    bunnies.push(b);
  }
}

function updateBunnyPosition(bunny) {
  const pos = parseInt(bunny.dataset.pos);
  if (pos === -1) {
    const base = bunny.dataset.type === "player" ? document.getElementById("p-base") : document.getElementById("c-base");
    bunny.style.position = "static";
    bunny.style.transform = "none";
    base.appendChild(bunny);
  } else {
    bunny.style.position = "absolute";
    bunny.style.left = cellPath[pos].x;
    bunny.style.top = cellPath[pos].y;
    bunny.style.transform = "translate(-50%, -50%)";
    board.appendChild(bunny);
  }
}

/* --- TURNO DI GIOCO --- */
function rollDice() {
  diceResult = Math.floor(Math.random() * 6) + 1;
  diceBtn.disabled = true;
  statusBar.innerHTML = `Hai ottenuto: <span>${diceResult}</span>`;
  
  if (diceResult === 6) {
    statusBar.innerHTML = "üé≤ 6! I buchi cambiano posto!";
    moveHoles();
    setTimeout(startMovePhase, 800);
  } else {
    startMovePhase();
  }
}

function startMovePhase() {
  if (currentPlayer === "player") {
    gameState = "selecting";
    bunnies.filter(b => b.dataset.type === "player").forEach(b => b.classList.add("active-jump"));
    statusBar.innerHTML = `Dado: ${diceResult} - Scegli chi muovere!`;
  } else {
    setTimeout(cpuTurn, 1000);
  }
}

function selectBunny(bunny) {
  if (gameState !== "selecting" || bunny.dataset.type !== "player") return;
  bunnies.forEach(b => b.classList.remove("active-jump"));
  executeMove(bunny);
}

function executeMove(bunny) {
  gameState = "moving";
  let currentPos = parseInt(bunny.dataset.pos);
  let newPos = currentPos + diceResult;

  // Controllo Vittoria
  if (newPos >= 29) {
    bunny.dataset.pos = 29;
    updateBunnyPosition(bunny);
    gameOver(bunny.dataset.type);
    return;
  }

  bunny.dataset.pos = newPos;
  updateBunnyPosition(bunny);

  // Controllo Buco
  if (holePositions.includes(newPos + 1)) {
    setTimeout(() => {
      bunny.dataset.pos = -1;
      updateBunnyPosition(bunny);
      statusBar.innerHTML = "üåÄ Splash! Caduto nel buco.";
    }, 700);
  }

  setTimeout(switchTurn, 1000);
}

function cpuTurn() {
  const cpuBunnies = bunnies.filter(b => b.dataset.type === "cpu");
  // La CPU muove il coniglio pi√π avanti
  const bestBunny = cpuBunnies.sort((a, b) => b.dataset.pos - a.dataset.pos)[0];
  executeMove(bestBunny);
}

function switchTurn() {
  currentPlayer = (currentPlayer === "player") ? "cpu" : "player";
  gameState = "waiting";
  statusBar.innerHTML = (currentPlayer === "player") ? "Tocca a te!" : "ü§ñ CPU sta pensando...";
  diceBtn.disabled = (currentPlayer === "cpu");
  
  if (currentPlayer === "cpu") {
    setTimeout(rollDice, 800);
  }
}

function gameOver(winner) {
  statusBar.innerHTML = winner === "player" ? "üèÜ TRIONFO! HAI VINTO!" : "ü§ñ LA CPU HA VINTO!";
  diceBtn.style.display = "none";
  setTimeout(() => location.reload(), 5000);
}

/* --- AVVIO --- */
createSpiralPath();
renderBoard();
setupBunnies();
</script>
</body>
</html>
