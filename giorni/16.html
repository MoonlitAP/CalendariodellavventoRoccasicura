<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üê∞ Carrera de Conejos - Fibonacci Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { --bg: #e8f5e9; --wood: #d2a679; --grass: #81c784; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; font-family: 'Ubuntu', sans-serif; background: var(--bg); 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    height: 100vh; padding: 10px; overflow: hidden;
  }

  /* Finestra Spiegazione Iniziale */
  .overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); 
    display: flex; align-items: center; justify-content: center; z-index: 100;
  }
  .modal {
    background: #fffdf5; padding: 25px; border-radius: 30px; border: 6px solid var(--wood);
    width: 90%; max-width: 350px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.4);
  }
  .modal h2 { color: #2e7d32; margin-top: 0; }
  .modal p { color: #5d4037; line-height: 1.5; font-size: 15px; text-align: left; }

  /* Tabellone */
  #game-container {
    position: relative; width: 95vmin; height: 95vmin; max-width: 450px; max-height: 450px;
    display: flex; align-items: center; justify-content: center;
  }
  #board {
    width: 80%; height: 80%; background: var(--grass); border-radius: 50%; 
    position: relative; border: 6px solid #4a8c4d; box-shadow: inset 0 0 50px rgba(0,0,0,0.1);
  }

  /* Caselle */
  .cell { 
    width: 10%; height: 10%; background: #fdf5e6; border-radius: 20%; position: absolute; 
    display: flex; align-items: center; justify-content: center; font-size: 3vmin; 
    font-weight: bold; color: #5d4037; border: 1.5px solid #deb887;
    transform: translate(-50%, -50%); z-index: 2;
  }
  .hole { background: #222 !important; border: none; box-shadow: inset 0 3px 5px #000; color: transparent !important; }

  #carrot { 
    width: 18%; height: 18%; background: #ffa726; border-radius: 50%; position: absolute; 
    top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; 
    justify-content: center; font-size: 8vmin; z-index: 5; border: 3px solid #fb8c00;
  }

  /* Coniglietti */
  .rabbit { 
    width: 9%; height: 9%; position: absolute; z-index: 10;
    transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
    transform: translate(-50%, -50%);
    background-size: contain; background-repeat: no-repeat; background-position: center;
  }
  .player { background-image: url('../img/rabbit_1.png'); }
  .cpu { background-image: url('../img/rabbit_2.png'); }
  
  .active-move { animation: jump 0.6s infinite alternate; filter: drop-shadow(0 0 8px #fff); }
  @keyframes jump { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -65%) scale(1.1); } }

  /* Basi Esterne (Dritte) */
  .base { 
    position: absolute; display: flex; flex-direction: column; gap: 10px; 
    padding: 10px; background: rgba(255,255,255,0.3); border-radius: 15px;
  }
  .p-base { left: 0%; top: 50%; transform: translateY(-50%); }
  .c-base { right: 0%; top: 50%; transform: translateY(-50%); }
  .base .rabbit { position: static; transform: none; width: 40px; height: 40px; }

  /* UI Inferiore */
  .controls { margin-top: 10px; text-align: center; width: 100%; }
  #msg {
    background: white; padding: 10px; border-radius: 15px; border: 2px solid var(--wood);
    font-weight: bold; margin-bottom: 10px; color: #2e7d32; min-height: 44px;
  }
  .btn {
    padding: 12px 30px; border: none; border-radius: 25px;
    background: #ff9800; color: white; font-size: 18px; font-weight: bold;
    box-shadow: 0 4px 0 #e65100; cursor: pointer;
  }
  .btn:disabled { background: #ccc; box-shadow: 0 4px 0 #999; }
</style>
</head>
<body>

<div id="startUI" class="overlay">
  <div class="modal">
    <h2>üê∞ Benvenuto alla Carrera!</h2>
    <p>
      <b>Obiettivo:</b> Porta i tuoi 3 coniglietti alla carota centrale (Casella 1).<br><br>
      <b>Come si gioca:</b><br>
      1. Tira il dado e scegli quale coniglio muovere.<br>
      2. Il percorso va dal <b>30</b> fino all'<b>1</b>.<br>
      3. Se esce <b>6</b>, i buchi neri cambiano posizione!<br>
      4. Se cadi in un buco, torni alla base.
    </p>
    <button class="btn" onclick="start()">INIZIA LA SFIDA</button>
  </div>
</div>

<div id="winUI" class="overlay" style="display:none">
  <div class="modal">
    <h1 id="winTxt">VITTORIA!</h1>
    <button class="btn" onclick="location.reload()">GIOCA ANCORA</button>
  </div>
</div>

<div id="game-container">
  <div class="base p-base" id="p-base"></div>
  <div id="board"><div id="carrot">ü•ï</div></div>
  <div class="base c-base" id="c-base"></div>
</div>

<div class="controls">
  <div id="msg">Tira il dado per iniziare!</div>
  <button id="diceBtn" class="btn" onclick="roll()">üé≤ TIRA IL DADO</button>
</div>

<script>
const board = document.getElementById("board");
const msg = document.getElementById("msg");
const diceBtn = document.getElementById("diceBtn");

let turn = "player";
let currentDice = 0;
let state = "wait"; 
const path = [];
let holes = [25, 18, 10]; // Buchi iniziali

function start() { document.getElementById("startUI").style.display = "none"; }

// Spirale da 30 (esterno) a 1 (centro)
function buildPath() {
  const totalSteps = 30;
  for (let i = 0; i < totalSteps; i++) {
    // Calcolo spirale invertita
    const angle = 0.5 * (totalSteps - i); 
    const r = 10 + (i * 1.3); // raggio cresce verso l'esterno
    const x = 50 + r * Math.cos(angle);
    const y = 50 + r * Math.sin(angle);
    // Inseriamo all'inizio dell'array cos√¨ l'indice 0 √® la casella 30 e l'ultimo √® la 1
    path.unshift({ x: x + "%", y: y + "%" });
  }
}
buildPath();

function draw() {
  document.querySelectorAll('.cell').forEach(c => c.remove());
  path.forEach((p, i) => {
    const num = i + 1; // Da 1 a 30
    const c = document.createElement("div");
    c.className = "cell" + (holes.includes(num) ? " hole" : "");
    c.style.left = p.x; c.style.top = p.y;
    if (!holes.includes(num)) c.textContent = num;
    board.appendChild(c);
  });
}
draw();

function swapHoles() {
  let h = [];
  while(h.length < 3) {
    let r = Math.floor(Math.random() * 25) + 2;
    if(!h.includes(r)) h.push(r);
  }
  holes = h;
  draw();
}

let conigli = [];
function init() {
  const pb = document.getElementById("p-base");
  const cb = document.getElementById("c-base");
  for (let i = 0; i < 6; i++) {
    const isP = i < 3;
    const r = document.createElement("div");
    r.className = "rabbit " + (isP ? "player" : "cpu");
    r.pos = 31; // Partono fuori dal 30
    r.id = i; r.type = isP ? "player" : "cpu";
    r.onclick = () => tap(r);
    isP ? pb.appendChild(r) : cb.appendChild(r);
    conigli.push(r);
  }
}

function place(r) {
  if (r.pos > 30) {
    const b = r.type === "player" ? document.getElementById("p-base") : document.getElementById("c-base");
    r.style.position = "static"; r.style.transform = "none";
    b.appendChild(r);
  } else {
    r.style.position = "absolute";
    r.style.left = path[r.pos - 1].x; r.style.top = path[r.pos - 1].y;
    r.style.transform = "translate(-50%, -50%)";
    board.appendChild(r);
  }
}
init();

function roll() {
  currentDice = Math.floor(Math.random() * 6) + 1;
  diceBtn.disabled = true;
  msg.innerHTML = `üé≤ Risultato: <b>${currentDice}</b>`;
  if (currentDice === 6) { 
    msg.innerHTML = "üé≤ <b>6!</b> I buchi si muovono!";
    swapHoles(); 
    setTimeout(go, 800); 
  } else { go(); }
}

function go() {
  if (turn === "player") {
    state = "pick";
    conigli.filter(r => r.type === "player").forEach(r => r.classList.add("active-move"));
  } else { setTimeout(cpu, 1000); }
}

function tap(r) {
  if (state !== "pick" || r.type !== "player") return;
  conigli.forEach(c => c.classList.remove("active-move"));
  move(r);
}

function move(r) {
  state = "move";
  // Movimento verso il basso (da 30 a 1)
  if (r.pos > 30) r.pos = 31 - currentDice;
  else r.pos -= currentDice;

  if (r.pos <= 1) {
    r.pos = 1; place(r);
    setTimeout(() => {
      document.getElementById("winUI").style.display = "flex";
      document.getElementById("winTxt").innerText = turn === "player" ? "üèÜ HAI VINTO!" : "ü§ñ CPU VINCE";
    }, 500);
    return;
  }

  place(r);
  if (holes.includes(r.pos)) {
    setTimeout(() => { 
        r.pos = 31; place(r); 
        msg.innerHTML = "üåÄ OOOPS! Caduto nel buco!";
    }, 700);
  }
  setTimeout(next, 1000);
}

function cpu() {
  let movable = conigli.filter(r => r.type === "cpu");
  let r = movable[Math.floor(Math.random() * 3)];
  move(r);
}

function next() {
  turn = turn === "player" ? "cpu" : "player";
  state = "wait";
  msg.innerHTML = turn === 'player' ? "Tocca a te!" : "ü§ñ Il PC gioca...";
  diceBtn.disabled = (turn === "cpu");
  if (turn === "cpu") setTimeout(roll, 600);
}
</script>
</body>
</html>
