<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>üê∞ Giorno 16 ‚Äì Garden Race 30 ‚Üí 0</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --grass:#76c043;
    --grass-dark:#4caf50;
    --path:#f9f1dc;
    --path-edge:#d7ccc8;
    --wood:#6d4c41;
    --ink:#3e2723;
    --hole:#151515;
    --win:#ffeb3b;
    --win-edge:#fbc02d;
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body{
    margin:0;
    font-family:'Ubuntu',sans-serif;
    background:#e3f2fd;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:10px 10px 16px;
    min-height:100vh;
    overflow:hidden;
  }

  h1{
    margin:6px 0 8px;
    font-size:22px;
    color:#1b5e20;
    text-shadow:1px 1px #fff;
    font-weight:800;
  }

  /* WRAPPER: tane sopra/sotto + board al centro */
  .wrap{
    width:100%;
    max-width:520px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:center;
  }

  .baseRow{
    width:100%;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0 6px;
  }

  .base{
    width:160px;
    height:88px;
    background:#a1887f;
    border:4px solid var(--wood);
    border-radius:18px;
    position:relative;
    display:flex;
    gap:6px;
    padding:10px;
    justify-content:center;
    align-items:center;
    flex-wrap:wrap;
    box-shadow:0 8px 18px rgba(0,0,0,.18);
  }
  .baseLabel{
    position:absolute;
    top:-18px;
    left:12px;
    font-size:12px;
    font-weight:800;
    color:var(--wood);
    background:#e3f2fd;
    padding:0 6px;
    border-radius:10px;
  }

  /* BOARD */
  #game-world{
    width:100%;
    height:min(64vh, 560px);
    background:var(--grass);
    border:10px solid var(--grass-dark);
    border-radius:30px;
    position:relative;
    overflow:hidden;
    box-shadow:0 14px 28px rgba(0,0,0,.2);
    background-image: radial-gradient(rgba(255,255,255,.18) 10%, transparent 20%);
    background-size:30px 30px;
  }

  /* caselle */
  .tile{
    width:54px;
    height:54px;
    background:var(--path);
    border-radius:16px;
    position:absolute;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    font-weight:900;
    color:var(--ink);
    border-bottom:6px solid var(--path-edge);
    box-shadow:0 6px 0 rgba(0,0,0,.10);
    z-index:3;
    user-select:none;
  }

  .tile span{
    position:relative;
    z-index:2;
    line-height:1;
  }

  .hole{
    background:var(--hole) !important;
    border-bottom-color:#000 !important;
    box-shadow: inset 0 8px 16px rgba(0,0,0,.7);
  }
  .hole span{ display:none; }

  /* traguardo 0 */
  #finish-line{
    width:78px;
    height:78px;
    background:var(--win);
    border:5px solid var(--win-edge);
    border-radius:22px;
    position:absolute;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:5;
    box-shadow:0 0 22px rgba(255,235,59,.55);
  }
  #finish-line .carrot{ font-size:36px; }
  #finish-line .zero{ font-size:12px; font-weight:900; color:#f57f17; }

  /* conigli */
  .bunny{
    width:40px;
    height:40px;
    border-radius:14px;
    position:absolute;
    z-index:10;
    background-size:contain;
    background-repeat:no-repeat;
    background-position:center;
    filter: drop-shadow(0 4px 4px rgba(0,0,0,.25));
    transition: left .35s cubic-bezier(.2,.8,.2,1), top .35s cubic-bezier(.2,.8,.2,1), transform .35s;
  }

  .p-bunny{ background-image:url('img/rabbit_1.png'); }
  .c-bunny{ background-image:url('img/rabbit_2.png'); }

  .pickable{
    outline:4px solid rgba(255,255,255,.9);
    box-shadow:0 0 0 6px rgba(255,152,0,.45);
    cursor:pointer;
  }

  /* UI */
  .controls{
    width:100%;
    max-width:520px;
    margin-top:10px;
  }
  #msg{
    background:#fff;
    padding:14px 16px;
    border-radius:60px;
    border:3px solid var(--grass-dark);
    font-weight:900;
    color:#1b5e20;
    box-shadow:0 10px 18px rgba(0,0,0,.10);
  }

  .btn-dice{
    width:100%;
    margin-top:10px;
    padding:16px;
    border:none;
    border-radius:60px;
    background:#ff9800;
    color:#fff;
    font-size:20px;
    font-weight:900;
    box-shadow:0 8px 0 #e65100;
    cursor:pointer;
  }
  .btn-dice:active{
    transform:translateY(4px);
    box-shadow:0 4px 0 #e65100;
  }
  .btn-dice:disabled{
    background:#cfcfcf;
    box-shadow:0 6px 0 #9b9b9b;
    cursor:not-allowed;
  }

  /* piccolo adattamento telefoni stretti */
  @media (max-width: 380px){
    .base{ width:150px; }
    .tile{ width:50px; height:50px; font-size:17px; }
  }
</style>
</head>

<body>

<h1>üê∞ GARDEN RACE 30 ‚Üí 0</h1>

<div class="wrap">

  <!-- TANA CPU (SOPRA, FUORI DAL CAMPO) -->
  <div class="baseRow">
    <div class="base" id="cpu-base">
      <div class="baseLabel">TANA PC</div>
    </div>
    <div style="width:160px"></div>
  </div>

  <!-- CAMPO -->
  <div id="game-world">
    <div id="finish-line">
      <div class="carrot">ü•ï</div>
      <div class="zero">0</div>
    </div>
  </div>

  <!-- TANA GIOCATORE (SOTTO, FUORI DAL CAMPO) -->
  <div class="baseRow">
    <div style="width:160px"></div>
    <div class="base" id="player-base">
      <div class="baseLabel">TANA TUA</div>
    </div>
  </div>

</div>

<div class="controls">
  <div id="msg">Tira il dado per iniziare!</div>
  <button id="diceBtn" class="btn-dice" onclick="roll()">üé≤ TIRA IL DADO</button>
</div>

<script>
  const world = document.getElementById("game-world");
  const finish = document.getElementById("finish-line");
  const msg = document.getElementById("msg");
  const diceBtn = document.getElementById("diceBtn");
  const playerBase = document.getElementById("player-base");
  const cpuBase = document.getElementById("cpu-base");

  // 30 ‚Üí 0 (0 = carota)
  const MAX = 30;

  // Buchi: attivi SOLO se esce 6
  // (puoi cambiare numeri; devono essere tra 1 e 30)
  let holes = [26, 18, 9, 4];

  // Mappa posizioni (layout "pulito", senza sovrapposizioni)
  // Coordinate in percentuale del board (responsive)
  // Nota: 0 √® la carota (finish) e la mettiamo in alto a destra
  const pos = new Map([
    [30, {x: 18, y: 16}],
    [29, {x: 46, y: 16}],
    [28, {x: 70, y: 16}],
    [27, {x: 86, y: 20}],   // vicino zona destra

    [24, {x: 86, y: 32}],
    [23, {x: 70, y: 30}],
    [22, {x: 46, y: 30}],
    [21, {x: 18, y: 30}],

    [20, {x: 18, y: 44}],
    [19, {x: 46, y: 44}],
    [18, {x: 66, y: 44}],
    [17, {x: 86, y: 44}],

    [14, {x: 86, y: 58}],
    [13, {x: 66, y: 58}],
    [12, {x: 46, y: 58}],
    [11, {x: 18, y: 58}],

    [10, {x: 18, y: 74}],
    [9,  {x: 46, y: 74}],
    [8,  {x: 66, y: 74}],
    [7,  {x: 86, y: 74}],

    [6,  {x: 86, y: 88}],
    [5,  {x: 66, y: 88}],
    [4,  {x: 46, y: 88}],
    [3,  {x: 30, y: 88}],
    [2,  {x: 18, y: 90}],
    [1,  {x: 10, y: 90}],
  ]);

  // Carota (0) in alto a destra
  const finishPos = {x: 88, y: 10};

  function pctToPx(p){
    const w = world.clientWidth;
    const h = world.clientHeight;
    return { left: (p.x/100)*w, top: (p.y/100)*h };
  }

  // Disegno caselle
  function renderTiles(){
    world.querySelectorAll(".tile").forEach(t => t.remove());

    for(let n = MAX; n >= 1; n--){
      if(!pos.has(n)) continue;
      const p = pctToPx(pos.get(n));

      const tile = document.createElement("div");
      tile.className = "tile" + (holes.includes(n) ? " hole" : "");
      tile.style.left = (p.left - 27) + "px";
      tile.style.top  = (p.top  - 27) + "px";

      const s = document.createElement("span");
      s.textContent = n;
      tile.appendChild(s);

      world.appendChild(tile);
    }

    // finish-line
    const fp = pctToPx(finishPos);
    finish.style.left = (fp.left - 39) + "px";
    finish.style.top  = (fp.top  - 39) + "px";
  }

  window.addEventListener("resize", () => {
    renderTiles();
    bunnies.forEach(updateBunny);
  });

  // Conigli (4 + 4)
  const bunnies = [];

  function makeBunny(owner, idx){
    const b = document.createElement("div");
    b.className = "bunny " + (owner==="player" ? "p-bunny" : "c-bunny");
    b.dataset.owner = owner;
    b.dataset.pos = "-1"; // -1 = in tana
    b.dataset.idx = String(idx);
    b.addEventListener("click", () => trySelect(b));
    return b;
  }

  for(let i=0;i<4;i++){
    const bp = makeBunny("player", i);
    playerBase.appendChild(bp);
    bunnies.push(bp);

    const bc = makeBunny("cpu", i);
    cpuBase.appendChild(bc);
    bunnies.push(bc);
  }

  function updateBunny(b){
    const p = parseInt(b.dataset.pos, 10);

    // in tana
    if(p === -1){
      if(b.dataset.owner === "player") playerBase.appendChild(b);
      else cpuBase.appendChild(b);

      b.style.position = "relative";
      b.style.left = "0px";
      b.style.top  = "0px";
      b.style.transform = "none";
      b.classList.remove("pickable");
      return;
    }

    // sul campo
    world.appendChild(b);
    b.style.position = "absolute";

    // p=0 => carota
    let target;
    if(p === 0){
      target = pctToPx(finishPos);
    }else{
      target = pctToPx(pos.get(p));
    }

    // piccoli offset per non sovrapporre 2 conigli sulla stessa casella
    const idx = parseInt(b.dataset.idx,10);
    const offX = (idx%2===0) ? -10 : 10;
    const offY = (idx<2) ? -10 : 10;

    b.style.left = (target.left - 20 + offX) + "px";
    b.style.top  = (target.top  - 20 + offY) + "px";
    b.style.transform = "translate(0,0)";
    b.classList.remove("pickable");
  }

  renderTiles();
  bunnies.forEach(updateBunny);

  // Turni + dado + selezione
  let turn = "player";
  let lastDice = 0;
  let state = "idle"; // idle | picking | moving

  function roll(){
    if(state !== "idle") return;

    diceBtn.disabled = true;
    lastDice = Math.floor(Math.random()*6) + 1;

    msg.innerHTML = `üé≤ √à uscito <b>${lastDice}</b>`;

    // Se 6 => buchi ATTIVI (caduta possibile)
    if(lastDice === 6){
      msg.innerHTML += ` ‚Äî ‚ö†Ô∏è con il 6 puoi cadere nei buchi!`;
    }

    setTimeout(() => {
      if(turn === "player"){
        state = "picking";
        msg.innerHTML += `<br>Tocca un tuo coniglio per muoverlo.`;
        markPickable(true);
      }else{
        state = "moving";
        msg.innerHTML = `ü§ñ Turno PC‚Ä¶`;
        setTimeout(cpuMove, 700);
      }
    }, 400);
  }

  function markPickable(on){
    bunnies.forEach(b => {
      if(b.dataset.owner === "player"){
        if(on) b.classList.add("pickable");
        else b.classList.remove("pickable");
      }
    });
  }

  function trySelect(b){
    if(state !== "picking") return;
    if(b.dataset.owner !== "player") return;

    markPickable(false);
    state = "moving";
    moveBunny(b);
  }

  function moveBunny(b){
    let cur = parseInt(b.dataset.pos,10);

    // se in tana, entra a 30 come start (prima mossa)
    if(cur === -1) cur = 30;

    let next = cur - lastDice;

    // vittoria (raggiunge o supera 0)
    if(next <= 0){
      b.dataset.pos = "0";
      updateBunny(b);
      endGame(turn);
      return;
    }

    b.dataset.pos = String(next);
    updateBunny(b);

    // caduta SOLO se √® uscito 6
    if(lastDice === 6 && holes.includes(next)){
      setTimeout(() => {
        b.dataset.pos = "-1";
        updateBunny(b);
        msg.innerHTML = `üï≥Ô∏è Caduto nel buco! Torni in tana.`;
      }, 420);
    }

    setTimeout(endTurn, 700);
  }

  function cpuMove(){
    const cpu = bunnies.filter(x => x.dataset.owner === "cpu");

    // sceglie quello pi√π vicino allo 0 (pos pi√π basso ma non -1)
    // se tutti in tana, prende il primo
    const onBoard = cpu.filter(x => parseInt(x.dataset.pos,10) !== -1);
    let chosen;

    if(onBoard.length === 0){
      chosen = cpu[0];
      chosen.dataset.pos = "30"; // entra
      updateBunny(chosen);
      // poi applica il tiro
      setTimeout(() => {
        moveBunny(chosen);
      }, 250);
      return;
    }

    chosen = onBoard.sort((a,b) => parseInt(a.dataset.pos,10) - parseInt(b.dataset.pos,10))[0];
    moveBunny(chosen);
  }

  function endTurn(){
    state = "idle";
    turn = (turn === "player") ? "cpu" : "player";

    if(turn === "player"){
      msg.innerHTML = `Tocca a te. Tira il dado.`;
      diceBtn.disabled = false;
    }else{
      msg.innerHTML = `Turno PC.`;
      diceBtn.disabled = true;
      setTimeout(roll, 600);
    }
  }

  function endGame(winner){
    state = "idle";
    diceBtn.disabled = true;

    msg.innerHTML = (winner === "player")
      ? `üèÜ Hai vinto! Sei arrivato alla carota ü•ï`
      : `ü§ñ Ha vinto il PC!`;

    setTimeout(() => location.reload(), 3500);
  }

  // Avvio
  diceBtn.disabled = false;
</script>

</body>
</html>
