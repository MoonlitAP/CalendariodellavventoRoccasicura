<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üéÑ Giorno 20 ‚Äì Catch the Gifts</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  background:#7b0412;
  font-family:'Ubuntu',sans-serif;
  text-align:center;
  color:white;
}

h1{
  margin:10px 0 4px;
  color:#ffd700;
  font-size:1.4em;
}

#hud{
  display:flex;
  justify-content:space-around;
  margin-bottom:6px;
  font-weight:bold;
}

canvas{
  background:#a5141c;
  border-radius:16px;
  touch-action:manipulation;
}

#msg{
  margin-top:10px;
  font-size:1.1em;
  color:#00ff99;
}

.btn-back{
  display:inline-block;
  margin:12px auto;
  padding:12px 28px;
  background:#f3e4e4;
  color:black;
  border-radius:30px;
  font-weight:bold;
  text-decoration:none;
}
</style>
</head>

<body>

<h1>üéÑ Giorno 20 ‚Äì Catch the Gifts</h1>

<div id="hud">
  <div>üéÅ <span id="score">0</span></div>
  <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
</div>

<canvas id="game" width="360" height="520"></canvas>

<div id="msg"></div>

<a href="../calendario.html" class="btn-back">‚Üê Calendario</a>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ====== AUDIO (SENZA FILE) ====== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playGiftSound(){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = "triangle";
  osc.frequency.value = 880;
  gain.gain.value = 0.15;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.15);
}

/* ====== STATO ====== */
let santaX = canvas.width / 2;
const santaY = 450;
let items = [];
let score = 0;
let lives = 3;
let speed = 2.2;
let running = true;

/* ====== HUD ====== */
function updateLives(){
  document.getElementById("lives").textContent = "‚ù§Ô∏è".repeat(lives);
}

/* ====== SPAWN OGGETTI ====== */
function spawnItem(){
  const type = Math.random() < 0.75 ? "gift" : "bomb";
  items.push({
    x: Math.random() * (canvas.width - 40) + 20,
    y: -30,
    type
  });
}

setInterval(()=>{
  if(running) spawnItem();
},900);

/* ====== DISEGNO BABBO (MIGLIORATO) ====== */
function drawSanta(){
  // corpo
  ctx.fillStyle="#c62828";
  ctx.fillRect(santaX-20, santaY, 40, 20);

  // testa
  ctx.fillStyle="#fff";
  ctx.beginPath();
  ctx.arc(santaX, santaY-15, 16, 0, Math.PI*2);
  ctx.fill();

  // cappello
  ctx.fillStyle="#c62828";
  ctx.beginPath();
  ctx.moveTo(santaX-18, santaY-28);
  ctx.lineTo(santaX+18, santaY-28);
  ctx.lineTo(santaX, santaY-50);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle="#fff";
  ctx.beginPath();
  ctx.arc(santaX, santaY-50, 4, 0, Math.PI*2);
  ctx.fill();
}

/* ====== DISEGNO OGGETTI ====== */
function drawItems(){
  items.forEach(i=>{
    ctx.font="28px serif";
    ctx.fillText(i.type==="gift" ? "üéÅ" : "üí£", i.x, i.y);
    i.y += speed;
  });
}

/* ====== COLLISIONI ====== */
function checkCollision(){
  items.forEach(i=>{
    if(Math.abs(i.x - santaX) < 28 && Math.abs(i.y - santaY) < 28){
      if(i.type === "gift"){
        score++;
        document.getElementById("score").textContent = score;
        playGiftSound();
        i.y = canvas.height + 100;
        if(score % 6 === 0) speed += 0.4;
      }else{
        lives--;
        updateLives();
        i.y = canvas.height + 100;
        if(lives <= 0){
          running = false;
          document.getElementById("msg").textContent =
            `üí• Game Over! Regali raccolti: ${score}`;
        }
      }
    }
  });
}

/* ====== LOOP ====== */
function loop(){
  if(!running) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawSanta();
  drawItems();
  checkCollision();
  requestAnimationFrame(loop);
}

/* ====== CONTROLLI ====== */
window.addEventListener("keydown",e=>{
  if(e.key==="ArrowLeft") santaX -= 30;
  if(e.key==="ArrowRight") santaX += 30;
  santaX = Math.max(25, Math.min(canvas.width-25, santaX));
});

canvas.addEventListener("touchstart",e=>{
  const x = e.touches[0].clientX;
  const rect = canvas.getBoundingClientRect();
  santaX = x - rect.left;
});

/* START */
updateLives();
loop();
</script>

</body>
</html>
