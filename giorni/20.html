<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üéÑ Giorno 20 ‚Äì Roccasicura Run</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  background:#8fd3ff;
  font-family:'Ubuntu',sans-serif;
  text-align:center;
}

h1{
  margin:10px 0 4px;
  color:#c62828;
  font-size:1.4em;
}

#hud{
  display:flex;
  justify-content:space-around;
  margin-bottom:6px;
  font-weight:bold;
}

canvas{
  border-radius:16px;
  background:#8fd3ff;
  touch-action:manipulation;
}

#msg{
  margin-top:6px;
  font-size:1.1em;
  color:#2e7d32;
}

.btn-back{
  display:inline-block;
  margin:12px auto;
  padding:10px 24px;
  background:#fff;
  color:black;
  border-radius:30px;
  font-weight:bold;
  text-decoration:none;
}
</style>
</head>

<body>

<h1>üéÑ Giorno 20 ‚Äì Roccasicura Run</h1>

<div id="hud">
  <div>üéÅ <span id="score">0</span></div>
  <div>üö¶ Livello <span id="level">1</span></div>
</div>

<canvas id="game" width="360" height="520"></canvas>

<div id="msg"></div>

<a href="../calendario.html" class="btn-back">‚Üê Calendario</a>

<script>
/* ====== ASSET ====== */
const imgBabbo = new Image();
imgBabbo.src = "img/babbo_sacco.png";

const imgGift = new Image();
imgGift.src = "img/gift.png";

const imgOlaf = new Image();
imgOlaf.src = "img/olaf.png";

const imgSnow = new Image();
imgSnow.src = "img/snow.png";

/* ====== SETUP ====== */
const nome = localStorage.getItem("utente") || "Ospite";
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let playerX = 100;
let playerY = 330;

let speed = 2.5;
let level = 1;
let score = 0;
let running = true;

let obstacles = [];
let gifts = [];
let snow = [];

/* ====== NEVE ====== */
function initSnow(){
  snow.length = 0;
  for(let i=0;i<35;i++){
    snow.push({
      x:Math.random()*canvas.width,
      y:Math.random()*canvas.height,
      s:1+Math.random()*2
    });
  }
}
initSnow();

/* ====== BACKGROUND ====== */
function drawBackground(){
  ctx.fillStyle="#8fd3ff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // collina
  ctx.fillStyle="#f6d54a";
  ctx.beginPath();
  ctx.moveTo(0,260);
  ctx.quadraticCurveTo(180,230,360,300);
  ctx.lineTo(360,520);
  ctx.lineTo(0,520);
  ctx.closePath();
  ctx.fill();

  ctx.strokeStyle="#3aa655";
  ctx.lineWidth=10;
  ctx.stroke();
}

/* ====== NEVE ====== */
function drawSnow(){
  snow.forEach(f=>{
    ctx.drawImage(imgSnow, f.x, f.y, 12, 12);
    f.y += f.s;
    if(f.y > canvas.height){
      f.y = -10;
      f.x = Math.random()*canvas.width;
    }
  });
}

/* ====== PLAYER ====== */
function drawPlayer(){
  ctx.drawImage(imgBabbo, playerX-24, playerY-36, 48, 72);
}

/* ====== SPAWN ====== */
function spawnGift(){
  gifts.push({
    x: canvas.width + 20,
    y: 260 + Math.random()*90
  });
}

function spawnOlaf(){
  obstacles.push({
    x: canvas.width + 20,
    y: 260 + Math.random()*90,
    type: "olaf"
  });
}

function spawnObstacle(){
  obstacles.push({
    x: canvas.width + 20,
    y: 260 + Math.random()*90,
    type: "rock"
  });
}

/* ====== DISEGNO OGGETTI ====== */
function drawGifts(){
  gifts.forEach(g=>{
    ctx.drawImage(imgGift, g.x-16, g.y-16, 32, 32);
    g.x -= speed;
  });
}

function drawObstacles(){
  obstacles.forEach(o=>{
    if(o.type==="olaf"){
      ctx.drawImage(imgOlaf, o.x-20, o.y-28, 40, 56);
    }else{
      ctx.fillStyle="#795548";
      ctx.fillRect(o.x-14, o.y-14, 28, 28);
    }
    o.x -= speed;
  });
}

/* ====== COLLISIONI ====== */
function checkCollision(){

  // üéÅ REGALI
  gifts.forEach(g=>{
    if(Math.abs(g.x-playerX)<30 && Math.abs(g.y-playerY)<30){
      score++;
      document.getElementById("score").textContent = score;
      g.x = -100;

      if(score % 5 === 0){
        level++;
        speed += 0.6;
        document.getElementById("level").textContent = level;
      }
    }
  });

  // ‚õî OSTACOLI
  obstacles.forEach(o=>{
    if(Math.abs(o.x-playerX)<30 && Math.abs(o.y-playerY)<30){
      if(o.type==="olaf"){
        speed = Math.max(2, speed - 1);
        snow.length = 0;
        setTimeout(initSnow, 4000);
        o.x = -100;
      }else{
        running = false;
        document.getElementById("msg").textContent =
          `üí• Game Over ${nome}! Regali raccolti: ${score}`;
      }
    }
  });
}

/* ====== LOOP ====== */
function loop(){
  if(!running) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBackground();
  drawSnow();
  drawGifts();
  drawObstacles();
  drawPlayer();
  checkCollision();
  requestAnimationFrame(loop);
}

/* ====== CONTROLLI ====== */
window.addEventListener("keydown",e=>{
  if(e.key==="ArrowUp") playerY -= 30;
  if(e.key==="ArrowDown") playerY += 30;
});

canvas.addEventListener("touchstart",e=>{
  const y = e.touches[0].clientY;
  if(y < canvas.height/2) playerY -= 30;
  else playerY += 30;
});

/* ====== TIMER SPAWN ====== */
setInterval(()=>{ if(running) spawnGift(); }, 900);
setInterval(()=>{ if(running && Math.random()<0.35) spawnOlaf(); }, 2200);
setInterval(()=>{ if(running) spawnObstacle(); }, 1700);

/* START */
loop();
</script>

</body>
</html>
