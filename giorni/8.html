<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">

<title>ðŸŽ„ Giorno 8 â€“ Lâ€™Albero di Natale</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: "Ubuntu", sans-serif;
  background-color: #7b0412;
  color: #ffd9a0;
  text-align: center;
}

/* SCREENS */
.screen { display: none; }
.active { display: block; }

/* BUTTON */
.btn {
  background: #fff3e0;
  padding: 12px 28px;
  border-radius: 30px;
  font-weight: bold;
  color: #7b0412;
  border: none;
  cursor: pointer;
  margin: 20px;
  font-size: 18px;
}

/* UPLOAD */
.upload-box {
  background: rgba(255,255,255,0.15);
  border: 2px solid #ffd9a0;
  border-radius: 12px;
  padding: 20px;
  width: 80%;
  max-width: 400px;
  margin: 20px auto;
}

/* COLLAGE */
#collage {
  display: flex;
  flex-direction: column;
  gap: 25px;
  margin: 20px auto;
  max-width: 600px;
  width: 90%;
}

.photo-item img {
  width: 100%;
  aspect-ratio: 4 / 3;
  object-fit: cover;
  border-radius: 10px;
  border: 4px solid #ffd9a0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  cursor: pointer;
}

.caption {
  background: rgba(123, 4, 18, 0.85);
  color: white;
  font-size: 14px;
  padding: 6px;
  border-radius: 0 0 10px 10px;
  margin-top: -10px;
}

/* LIGHTBOX */
#lightbox {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.92);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 999;
}

#lightbox img {
  max-width: 95%;
  max-height: 80%;
  border-radius: 12px;
  border: 4px solid #ffd9a0;
}

#lightbox p {
  color: #fff;
  margin-top: 10px;
}

#closeLightbox {
  position: absolute;
  top: 18px;
  right: 22px;
  font-size: 30px;
  color: #ffd700;
  cursor: pointer;
}
</style>
</head>

<body>

<!-- UPLOAD SCREEN -->
<div id="upload" class="screen active">
  <h1 style="color:#ffd700">ðŸ“¸ Carica la tua foto</h1>
  <p>Mostra il tuo albero di Natale ðŸŽ„</p>

  <div class="upload-box">
    <input type="text" id="username" placeholder="Il tuo nome"
      style="padding:10px; width:90%; border-radius:8px; border:none; font-size:16px;"><br><br>

    <input type="file" id="fileInput" accept="image/*">
  </div>

  <div id="uploadStatus"></div>

  <button class="btn" onclick="uploadPhoto()">CARICA</button>
  <button class="btn" onclick="showGallery()">VAI ALLA GALLERIA</button>
</div>

<!-- GALLERY SCREEN -->
<div id="gallery" class="screen">
  <h1 style="color:#ffd700">âœ¨ Galleria dellâ€™8 dicembre âœ¨</h1>
  <p>Ogni albero racconta una storia ðŸŽ„</p>

  <div id="collage"></div>

  <button class="btn" onclick="backToUpload()">CARICA UNâ€™ALTRA FOTO</button>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" onclick="closeLightbox()">
  <span id="closeLightbox">âœ–</span>
  <img id="lightboxImg">
  <p id="lightboxName"></p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function showGallery() {
  upload.classList.remove("active");
  gallery.classList.add("active");
  loadCollage();
}

function backToUpload() {
  gallery.classList.remove("active");
  upload.classList.add("active");
}

function uploadPhoto() {
  const name = username.value.trim();
  const file = fileInput.files[0];
  if (!name || !file) {
    alert("Inserisci nome e foto");
    return;
  }

  uploadStatus.textContent = "Caricamentoâ€¦";

  const reader = new FileReader();
  reader.readAsDataURL(file);

  reader.onload = () => {
    const img = new Image();
    img.src = reader.result;

    img.onload = () => {
      const canvas = document.createElement("canvas");
      const MAX = 600;
      const scale = MAX / img.width;
      canvas.width = MAX;
      canvas.height = img.height * scale;

      canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);

      const base64 = canvas.toDataURL("image/jpeg", 0.7);

      db.ref("gallerie/giorno8").push({
        nome: name,
        base64,
        timestamp: Date.now()
      });

      uploadStatus.textContent = "âœ… Foto caricata!";
      fileInput.value = "";
    };
  };
}

function loadCollage() {
  collage.innerHTML = "";
  db.ref("gallerie/giorno8").orderByChild("timestamp").on("value", s => {
    collage.innerHTML = "";
    let list = [];
    s.forEach(c => list.push(c.val()));
    list.reverse();

    list.forEach(d => {
      const box = document.createElement("div");
      box.className = "photo-item";

      const img = document.createElement("img");
      img.src = d.base64;
      img.onclick = () => openLightbox(d.base64, d.nome);

      const cap = document.createElement("div");
      cap.className = "caption";
      cap.textContent = d.nome;

      box.appendChild(img);
      box.appendChild(cap);
      collage.appendChild(box);
    });
  });
}

function openLightbox(src, name) {
  lightboxImg.src = src;
  lightboxName.textContent = name;
  lightbox.style.display = "flex";
}

function closeLightbox() {
  lightbox.style.display = "none";
}
</script>

</body>
</html>