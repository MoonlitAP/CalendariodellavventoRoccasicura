<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
<title>üéÑ Giorno 3 ‚Äì Escape</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
/* ============================================
   GENERALE
============================================ */
body {
  margin: 0;
  background-color: #7b0412;
  font-family: 'Ubuntu', sans-serif;
  color: white;
  text-align: center;
  overflow-x: hidden;
}

h1 {
  color: #ffd700;
  margin-top: 10px;
  font-size: 2rem;
}

/* ============================================
   CANVAS 4:9 centrato
============================================ */
.canvas-wrapper {
  margin: 0 auto;
  width: 100%;
  max-width: 420px;
  padding: 10px;
}

#gameCanvas {
  width: 100%;
  aspect-ratio: 4 / 9;
  border: 3px solid #ffd700;
  border-radius: 14px;
  background: #bde0fe;
  display: none;
}

/* ============================================
   BOTTONI DI CONTROLLO
============================================ */
.controls {
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 90%;
  max-width: 420px;
  margin-left: auto;
  margin-right: auto;
}

.control-btn {
  background: #ffd700;
  color: #7b0412;
  font-size: 22px;
  font-weight: bold;
  border: 3px solid #fff3b0;
  border-radius: 14px;
  padding: 12px 20px;
  cursor: pointer;
  box-shadow: 0 0 10px rgba(255,215,0,0.6);
}

.control-btn:active {
  transform: scale(0.95);
}

.btn-rete {
  background: white;
  color: #7b0412;
  font-size: 20px;
  border: 3px solid #ffd700;
  opacity: 0.5;
}

.btn-rete.enabled {
  opacity: 1;
  box-shadow: 0 0 10px rgba(255,215,0,0.7);
}

/* ============================================
   START SCREEN (identico giorno 2)
============================================ */
#start-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
}

.start-box {
  background: #fffaf2;
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 420px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

.start-btn {
  width: 80%;
  margin-top: 12px;
  padding: 14px;
  border-radius: 30px;
  font-size: 1.1em;
  cursor: pointer;
  background: #7b0412;
  color: white;
  border: none;
  font-weight: bold;
}

.start-btn:hover {
  background: #ffd700;
  color: #400000;
}

/* ============================================
   COUNTDOWN
============================================ */
#countdown {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.countdown-number {
  font-size: 6rem;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 0 20px black;
  animation: zoomFade 1s ease forwards;
}

@keyframes zoomFade {
  0% { opacity: 0; transform: scale(0.4); }
  30% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(2); }
}

/* ============================================
   END SCREEN + CLASSIFICA (identico giorno 2)
============================================ */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.classifica-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 460px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

.btn {
  display: inline-block;
  margin-top: 15px;
  padding: 12px 30px;
  border-radius: 30px;
  font-weight: bold;
  cursor: pointer;
  color: white;
  background: #7b0412;
  text-decoration: none;
}

.btn:hover {
  background: #ffd700;
  color: #400000;
}

table {
  width: 100%;
  margin-top: 15px;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #d7bb5f;
  text-align: center;
}
</style>
</head>

<body>

<h1>üéÑ Giorno 3 ‚Äì Snowman Escape</h1>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-box">
    <p>
      üéÖ Babbo al centro<br>
      ‚ùÑ Pupazzi in arrivo<br>
      üéØ Spara con le bamboline<br>
      üï∏ Premi per usare la rete<br>
      üéÅ Prendi il regalo per attivarla<br>
      ‚ù§Ô∏è 3 vite<br>
    </p>

    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
  </div>
</div>

<!-- COUNTDOWN -->
<div id="countdown">
  <div id="countdown-number" class="countdown-number">3</div>
</div>

<!-- CANVAS -->
<div class="canvas-wrapper">
  <canvas id="gameCanvas"></canvas>
</div>

<!-- BOTTONI -->
<div class="controls">
  <button id="btnSpara" class="control-btn">üéØ SPARA!</button>
  <button id="btnRete" class="control-btn btn-rete" disabled>üï∏ USA RETE</button>
</div>

<!-- END SCREEN -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="messaggio"></h2>
    <h3>üèÜ Top 10 Globale</h3>

    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <button id="retry-btn" class="btn" style="background:#d41e1e;">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn">‚¨Ö Torna al Calendario</a>
  </div>
</div>



  <script>
/* ======================================================
   FIREBASE INIT (completo in PARTE 3)
====================================================== */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});
const db = firebase.database();

/* ======================================================
   NOME MASCHERATO COME GIORNO 2
====================================================== */
const nomeReale = localStorage.getItem("utente") || "Player";
const nomeMascherato =
  nomeReale[0] +
  Math.floor(Math.random()*900+100) +
  nomeReale.slice(1);

/* ======================================================
   CANVAS
====================================================== */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const w = Math.min(window.innerWidth - 20, 420);
  const h = Math.floor(w * 2.25); /* ratio 4:9 */
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ======================================================
   IMMAGINI
====================================================== */
const imgBabbo = new Image();
imgBabbo.src = "./img/babbo_3.png";

const imgSnowman = new Image();
imgSnowman.src = "./img/snowman.png";

const imgGift = new Image();
imgGift.src = "./img/gift.png";

const imgRete = new Image();
imgRete.src = "./img/rete.png";

const proiettiliSrc = ["./img/b1.png","./img/b2.png","./img/b3.png"];
let proiettiliImg = [];
proiettiliSrc.forEach(src => { let i = new Image(); i.src = src; proiettiliImg.push(i); });

/* ======================================================
   VARIABILI DI GIOCO
====================================================== */

let babbo = {
  x: 40,
  y: 0,
  w: 80,
  h: 80
};

let pupazzi = [];
let regali = [];
let palline = [];
let retiLanciate = [];

let indicePallina = 0;

let score = 0;
let lives = 3;
let running = false;

/* ======================================================
   FUNZIONI DI SPAWN
====================================================== */
let spawnSnowmanTimer = 0;
let spawnGiftTimer = 0;

function spawnSnowman() {
  pupazzi.push({
    x: canvas.width + 30,
    y: Math.random() * (canvas.height - 120),
    w: 90,
    h: 90,
    speed: 2.2
  });
}

function spawnGift() {
  regali.push({
    x: canvas.width + 30,
    y: Math.random() * (canvas.height - 120),
    w: 60,
    h: 60,
    speed: 2.2
  });
}

/* ======================================================
   SPARA: PALLINE ROTANTI + CATAPULTA
====================================================== */
document.getElementById("btnSpara").addEventListener("click", () => {

  let img = proiettiliImg[indicePallina];
  indicePallina = (indicePallina + 1) % proiettiliImg.length;

  palline.push({
    x: babbo.x + babbo.w,
    y: babbo.y + babbo.h/2 - 20,
    w: 40,
    h: 40,
    speed: 7,
    rot: 0,
    img: img
  });
});

/* ======================================================
   USA RETE ‚Üí lancia rete.png ridotta al 50%
====================================================== */
document.getElementById("btnRete").addEventListener("click", () => {
  if (document.getElementById("btnRete").disabled) return;

  let scale = 0.5;

  retiLanciate.push({
    x: babbo.x + babbo.w,
    y: babbo.y + 20,
    w: imgRete.width * scale,
    h: imgRete.height * scale,
    speed: 4
  });

  document.getElementById("btnRete").disabled = true;
  document.getElementById("btnRete").classList.remove("enabled");
});

/* ======================================================
   COLLISIONE
====================================================== */
function coll(a,b) {
  return (
    a.x < b.x + b.w &&
    a.x + a.w > b.x &&
    a.y < b.y + b.h &&
    a.y + a.h > b.y
  );
}

/* ======================================================
   GAME LOOP
====================================================== */
function updateGame() {
  if (!running) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  /* Babbo centrato */
  babbo.y = canvas.height/2 - babbo.h/2;
  ctx.drawImage(imgBabbo, babbo.x, babbo.y, babbo.w, babbo.h);

  /* ----------------------------------------------
     Spawn pupazzi e regali
  ---------------------------------------------- */
  spawnSnowmanTimer++;
  if (spawnSnowmanTimer > 80) {
    spawnSnowman();
    spawnSnowmanTimer = 0;
  }

  spawnGiftTimer++;
  if (spawnGiftTimer > 200) {
    spawnGift();
    spawnGiftTimer = 0;
  }

  /* ----------------------------------------------
     Pupazzi
  ---------------------------------------------- */
  pupazzi.forEach((p, pi) => {
    p.x -= p.speed;
    ctx.drawImage(imgSnowman, p.x, p.y, p.w, p.h);

    /* Hitbox ridotta */
    let box = {
      x: p.x + 10,
      y: p.y + 10,
      w: p.w - 20,
      h: p.h - 20
    };

    /* Collisione con Babbo */
    if (coll(babbo, box)) {
      lives--;
      pupazzi.splice(pi,1);
      if (lives <= 0) return gameOver();
    }
  });

  /* ----------------------------------------------
     Regali ‚Üí abilita rete
  ---------------------------------------------- */
  regali.forEach((g, gi) => {
    g.x -= g.speed;
    ctx.drawImage(imgGift, g.x, g.y, g.w, g.h);

    if (coll(babbo, g)) {
      regali.splice(gi,1);
      document.getElementById("btnRete").disabled = false;
      document.getElementById("btnRete").classList.add("enabled");
    }
  });

  /* ----------------------------------------------
     Palline (catapulta + rotazione)
  ---------------------------------------------- */
  palline.forEach((p, pi) => {
    p.x += p.speed;
    p.rot += 0.2;

    ctx.save();
    ctx.translate(p.x + p.w/2, p.y + p.h/2);
    ctx.rotate(p.rot);
    ctx.drawImage(p.img, -p.w/2, -p.h/2, p.w, p.h);
    ctx.restore();

    pupazzi.forEach((snow, si) => {
      let box = {
        x: snow.x + 10,
        y: snow.y + 10,
        w: snow.w - 20,
        h: snow.h - 20
      };

      if (coll({x:p.x,y:p.y,w:p.w,h:p.h}, box)) {
        score += 50;
        pupazzi.splice(si,1);
        palline.splice(pi,1);
      }
    });
  });

  /* ----------------------------------------------
     RETE LANCIA (come un proiettile)
  ---------------------------------------------- */
  retiLanciate.forEach((r, ri) => {
    r.x += r.speed;
    ctx.drawImage(imgRete, r.x, r.y, r.w, r.h);

    pupazzi.forEach((snow, si) => {
      let box = {
        x: snow.x + 10,
        y: snow.y + 10,
        w: snow.w - 20,
        h: snow.h - 20
      };

      if (coll(r, box)) {
        pupazzi.splice(si,1);
        retiLanciate.splice(ri,1);
      }
    });
  });

  /* ----------------------------------------------
     TESTO PUNTEGGIO E VITE
  ---------------------------------------------- */
  ctx.fillStyle = "white";
  ctx.font = "20px Ubuntu";
  ctx.fillText("Punteggio: " + score, 20, 30);
  ctx.fillText("‚ù§Ô∏è " + lives, 20, 60);

  requestAnimationFrame(updateGame);
}
</script>



  <script>
/* ======================================================
   GAME OVER ‚Üí MOSTRA POPUP E SALVA SU FIREBASE
====================================================== */
function gameOver() {
  running = false;

  document.getElementById("fine").style.display = "flex";
  document.getElementById("messaggio").textContent =
    `Hai totalizzato ${score} punti!`;

  /* Salva punteggio su Firebase ‚Üí giorno3 */
  db.ref("punteggi/giorno3").push({
    nome: nomeMascherato,
    punti: score,
    timestamp: Date.now()
  });

  caricaClassifica();
}

/* ======================================================
   CLASSIFICA TOP 10 ‚Üí FIREBASE
====================================================== */
function caricaClassifica() {
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno3")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap => {
      let arr = [];
      snap.forEach(child => arr.push(child.val()));

      arr.sort((a,b) => b.punti - a.punti);

      arr.forEach(record => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${record.nome}</td><td>${record.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* ======================================================
   COUNTDOWN COME GIORNO 2
====================================================== */
function startCountdown(callback) {
  const layer = document.getElementById("countdown");
  const number = document.getElementById("countdown-number");

  let n = 3;
  layer.style.display = "flex";
  number.textContent = n;

  const timer = setInterval(() => {
    n--;
    if (n > 0) {
      number.textContent = n;
    } else {
      number.textContent = "VIA!";
      setTimeout(() => {
        clearInterval(timer);
        layer.style.display = "none";
        callback();
      }, 500);
    }
  }, 1000);
}

/* ======================================================
   AVVIA GIOCO
====================================================== */
function avviaGioco() {
  document.getElementById("start-screen").style.display = "none";
  canvas.style.display = "block";

  running = true;
  updateGame();
}

/* ======================================================
   BOTTONE "INIZIA"
====================================================== */
document.getElementById("btn-start").addEventListener("click", () => {
  startCountdown(avviaGioco);
});

/* ======================================================
   BOTTONE "CLASSIFICA"
====================================================== */
document.getElementById("btn-top10").addEventListener("click", () => {
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  caricaClassifica();
});

/* ======================================================
   RICOMINCIA
====================================================== */
document.getElementById("retry-btn").addEventListener("click", () => {
  location.reload();
});
</script>

</body>
</html>
