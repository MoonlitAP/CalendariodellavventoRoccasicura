<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0">
<title>üéÑ Giorno 3 ‚Äì Snow Jump</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  background-color: #7b0412;
  font-family: 'Ubuntu', sans-serif;
  color: white;
  text-align: center;
  overflow-x: hidden;
}

h1 {
  color: #ffd700;
  margin-top: 10px;
}

/* CANVAS */
canvas {
  display: none;
  margin: 20px auto;
  border: 3px solid #ffd700;
  border-radius: 10px;
  touch-action: none;
}

/* Punteggio */
#punteggio {
  display: none;
  margin-top: 10px;
  padding: 6px 14px;
  background: rgba(0,0,0,0.5);
  border-radius: 12px;
  border: 1px solid #ffd700;
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
  font-size: 1.2em;
}

/* START SCREEN */
#start-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
}

.start-box {
  background: #fffaf2;
  padding: 30px;
  border-radius: 20px;
  width: 90%;
  max-width: 420px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

.start-btn {
  width: 80%;
  margin-top: 12px;
  padding: 14px;
  border-radius: 30px;
  font-size: 1.1em;
  cursor: pointer;
  background: #7b0412;
  color: white;
  border: none;
  font-weight: bold;
}
.start-btn:hover {
  background: #ffd700;
  color: #400000;
}

/* COUNTDOWN */
#countdown {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.countdown-number {
  font-size: 6rem;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 0 20px black;
  animation: zoomFade 1s ease forwards;
}

@keyframes zoomFade {
  0% { opacity: 0; transform: scale(0.4); }
  30% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(2); }
}

/* END SCREEN */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.classifica-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 460px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

.btn {
  display: inline-block;
  margin-top: 15px;
  padding: 12px 30px;
  border-radius: 30px;
  font-weight: bold;
  cursor: pointer;
  color: white;
  background: #7b0412;
  text-decoration: none;
}
.btn:hover {
  background: #ffd700;
  color: #400000;
}

table { width: 100%; margin-top: 15px; }
th, td {
  padding: 8px;
  border-bottom: 1px solid #d7bb5f;
  text-align: center;
}
</style>
</head>

<body>

<h1>üéÑ Giorno 3 ‚Äì Snow Jump</h1>
<div id="punteggio">Punti: 0</div>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-box">
    <p>
      ‚ùÑ Sali pi√π in alto che puoi!<br>
      üå® Piattaforme di neve<br>
      ‚≠ê Stelle bonus (+50)<br>
      üßä Sfondo ghiacciato + Torre stilizzata<br>
      üì± Perfetto su telefono!
    </p>
    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
  </div>
</div>

<!-- COUNTDOWN -->
<div id="countdown">
  <div id="countdown-number" class="countdown-number">3</div>
</div>

<!-- GAME -->
<canvas id="game"></canvas>

<!-- END SCREEN -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="messaggio"></h2>

    <h3>üèÜ Top 10 Globale</h3>
    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>

    <button id="retry-btn" class="btn" style="background:#d41e1e;">üîÑ Riprova</button>
    <a href="../calendario.html" class="btn">‚¨Ö Torna al Calendario</a>
  </div>
</div>

<audio id="musica" loop>
  <source src="../audio/jingle_bells_instrumental.mp3" type="audio/mpeg">
</audio>

<script>
/* ========================= FIREBASE ========================= */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});
const db = firebase.database();

/* ========================= USER MASK ========================= */
const nomeReale = localStorage.getItem("utente") || "Ospite";
const nomeMascherato =
  nomeReale[0] + Math.floor(Math.random()*900+100) + nomeReale.slice(1);

/* ========================= CANVAS ========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const w = Math.min(window.innerWidth - 20, 450);
  const h = Math.floor(w * 1.5);
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ========================= IMMAGINI ========================= */
const playerImg = new Image(); 
playerImg.src = "../img/fork.png";

const starImg = new Image();
starImg.src = "../img/star.png";

/* ========================= GIOCO ========================= */
let player = { x: 150, y: 200, w: 60, h: 60, vy: 0 };
let platforms = [];
let stars = [];
let fiocchi = [];
let score = 0;
let gameOverFlag = false;

/* ========================= CONTROLLI ========================= */
let moveLeft = false, moveRight = false;

canvas.addEventListener("touchstart", e=>{
  const x = e.touches[0].clientX;
  moveLeft = x < window.innerWidth/2;
  moveRight = x > window.innerWidth/2;
});
canvas.addEventListener("touchend", ()=>{ moveLeft=false; moveRight=false; });

window.addEventListener("keydown", e=>{
  if (e.code==="ArrowLeft") moveLeft = true;
  if (e.code==="ArrowRight") moveRight = true;
});
window.addEventListener("keyup", e=>{
  if (e.code==="ArrowLeft") moveLeft = false;
  if (e.code==="ArrowRight") moveRight = false;
});

/* ========================= SFONDO GHIACCIO + TORRE ========================= */
function drawBackground() {
  let grad = ctx.createLinearGradient(0,0,0,canvas.height);
  grad.addColorStop(0,"#83bff9");
  grad.addColorStop(1,"#4c90d6");
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle = "rgba(255,255,255,0.05)";
  for (let i=0;i<canvas.width;i+=25){
    ctx.beginPath();
    ctx.moveTo(i,0);
    ctx.lineTo(i,canvas.height);
    ctx.stroke();
  }

  ctx.lineWidth = 2;
  ctx.strokeStyle="#1e3e5c";
  ctx.fillStyle="rgba(255,255,255,0.8)";
  ctx.beginPath();
  ctx.rect(canvas.width/2-40, canvas.height-130, 80, 120);
  ctx.fill(); ctx.stroke();

  ctx.beginPath();
  ctx.arc(canvas.width/2, canvas.height-80, 20, 0, Math.PI*2);
  ctx.fill(); ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(canvas.width/2-10, canvas.height-160);
  ctx.lineTo(canvas.width/2+10, canvas.height-160);
  ctx.lineTo(canvas.width/2, canvas.height-180);
  ctx.closePath();
  ctx.fill(); ctx.stroke();
}

/* ========================= PIATTAFORME ========================= */
function creaPiattaforma(x,y) {
  return { x, y, w: 70, h: 20 };
}

function drawPlatform(p) {
  ctx.fillStyle="white";
  ctx.fillRect(p.x,p.y,p.w,p.h);
  ctx.fillStyle="#d4eaff";
  ctx.fillRect(p.x,p.y,p.w,p.h/2);
}

/* ========================= STELLE ========================= */
function creaStella(x,y){
  return { x,y,w:40,h:40 };
}

/* ========================= NEVE ========================= */
function generaFiocco() {
  fiocchi.push({
    x: Math.random()*canvas.width,
    y: -10,
    r: Math.random()*2+1,
    v: Math.random()*1+0.5
  });
}
setInterval(generaFiocco,120);

/* ========================= CLASSIFICA ========================= */
function salvaPunteggio() {
  db.ref("punteggi/giorno3").push({
    nome: nomeMascherato,
    punti: score,
    timestamp: Date.now()
  });
}

function caricaClassifica() {
  const table = document.getElementById("score-table");
  table.innerHTML="<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno3")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap=>{
      let arr=[];
      snap.forEach(ch=>arr.push(ch.val()));
      arr.sort((a,b)=>b.punti-a.punti);
      arr.forEach(r=>{
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* ========================= GAME OVER ========================= */
function gameOver() {
  if (gameOverFlag) return;
  gameOverFlag = true;

  salvaPunteggio();

  document.getElementById("fine").style.display="flex";
  document.getElementById("messaggio").textContent=
      `Hai totalizzato ${score} punti!`;

  caricaClassifica();
}

/* ========================= GAME LOOP ========================= */
function gameLoop() {
  if (gameOverFlag) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawBackground();

  if (moveLeft)  player.x -= 4;
  if (moveRight) player.x += 4;

  if (player.x<0) player.x=0;
  if (player.x+player.w>canvas.width) player.x=canvas.width-player.w;

  player.vy += 0.4;
  player.y += player.vy;

  if (player.y < canvas.height/2) {
    let diff = (canvas.height/2)-player.y;
    player.y += diff;
    score += Math.floor(diff);

    for (let i=platforms.length-1;i>=0;i--)
      platforms[i].y += diff;

    for (let i=stars.length-1;i>=0;i--)
      stars[i].y += diff;
  }

  for (let i=platforms.length-1;i>=0;i--) {
    const p=platforms[i];
    drawPlatform(p);

    if (
      player.vy>0 &&
      player.x+player.w>p.x &&
      player.x<p.x+p.w &&
      player.y+player.h>p.y &&
      player.y+player.h<p.y+p.h
    ) {
      player.vy=-10;
    }

    if (p.y>canvas.height) {
      platforms.splice(i,1);
      platforms.push(creaPiattaforma(Math.random()*(canvas.width-70), -30));
      if (Math.random()<0.2)
         stars.push(creaStella(Math.random()*(canvas.width-40), -100));
    }
  }

  for (let i=stars.length-1;i>=0;i--) {
    let s=stars[i];
    ctx.drawImage(starImg,s.x,s.y,s.w,s.h);

    if (
      player.x< s.x+s.w &&
      player.x+player.w> s.x &&
      player.y < s.y+s.h &&
      player.y+player.h> s.y
    ) {
      score+=50;
      stars.splice(i,1);
    }
    if (s.y>canvas.height) stars.splice(i,1);
  }

  for (let i=fiocchi.length-1;i>=0;i--) {
    let f=fiocchi[i];
    f.y+=f.v;
    ctx.fillStyle="white";
    ctx.beginPath();
    ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
    ctx.fill();
    if (f.y>canvas.height) fiocchi.splice(i,1);
  }

  ctx.drawImage(playerImg,player.x,player.y,player.w,player.h);

  document.getElementById("punteggio").textContent=`Punti: ${score}`;

  if (player.y>canvas.height) gameOver();

  requestAnimationFrame(gameLoop);
}

/* ========================= COUNTDOWN ========================= */
function startCountdown(cb) {
  const c=document.getElementById("countdown");
  const n=document.getElementById("countdown-number");
  let num=3;
  c.style.display="flex";
  n.textContent=num;

  let timer=setInterval(()=>{
    num--;
    if (num>0){ n.textContent=num; }
    else {
      n.textContent="VIA!";
      setTimeout(()=>{
        clearInterval(timer);
        c.style.display="none";
        cb();
      },500);
    }
  },1000);
}

/* ========================= START GAME ========================= */
function iniziaGioco() {
  canvas.style.display="block";
  document.getElementById("punteggio").style.display="block";

  for (let i=0;i<8;i++) {
    let y=canvas.height - i*100;
    platforms.push(creaPiattaforma(Math.random()*(canvas.width-70), y));
  }

  gameLoop();
}

document.getElementById("btn-start").addEventListener("click", ()=>{
  document.getElementById("start-screen").style.display="none";

  const musica=document.getElementById("musica");
  musica.currentTime=0;
  musica.play().catch(()=>{});

  startCountdown(iniziaGioco);
});

document.getElementById("btn-top10").addEventListener("click", ()=>{
  document.getElementById("start-screen").style.display="none";
  document.getElementById("fine").style.display="flex";
  caricaClassifica();
});

document.getElementById("retry-btn").addEventListener("click", ()=>{
  location.reload();
});
</script>

</body>
</html>

