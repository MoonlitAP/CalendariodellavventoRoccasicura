<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
<title>üéÑ Giorno 3 ‚Äì Snowman Escape</title>

<!-- FONT -->
<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
/* GENERALE */
body {
  margin: 0;
  background-color: #7b0412;
  font-family: 'Ubuntu', sans-serif;
  color: white;
  text-align: center;
  overflow-x: hidden;
}

h1 {
  color: #ffd700;
  margin-top: 10px;
  font-size: 2rem;
}

/* HUD (vite + punteggio) SOPRA AL CANVAS */
#hud {
  margin-top: 10px;
  font-size: 1.4rem;
  font-weight: bold;
}

/* CANVAS 5:3 */
.canvas-wrapper {
  width: 100%;
  max-width: 520px;
  margin: 10px auto;
}

#gameCanvas {
  width: 100%;
  aspect-ratio: 5 / 3;
  background: #bde0fe;
  border: 2px solid #ffd700;
  border-radius: 12px;
  display: none;
}

/* BOTTONI AFFIANCATI */
.controls {
  margin-top: 12px;
  display: flex;
  justify-content: center;
  gap: 12px;
  width: 100%;
  max-width: 520px;
  margin-left: auto;
  margin-right: auto;
}

.btn {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  border: 3px solid #fff3b0;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
}

#btnRete {
  background: white;
  color: #7b0412;
  opacity: 0.4;
  border: 3px solid #ffd700;
}

#btnRete.enabled {
  opacity: 1;
  box-shadow: 0 0 10px rgba(255,215,0,0.8);
}

#btnSpara {
  background: #ffd700;
  color: #7b0412;
  box-shadow: 0 0 10px rgba(255,215,0,0.6);
}

/* START SCREEN */
#start-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(5px);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9998;
}

.start-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 450px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
  font-size: 1.15rem;
}

.start-btn {
  width: 85%;
  margin-top: 10px;
  padding: 14px;
  border-radius: 30px;
  font-size: 1.2rem;
  cursor: pointer;
  background: #7b0412;
  color: white;
  font-weight: bold;
  border: none;
}

.start-btn:hover {
  background: #ffd700;
  color: #400000;
}

/* COUNTDOWN */
#countdown {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.countdown-number {
  font-size: 6rem;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 0 20px black;
}

/* END SCREEN */
#fine {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  display: none;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(4px);
  z-index: 9999;
}

.classifica-box {
  background: #fffaf2;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 460px;
  border: 2px solid #ffd700;
  color: #400000;
  text-align: center;
}

table {
  width: 100%;
  margin-top: 15px;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #d7bb5f;
  text-align: center;
}

</style>
</head>

<body>

<h1>üéÑ Giorno 3 ‚Äì Snowman Escape</h1>

<!-- HUD -->
<div id="hud">‚ù§Ô∏è 3 | ‚≠ê 0</div>

<!-- CANVAS 5:3 -->
<div class="canvas-wrapper">
  <canvas id="gameCanvas"></canvas>
</div>

<!-- BOTTONI AFFIANCATI -->
<div class="controls">
  <button id="btnRete" class="btn">üï∏ PRENDI IL REGALO</button>
  <button id="btnSpara" class="btn">üéØ SPARA!</button>
</div>

<!-- START SCREEN -->
<div id="start-screen">
  <div class="start-box">

    <p><b>Insieme a Babbo, cattura i regali e distruggi i pupazzi di neve che ti ostacolano il cammino!</b></p>

    <h3>‚≠ê Sistema Punteggio</h3>

    <p style="text-align:left;">
    üéÅ <b>Pacco catturato</b> ‚Üí <b>+50 punti</b><br>
    ‚òÉÔ∏è <b>Snowman sparato</b> ‚Üí <b>+15 punti</b><br>
    üí• <b>Pacco colpito da sparo</b> ‚Üí <b>-5 punti</b><br>
    üï∏ <b>Snowman catturato con la rete</b> ‚Üí <b>-1 vita</b><br>
    ‚òÉÔ∏è‚û°Ô∏èüéÖ <b>Snowman tocca Babbo</b> ‚Üí <b>-1 vita</b>
    </p>

    <button id="btn-start" class="start-btn">‚ñ∂Ô∏è INIZIA</button>
    <button id="btn-top10" class="start-btn" style="background:#b8860b;">üèÜ CLASSIFICA</button>
  </div>
</div>




   <script>
/* ===============================================
   FIREBASE INIT
================================================= */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  authDomain: "calendarioroccasicura.firebaseapp.com",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calendarioroccasicura"
});

const db = firebase.database();

/* Nome mascherato come Giorno 2 */
const nomeReale = localStorage.getItem("utente") || "Ospite";
const nomeMascherato =
  nomeReale[0] + Math.floor(Math.random()*900+100) + nomeReale.slice(1);

/* ===============================================
   CANVAS
================================================= */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

/* Rende canvas responsive (5:3) */
function resizeCanvas() {
  const w = Math.min(window.innerWidth - 20, 520);
  const h = Math.floor(w * 0.6); // proporzione 5:3
  canvas.width = w;
  canvas.height = h;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

/* ===============================================
   IMMAGINI
================================================= */
const imgBabbo = new Image();
imgBabbo.src = "./img/babbo_3.png";

const imgSnowman = new Image();
imgSnowman.src = "./img/snowman.png";

const imgGift = new Image();
imgGift.src = "./img/gift.png";

const imgRete = new Image();
imgRete.src = "./img/rete.png";

/* Palline (proiettili) ciclati */
const palline = [
  "./img/b1.png",
  "./img/b2.png",
  "./img/b3.png"
];
let pallineImgs = [];
palline.forEach(src => {
  const i = new Image();
  i.src = src;
  pallineImgs.push(i);
});
let pallinaIndex = 0;

/* ===============================================
   OGGETTI DI GIOCO
================================================= */
let running = false;

let score = 0;
let lives = 3;

/* HUD update */
function updateHUD() {
  document.getElementById("hud").textContent =
    `‚ù§Ô∏è ${lives} | ‚≠ê ${score}`;
}

/* Babbo */
let babbo = {
  x: 40,
  y: canvas.height / 2 - 40,
  w: 80,
  h: 80
};

/* Oggetti */
let oggetti = [];      // contiene {type: "snowman"/"gift", x, y, w, h, speed}
let proiettili = [];   // palline
let rete = null;       // singola rete attiva

/* ===============================================
   GENERA OGGETTI (regali + snowman)
================================================= */
function generaOggetto() {
  const tipo = Math.random() < 0.5 ? "snowman" : "gift";

  oggetti.push({
    type: tipo,
    x: canvas.width + 40,
    y: babbo.y + 10, // LINEA UNICA
    w: tipo === "snowman" ? 65 : 50,
    h: tipo === "snowman" ? 65 : 50,
    speed: 2
  });
}
setInterval(() => { if (running) generaOggetto(); }, 900);

/* ===============================================
   SPARO (palline)
================================================= */
document.getElementById("btnSpara").addEventListener("click", () => {
  if (!running) return;

  const img = pallineImgs[pallinaIndex];
  pallinaIndex = (pallinaIndex + 1) % pallineImgs.length;

  proiettili.push({
    x: babbo.x + babbo.w,
    y: babbo.y + 20,
    w: 35,
    h: 35,
    speed: 6,
    img: img,
    angle: 0
  });
});

/* ===============================================
   ATTIVA RETE
================================================= */
document.getElementById("btnRete").addEventListener("click", () => {
  if (!running || rete !== null) return;

  rete = {
    x: babbo.x + babbo.w,
    y: babbo.y,
    w: 70,
    h: 70,
    speed: 4
  };

  /* Disattivo il pulsante */
  const btn = document.getElementById("btnRete");
  btn.classList.remove("enabled");
  btn.disabled = true;
});

/* ===============================================
   COLLISIONI RECT
================================================= */
function rectHit(a, b) {
  return (
    a.x < b.x + b.w &&
    a.x + a.w > b.x &&
    a.y < b.y + b.h &&
    a.y + a.h > b.y
  );
}

/* ===============================================
   UPDATE DEL GIOCO
================================================= */
function updateGame() {
  if (!running) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  /* Babbo */
  ctx.drawImage(imgBabbo, babbo.x, babbo.y, babbo.w, babbo.h);

  /* ----------------------------------------------
     OGGETTI IN ARRIVO
     (snowman + gift)
  ----------------------------------------------- */
  oggetti.forEach((o, i) => {
    o.x -= o.speed;

    if (o.type === "snowman")
      ctx.drawImage(imgSnowman, o.x, o.y, o.w, o.h);
    else
      ctx.drawImage(imgGift, o.x, o.y, o.w, o.h);

    /* Snowman tocca Babbo ‚Üí -1 vita */
    if (o.type === "snowman" && rectHit(o, babbo)) {
      oggetti.splice(i, 1);
      lives--;
      updateHUD();
      if (lives <= 0) return gameOver();
    }

    /* Babbo cattura regalo ‚Üí +50 */
    if (o.type === "gift" && rectHit(o, babbo)) {
      oggetti.splice(i, 1);
      score += 50;
      updateHUD();

      /* abilito rete */
      const btn = document.getElementById("btnRete");
      btn.disabled = false;
      btn.classList.add("enabled");
    }

    /* elimina fuori schermo */
    if (o.x + o.w < 0) oggetti.splice(i, 1);
  });

  /* ----------------------------------------------
     PROIETTILI (PALLINE)
  ----------------------------------------------- */
  proiettili.forEach((p, pi) => {
    p.x += p.speed;
    p.angle += 0.2;

    ctx.save();
    ctx.translate(p.x + p.w/2, p.y + p.h/2);
    ctx.rotate(p.angle);
    ctx.drawImage(p.img, -p.w/2, -p.h/2, p.w, p.h);
    ctx.restore();

    /* Collisioni */
    oggetti.forEach((o, oi) => {
      if (rectHit(p, o)) {

        if (o.type === "snowman") {
          /* Snowman sparato ‚Üí +15 */
          score += 15;
        } else {
          /* Pacco sparato ‚Üí -5 */
          score -= 5;
          if (score < 0) score = 0;
        }

        updateHUD();

        oggetti.splice(oi, 1);
        proiettili.splice(pi, 1);
      }
    });

    if (p.x > canvas.width + 50)
      proiettili.splice(pi, 1);
  });

  /* ----------------------------------------------
     RETE (SINGOLO PROIETTILE)
  ----------------------------------------------- */
  if (rete) {
    rete.x += rete.speed;
    ctx.drawImage(imgRete, rete.x, rete.y, rete.w, rete.h);

    oggetti.forEach((o, oi) => {
      if (rectHit(rete, o)) {

        if (o.type === "gift") {
          /* rete prende regalo ‚Üí +50 */
          score += 50;
        } else {
          /* rete cattura snowman ‚Üí -1 vita */
          lives--;
          if (lives < 0) lives = 0;
          if (lives <= 0) return gameOver();
        }

        updateHUD();

        oggetti.splice(oi, 1);
        rete = null;
      }
    });

    /* rete esce dallo schermo */
    if (rete && rete.x > canvas.width + 40)
      rete = null;
  }

  requestAnimationFrame(updateGame);
}










<script>
/* ============================================================
   COUNTDOWN (VERSIONE FIXATA ‚Äî ANIMAZIONE CORRETTA)
============================================================ */
function startCountdown(callback) {
  const layer = document.getElementById("countdown");
  const number = document.getElementById("countdown-number");

  let n = 3;
  layer.style.display = "flex";

  // FORZO IL RESTART ANIMAZIONE
  number.classList.remove("countdown-number");
  void number.offsetWidth;
  number.classList.add("countdown-number");

  number.textContent = n;

  const timer = setInterval(() => {
    n--;

    // riavvio animazione OGNI SECONDO
    number.classList.remove("countdown-number");
    void number.offsetWidth;
    number.classList.add("countdown-number");

    if (n > 0) {
      number.textContent = n;
    } else {
      number.textContent = "VIA!";
      setTimeout(() => {
        clearInterval(timer);
        layer.style.display = "none";
        callback();
      }, 600);
    }
  }, 1000);
}

/* ============================================================
   AVVIO GIOCO
============================================================ */
function avviaGioco() {
  document.getElementById("start-screen").style.display = "none";
  canvas.style.display = "block";
  running = true;
  updateGame();
}

document.getElementById("btn-start").addEventListener("click", () => {
  startCountdown(avviaGioco);
});

/* ============================================================
   CLASSIFICA TOP 10 ‚Äî FIREBASE
============================================================ */
function caricaClassifica() {
  const table = document.getElementById("score-table");
  table.innerHTML = "<tr><th>Nome</th><th>Punti</th></tr>";

  db.ref("punteggi/giorno3")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value", snap => {
      const arr = [];
      snap.forEach(c => arr.push(c.val()));

      arr.sort((a,b) => b.punti - a.punti);

      arr.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.nome}</td><td>${r.punti}</td>`;
        table.appendChild(tr);
      });
    });
}

/* ============================================================
   GAME OVER
============================================================ */
function gameOver() {
  running = false;

  document.getElementById("fine").style.display = "flex";
  document.getElementById("messaggio").textContent =
    `Hai totalizzato ${score} punti!`;

  // SALVA SU FIREBASE
  db.ref("punteggi/giorno3").push({
    nome: nomeMascherato,
    punti: score,
    timestamp: Date.now()
  });

  caricaClassifica();
}

/* ============================================================
   PULSANTE CLASSIFICA (start screen)
============================================================ */
document.getElementById("btn-top10").addEventListener("click", () => {
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("fine").style.display = "flex";
  caricaClassifica();
});

/* ============================================================
   RIPROVA
============================================================ */
document.getElementById("retry-btn").addEventListener("click", () => {
  location.reload();
});
</script>

</body>
</html>
