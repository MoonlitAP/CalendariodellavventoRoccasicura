<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">

<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>üéÖ Giorno 11 ‚Äì Babbo Mario Run</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  touch-action:manipulation;
  -webkit-user-select:none;
  user-select:none;
  overscroll-behavior:none;
  font-family:'Ubuntu',sans-serif;
  background:#7b0412;
  color:white;
  text-align:center;
}

h1{color:#ffd700;}

button{
  padding:14px 30px;
  border-radius:30px;
  border:none;
  font-size:18px;
  background:#7b0412;
  color:white;
  cursor:pointer;
}
button:hover{background:#ffd700;color:#000;}

#panel{
  margin:20px;
  background:#fffaf0;
  color:#400;
  border-radius:20px;
  border:2px solid #ffd700;
  padding:20px;
}

canvas{
  display:none;
  width:100%;
  max-width:900px;
  height:300px;
  background:url("img/bosco.jpg") repeat-x;
  background-size:cover;
  border:3px solid #ffd700;
  border-radius:16px;
  margin:auto;
}

#info{
  display:none;
  position:fixed;
  bottom:0;
  width:100%;
  background:rgba(0,0,0,.7);
  padding:8px;
  font-size:18px;
}

#fine{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

.box{
  background:#fffaf0;
  color:#400;
  border-radius:20px;
  padding:25px;
  width:90%;
  max-width:500px;
  border:2px solid #ffd700;
}

table{
  width:100%;
  margin-top:10px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #d7bb5f;
}
</style>
</head>

<body>

<h1>üéÖ Babbo Mario Run</h1>

<div id="panel">
  <p>
    üëÜ Tocca per saltare<br>
    ‚≠ê Stella +10<br>
    üéÅ Regalo +50<br>
    üö© Arriva alla bandiera!
  </p>
  <button id="start">‚ñ∂Ô∏è INIZIA</button><br><br>
  <button id="openScore">üèÜ CLASSIFICA</button>
</div>

<canvas id="game"></canvas>
<div id="info"></div>

<div id="fine">
  <div class="box">
    <h2>üéâ Sei arrivato al paese!</h2>
    <h3 id="finalScore"></h3>

    <h3>üèÜ Classifica Giorno 11</h3>
    <table id="tabella"></table>

    <br>
    <button onclick="location.reload()">üîÑ Riprova</button>
    <a href="../calendario.html">
      <button>‚¨Ö Calendario</button>
    </a>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app"
});
const db = firebase.database();

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth < 900 ? window.innerWidth : 900;
canvas.height = 300;

const mario = new Image(); mario.src="img/babbo_mario.png";
const block = new Image(); block.src="img/blocco.png";
const star  = new Image(); star.src="img/stella.png";
const gift  = new Image(); gift.src="img/gift.png";
const flag  = new Image(); flag.src="img/bandiera.png";

let y=200, vy=0, onGround=true;
let stars=[], gifts=[], blocks=[];
let score=0, playing=false;
let distance=0, finished=false;

const SPEED = window.innerWidth < 700 ? 3 : 4;
const FINISH_DISTANCE = 4000;

function jump(){
  if(onGround){
    vy=-12;
    onGround=false;
  }
}

canvas.onclick = jump;
window.onkeydown = e=>{
  if(e.code==="Space" || e.code==="ArrowUp") jump();
};
window.oncontextmenu = e=>{
  e.preventDefault();
  jump();
};

function spawn(){
  if(distance < FINISH_DISTANCE-400){
    if(Math.random()<0.3) stars.push({x:canvas.width,y:150});
    if(Math.random()<0.15) gifts.push({x:canvas.width,y:130});
    if(Math.random()<0.4) blocks.push({x:canvas.width,y:230});
  }
}

function update(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  vy+=0.6;
  y+=vy;
  if(y>200){y=200;vy=0;onGround=true;}

  ctx.drawImage(mario,70,y,70,70);

  stars.forEach(s=>{
    s.x-=SPEED;
    ctx.drawImage(star,s.x,s.y,40,40);
    if(s.x<130 && s.x+30>70 && y+40>s.y){
      score+=10;
      s.hit=true;
    }
  });

  gifts.forEach(g=>{
    g.x-=SPEED;
    ctx.drawImage(gift,g.x,g.y,40,40);
    if(g.x<130 && g.x+30>70 && y+40>g.y){
      score+=50;
      g.hit=true;
    }
  });

  blocks.forEach(b=>{
    b.x-=SPEED;
    ctx.drawImage(block,b.x,b.y,60,60);
  });

  stars=stars.filter(s=>!s.hit && s.x>-50);
  gifts=gifts.filter(g=>!g.hit && g.x>-50);
  blocks=blocks.filter(b=>b.x>-80);

  distance+=SPEED;
  document.getElementById("info").textContent=`‚≠ê ${score}`;

  if(distance > FINISH_DISTANCE && !finished){
    finished=true;
  }

  if(finished){
    ctx.drawImage(flag, canvas.width-120,180,60,80);
    if(canvas.width-120 < 140){
      endGame();
      return;
    }
  }

  playing && requestAnimationFrame(update);
}

function endGame(){
  playing=false;
  canvas.style.display="none";
  document.getElementById("info").style.display="none";
  document.getElementById("fine").style.display="flex";
  document.getElementById("finalScore").innerHTML=`‚≠ê Punti: <b>${score}</b>`;

  const nome = (localStorage.getItem("utente")||"Ospite")[0]+Math.floor(Math.random()*900+100);

  db.ref("punteggi/giorno11").push({
    nome:nome,
    punti:Number(score),
    t:Date.now()
  }).then(loadTop10);
}

function loadTop10(){
  const t=document.getElementById("tabella");
  t.innerHTML="<tr><th>Nome</th><th>Punti</th></tr>";
  db.ref("punteggi/giorno11").once("value",snap=>{
    let a=[];
    snap.forEach(c=>a.push(c.val()));
    a.sort((x,y)=>y.punti-x.punti);
    a.slice(0,10).forEach(r=>{
      t.innerHTML+=`<tr><td>${r.nome}</td><td>${r.punti}</td></tr>`;
    });
  });
}

document.getElementById("start").onclick=()=>{
  document.getElementById("panel").style.display="none";
  canvas.style.display="block";
  document.getElementById("info").style.display="block";
  playing=true;
  setInterval(()=>playing&&spawn(),1400);
  update();
};

document.getElementById("openScore").onclick=()=>{
  document.getElementById("panel").style.display="none";
  document.getElementById("fine").style.display="flex";
  loadTop10();
};
</script>

</body>
</html>

