<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>üê≠ Giorno 10 ‚Äì Caccia al Topo</title>

<link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  font-family:'Ubuntu',sans-serif;
  background:#7b0412;
  color:#ffd9a0;
  text-align:center;
  touch-action:manipulation;
  user-select:none;
}

h1{color:#ffd700;}

#panel{
  width:90%;
  max-width:420px;
  margin:20px auto;
  background:#fffaf2;
  color:#3a0000;
  border:2px solid #ffd700;
  border-radius:20px;
  padding:20px;
}

.btn{
  width:80%;
  padding:14px;
  margin-top:10px;
  border-radius:30px;
  border:none;
  font-size:1.1em;
  font-weight:bold;
  background:#7b0412;
  color:white;
}

#info{
  display:none;
  width:100%;
  padding:10px 0;
  background:rgba(0,0,0,0.4);
  position:fixed;
  bottom:0;
}

#field{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  max-width:320px;
  margin:20px auto;
}

.hole{
  background:#3b0a10;
  border-radius:50%;
  height:90px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:42px;
}

#fine{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.65);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}

.classifica-box{
  background:#fffaf2;
  padding:25px;
  border-radius:20px;
  width:90%;
  max-width:450px;
  border:2px solid #ffd700;
  color:#3a0000;
}

table{width:100%; margin-top:10px;}
th,td{padding:8px; border-bottom:1px solid #d7bb5f;}
</style>
</head>

<body>

<h1>üê≠ Caccia al Topo!</h1>

<!-- PRE-INIZIO -->
<div id="panel">
  <h2>üéÑ Come si gioca</h2>
  <p>
    üê≠ Tocca il topo ‚Üí +1<br>
    ‚≠ê Trova la stella ‚Üí +5<br><br>
    ‚è≥ Tempo: 20 secondi
  </p>
  <button class="btn" onclick="startGame()">‚ñ∂Ô∏è INIZIA</button>
  <button class="btn" style="background:#b8860b" onclick="openTop10()">üèÜ CLASSIFICA</button>
</div>

<div id="field"></div>

<div id="info">
  ‚≠ê <span id="score">0</span> |
  ‚è≥ <span id="time">20</span>s
</div>

<!-- FINE -->
<div id="fine">
  <div class="classifica-box">
    <h2 id="fine-msg"></h2>
    <h3>üèÜ Top 10 ‚Äì Giorno 10</h3>
    <table id="score-table">
      <tr><th>Nome</th><th>Punti</th></tr>
    </table>
    <button class="btn" onclick="location.reload()">üîÑ Riprova</button>
  </div>
</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBrI1yThI6zmnYwKE4OHbS8vhrUPrMsnsk",
  databaseURL: "https://calendarioroccasicura-default-rtdb.europe-west1.firebasedatabase.app"
});
const db = firebase.database();

const real = localStorage.getItem("utente") || "Ospite";
const user = real[0] + Math.floor(Math.random()*900+100) + real.slice(1);

/* ELEMENTI */
const scoreEl = document.getElementById("score");
const timeEl  = document.getElementById("time");
const fineMsg = document.getElementById("fine-msg");
const table   = document.getElementById("score-table");
const field   = document.getElementById("field");
const info    = document.getElementById("info");
const panel   = document.getElementById("panel");

/* VARIABILI */
let score=0, time=20, active=-1, timer, spawner;

/* CREA BUCHE */
for(let i=0;i<6;i++){
  const d=document.createElement("div");
  d.className="hole";
  d.onclick=()=>hit(i);
  field.appendChild(d);
}

function startGame(){
  panel.style.display="none";
  info.style.display="block";
  score=0; time=20;
  scoreEl.textContent=0;
  timeEl.textContent=20;

  timer=setInterval(()=>{
    time--;
    timeEl.textContent=time;
    if(time<=0) endGame();
  },1000);

  spawner=setInterval(showItem,800);
}

function showItem(){
  clearField();
  active=Math.floor(Math.random()*6);
  field.children[active].textContent = Math.random()<0.6 ? "üê≠" : "‚≠ê";
}

function hit(i){
  if(i!==active) return;
  score += field.children[i].textContent==="‚≠ê" ? 5 : 1;
  scoreEl.textContent=score;
  clearField();
}

function clearField(){
  [...field.children].forEach(h=>h.textContent="");
}

function endGame(){
  clearInterval(timer);
  clearInterval(spawner);
  info.style.display="none";
  fine.style.display="flex";
  fineMsg.innerHTML=`üéÑ Hai fatto <b>${score}</b> punti!`;

  db.ref("punteggi/giorno10").push({
    nome:user,
    punti:score,
    timestamp:Date.now()
  }).then(loadTop10);
}

function loadTop10(){
  table.innerHTML="<tr><th>Nome</th><th>Punti</th></tr>";
  db.ref("punteggi/giorno10")
    .orderByChild("punti")
    .limitToLast(10)
    .once("value",snap=>{
      let list=[];
      snap.forEach(c=>list.push(c.val()));
      list.sort((a,b)=>b.punti-a.punti);
      list.forEach(r=>{
        table.innerHTML+=`<tr><td>${r.nome}</td><td>${r.punti}</td></tr>`;
      });
    });
}

function openTop10(){
  panel.style.display="none";
  fine.style.display="flex";
  fineMsg.textContent="üèÜ Classifica Giorno 10";
  loadTop10();
}
</script>

</body>
</html>
